<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO/IEC 42001 Suite - Auditoría Completa</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Marked for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- PDF.js for PDF processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Mammoth.js for DOCX processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <!-- Chart.js for audit visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .animate-slideUp {
            animation: slideUp 0.3s ease-out forwards;
        }

        .animate-slideInRight {
            animation: slideInRight 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        .prose p {
            margin-bottom: 0.8em;
        }

        .loader {
            border-top-color: #6366f1;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Executive PDF layout */
        .pdf-executive {
            width: 794px;
            background: #f8fafc;
            color: #0f172a;
            font-family: 'Inter', sans-serif;
        }

        .pdf-page {
            width: 794px;
            min-height: 1123px;
            padding: 48px 56px;
            box-sizing: border-box;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
            margin-bottom: 28px;
            position: relative;
        }

        .pdf-kicker {
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-size: 11px;
            color: #475569;
            font-weight: 600;
        }

        .pdf-title {
            font-size: 32px;
            font-weight: 700;
            color: #0f172a;
            margin-top: 8px;
        }

        .pdf-subtitle {
            font-size: 16px;
            color: #475569;
            margin-top: 8px;
        }

        .pdf-meta {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 14px;
            margin-top: 28px;
        }

        .pdf-meta-card {
            background: #f1f5f9;
            border-radius: 14px;
            padding: 16px 18px;
            font-size: 13px;
            color: #334155;
        }

        .pdf-meta-card span {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #64748b;
            margin-bottom: 6px;
        }

        .pdf-section-title {
            font-size: 18px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 12px;
        }

        .pdf-section-subtitle {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: #64748b;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .pdf-paragraph {
            font-size: 13px;
            line-height: 1.7;
            color: #334155;
            margin-bottom: 10px;
        }

        .pdf-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 16px;
        }

        .pdf-stat {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px;
        }

        .pdf-stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .pdf-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #0f172a;
        }

        .pdf-bullets {
            margin: 0;
            padding-left: 18px;
            color: #334155;
            font-size: 13px;
            line-height: 1.7;
        }

        .pdf-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 20px 0;
        }

        .pdf-footer {
            position: absolute;
            bottom: 28px;
            left: 56px;
            right: 56px;
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #94a3b8;
            border-top: 1px solid #e2e8f0;
            padding-top: 10px;
        }

        .pdf-banner {
            background: linear-gradient(135deg, #0f172a, #0f766e);
            border-radius: 22px;
            padding: 28px 32px;
            color: #ffffff;
            margin-bottom: 24px;
        }

        .pdf-banner h1 {
            font-size: 30px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .pdf-banner p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.75);
        }

        .pdf-columns {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 24px;
        }

        .pdf-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 18px;
        }

        .pdf-chart {
            width: 100%;
            border-radius: 14px;
            border: 1px solid #e2e8f0;
        }

        /* Estilos para tablas del PDF */
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin: 16px 0;
        }

        .pdf-table thead {
            background: linear-gradient(135deg, #1e3a5f, #0f766e);
        }

        .pdf-table th {
            color: #ffffff;
            font-weight: 600;
            text-align: left;
            padding: 12px 10px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .pdf-table td {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            color: #334155;
            vertical-align: top;
            line-height: 1.5;
        }

        .pdf-table tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        .pdf-table tbody tr:hover {
            background: #f1f5f9;
        }

        .pdf-severity {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .pdf-severity-critico {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .pdf-severity-alto {
            background: #fff7ed;
            color: #ea580c;
            border: 1px solid #fed7aa;
        }

        .pdf-severity-medio {
            background: #fefce8;
            color: #ca8a04;
            border: 1px solid #fef08a;
        }

        .pdf-severity-bajo {
            background: #eff6ff;
            color: #2563eb;
            border: 1px solid #bfdbfe;
        }

        .pdf-severity-observacion {
            background: #f8fafc;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .pdf-finding-id {
            font-weight: 700;
            color: #0f172a;
            font-size: 12px;
        }

        .pdf-finding-title {
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .pdf-finding-desc {
            color: #64748b;
            font-size: 10px;
        }

        .pdf-compliance-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
        }

        .pdf-compliance-label {
            font-weight: 600;
            color: #0f172a;
            font-size: 12px;
        }

        .pdf-compliance-bar {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin: 0 16px;
            overflow: hidden;
        }

        .pdf-compliance-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .pdf-compliance-value {
            font-weight: 700;
            font-size: 14px;
            min-width: 45px;
            text-align: right;
        }

        .pdf-numbered-list {
            counter-reset: item;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .pdf-numbered-list li {
            counter-increment: item;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .pdf-numbered-list li::before {
            content: counter(item);
            min-width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #0f766e, #14b8a6);
            color: white;
            font-weight: 700;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .pdf-list-content {
            flex: 1;
        }

        .pdf-list-title {
            font-weight: 600;
            color: #0f172a;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .pdf-list-desc {
            color: #64748b;
            font-size: 11px;
            line-height: 1.5;
        }

        .pdf-page-break {
            page-break-after: always;
        }

        /* Estilos para el informe completo renderizado */
        .pdf-report-full {
            min-height: auto;
            height: auto;
        }

        .pdf-report-content {
            font-size: 12px;
            line-height: 1.7;
            color: #334155;
        }

        .pdf-report-content h1 {
            font-size: 24px;
            font-weight: 700;
            color: #0f172a;
            margin: 28px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }

        .pdf-report-content h2 {
            font-size: 20px;
            font-weight: 700;
            color: #0f172a;
            margin: 24px 0 14px 0;
            padding-bottom: 6px;
            border-bottom: 1px solid #e2e8f0;
        }

        .pdf-report-content h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin: 20px 0 12px 0;
        }

        .pdf-report-content h4 {
            font-size: 14px;
            font-weight: 600;
            color: #334155;
            margin: 16px 0 10px 0;
        }

        .pdf-report-content p {
            margin: 10px 0;
            text-align: justify;
        }

        .pdf-report-content ul,
        .pdf-report-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .pdf-report-content li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .pdf-report-content strong {
            color: #0f172a;
            font-weight: 600;
        }

        .pdf-report-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 11px;
        }

        .pdf-report-content thead {
            background: linear-gradient(135deg, #1e3a5f, #0f766e);
        }

        .pdf-report-content th {
            color: #ffffff;
            font-weight: 600;
            text-align: left;
            padding: 10px 8px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .pdf-report-content td {
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
            line-height: 1.5;
        }

        .pdf-report-content tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        .pdf-report-content blockquote {
            border-left: 4px solid #0f766e;
            padding-left: 16px;
            margin: 16px 0;
            color: #475569;
            font-style: italic;
        }

        .pdf-report-content code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            color: #0f766e;
        }

        .pdf-report-content hr {
            border: none;
            border-top: 1px solid #e2e8f0;
            margin: 20px 0;
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-900 overflow-hidden h-screen flex">

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 z-[70] hidden transition-opacity duration-300">
        <div id="toast-content"
            class="px-6 py-3 rounded-full shadow-lg text-white text-sm font-medium flex items-center gap-2">
            <!-- Content injected by JS -->
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed inset-y-0 left-0 z-50 w-80 bg-slate-900 text-slate-300 transform -translate-x-full lg:relative lg:translate-x-0 flex flex-col shadow-xl transition-transform duration-300 ease-in-out">
        <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-950">
            <div>
                <h1 class="text-xl font-bold text-white tracking-tight flex items-center gap-2">
                    <i data-lucide="file-text" class="text-blue-500 w-6 h-6"></i>
                    ISO/IEC 42001
                </h1>
                <p class="text-xs text-blue-400 mt-1 font-medium tracking-wide">SUITE COMPLETA IA</p>
            </div>
            <button onclick="toggleMobileMenu()" class="lg:hidden text-slate-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <nav class="flex-1 overflow-y-auto p-4 space-y-8 scrollbar-thin scrollbar-thumb-slate-700">
            <div>
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 px-3">Estructura Normativa
                    (HLS)</h3>
                <ul class="space-y-1" id="clauses-nav">
                    <!-- Clauses injected by JS -->
                </ul>
            </div>

            <div>
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 px-3">Anexos Técnicos</h3>
                <ul class="space-y-1">
                    <li>
                        <button onclick="navigateTo('annexes')" id="nav-annexes"
                            class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition-all duration-200 hover:bg-slate-800 hover:text-white hover:translate-x-1 text-slate-500">
                            <i data-lucide="layers" class="w-5 h-5"></i>
                            <span class="text-left">Anexos A, B, C, D</span>
                        </button>
                    </li>
                    <li>
                        <button onclick="navigateTo('notebook')" id="nav-notebook"
                            class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition-all duration-200 hover:bg-slate-800 hover:text-white hover:translate-x-1 text-slate-500">
                            <i data-lucide="brain" class="w-5 h-5"></i>
                            <span
                                class="text-left font-bold bg-gradient-to-r from-blue-400 to-purple-400 text-transparent bg-clip-text">Cerebro
                                AI</span>
                        </button>
                    </li>
                    <li>
                        <button onclick="navigateTo('audit')" id="nav-audit"
                            class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition-all duration-200 hover:bg-slate-800 hover:text-white hover:translate-x-1 text-slate-500">
                            <i data-lucide="clipboard-check" class="w-5 h-5"></i>
                            <span
                                class="text-left font-bold bg-gradient-to-r from-emerald-400 to-teal-400 text-transparent bg-clip-text">Auditoría
                                Interna</span>
                        </button>
                    </li>
                    </li>
                </ul>
            </div>
        </nav>

        <div class="p-4 border-t border-slate-800 bg-slate-950">
            <!-- API Key Config (Mobile Only - Desktop has it in top bar) -->
            <button onclick="openConfigModal()"
                class="lg:hidden w-full flex items-center justify-center gap-2 mb-3 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg text-xs font-medium transition-colors">
                <i data-lucide="settings" class="w-3.5 h-3.5"></i>
                Configurar API Key
            </button>

            <!-- Dark Mode Toggle (Mobile Only) -->
            <button onclick="toggleTheme()"
                class="lg:hidden w-full flex items-center justify-center gap-2 mb-3 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg text-xs font-medium transition-colors">
                <i data-lucide="moon" class="w-3.5 h-3.5" id="theme-icon"></i>
                <span id="theme-text">Modo Oscuro</span>
            </button>

            <div class="text-[10px] text-slate-500 text-center leading-tight">
                Herramienta de Auditoría y Consulta<br />Basada en ISO/IEC 42001:2023<br />
                <span class="text-purple-400 font-bold mt-1 block">✨ Powered by Gemini</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden bg-slate-50 relative">
        <!-- Mobile Header -->
        <header
            class="lg:hidden bg-white border-b border-slate-200 p-4 flex items-center justify-between shadow-sm z-10">
            <h1 class="font-bold text-slate-800">ISO 42001</h1>
            <button onclick="toggleMobileMenu()" class="text-slate-600">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </header>

        <!-- Desktop Top Toolbar -->
        <div
            class="hidden lg:flex items-center justify-between px-8 py-3 bg-white border-b border-slate-200 shadow-sm z-10">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-2">
                    <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                    <span class="font-bold text-slate-800">ISO/IEC 42001</span>
                </div>

                <!-- Dashboard Navigation (solo los 3 dashboards) -->
                <div class="flex items-center gap-1 bg-slate-100 rounded-lg p-1">
                    <button onclick="navigateTo('dashboard')" id="top-nav-dashboard"
                        class="px-3 py-1.5 rounded-md text-xs font-medium transition-colors flex items-center gap-1.5 text-slate-600 hover:text-slate-900 hover:bg-white hover:shadow-sm">
                        <i data-lucide="layout-dashboard" class="w-3.5 h-3.5"></i>
                        <span>Composición</span>
                    </button>
                    <button onclick="navigateTo('clauses-dashboard')" id="top-nav-clauses-dashboard"
                        class="px-3 py-1.5 rounded-md text-xs font-medium transition-colors flex items-center gap-1.5 text-slate-600 hover:text-slate-900 hover:bg-white hover:shadow-sm">
                        <i data-lucide="book-open" class="w-3.5 h-3.5"></i>
                        <span>Dashboard Cláusulas</span>
                    </button>
                    <button onclick="navigateTo('annex-a-dashboard')" id="top-nav-annex-a-dashboard"
                        class="px-3 py-1.5 rounded-md text-xs font-medium transition-colors flex items-center gap-1.5 text-slate-600 hover:text-slate-900 hover:bg-white hover:shadow-sm">
                        <i data-lucide="shield-check" class="w-3.5 h-3.5"></i>
                        <span>Dashboard Anexo A</span>
                    </button>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- API Key Status -->
                <div id="top-api-status"
                    class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-50 border border-slate-200">
                    <i data-lucide="key" class="w-4 h-4 text-amber-500" id="top-api-icon"></i>
                    <span class="text-xs text-slate-600" id="top-api-text">Sin API Key</span>
                    <button onclick="openConfigModal()"
                        class="ml-1 text-xs text-blue-600 hover:text-blue-700 font-medium">
                        Configurar
                    </button>
                </div>

                <!-- Divider -->
                <div class="w-px h-6 bg-slate-200"></div>

                <!-- Export/Import -->
                <button onclick="exportData()"
                    class="flex items-center gap-1.5 px-3 py-1.5 text-slate-600 hover:bg-slate-100 rounded-lg text-xs font-medium transition-colors"
                    title="Exportar datos">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    <span>Exportar</span>
                </button>
                <button onclick="importData()"
                    class="flex items-center gap-1.5 px-3 py-1.5 text-slate-600 hover:bg-slate-100 rounded-lg text-xs font-medium transition-colors"
                    title="Importar datos">
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    <span>Importar</span>
                </button>
                <input type="file" id="top-import-file" class="hidden" accept=".json" onchange="handleImport(event)">

                <!-- Divider -->
                <div class="w-px h-6 bg-slate-200"></div>

                <!-- Dark Mode -->
                <button onclick="toggleTheme()"
                    class="p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors" title="Cambiar tema">
                    <i data-lucide="moon" class="w-4 h-4" id="top-theme-icon"></i>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 lg:px-12 scroll-smooth" id="main-scroll-area">
            <div class="max-w-6xl mx-auto">
                <!-- Breadcrumbs -->
                <div
                    class="flex items-center text-sm text-slate-400 mb-8 bg-white w-fit px-4 py-2 rounded-full border border-slate-100 shadow-sm">
                    <span class="font-medium text-slate-500">Norma</span>
                    <i data-lucide="chevron-right" class="mx-2 w-3.5 h-3.5 text-slate-300"></i>
                    <span class="font-medium text-slate-800" id="breadcrumb-section">Cuerpo Normativo</span>
                    <i data-lucide="chevron-right" class="mx-2 w-3.5 h-3.5 text-slate-300"></i>
                    <span class="text-blue-600 font-bold truncate max-w-[200px]" id="breadcrumb-title">...</span>
                </div>

                <!-- Content Area -->
                <div id="content-area">
                    <!-- Dynamic Content -->
                </div>
            </div>
        </div>

        <!-- AI Assistant Modal -->
        <div id="ai-modal" class="hidden absolute inset-0 z-50 bg-black/50 flex items-center justify-end">
            <div
                class="w-full md:w-[600px] h-full bg-white shadow-2xl flex flex-col animate-slideInRight border-l border-slate-200">
                <div
                    class="p-4 bg-gradient-to-r from-slate-900 to-slate-800 text-white flex justify-between items-center shadow-md">
                    <div class="flex items-center gap-2">
                        <div class="p-1.5 bg-white/10 rounded-lg">
                            <i data-lucide="sparkles" class="w-5 h-5 text-purple-300"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg leading-tight">Asistente Contextual</h3>
                            <p class="text-xs text-slate-400 truncate max-w-[300px]" id="ai-modal-context">Contexto: ...
                            </p>
                        </div>
                    </div>
                    <button onclick="closeAiModal()" class="p-2 hover:bg-white/10 rounded-full transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-6 bg-slate-50" id="ai-chat-area">
                    <!-- Quick Options -->
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button onclick="callContextualGemini('summarize')"
                            class="p-3 bg-white border border-slate-200 rounded-xl hover:border-purple-300 hover:shadow-md transition-all text-left flex flex-col gap-2 group">
                            <i data-lucide="file-text"
                                class="w-5 h-5 text-purple-500 group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-semibold text-slate-700">Resumir Requisitos</span>
                        </button>
                        <button onclick="callContextualGemini('checklist')"
                            class="p-3 bg-white border border-slate-200 rounded-xl hover:border-emerald-300 hover:shadow-md transition-all text-left flex flex-col gap-2 group">
                            <i data-lucide="check-square"
                                class="w-5 h-5 text-emerald-500 group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-semibold text-slate-700">Generar Checklist</span>
                        </button>
                        <button onclick="callContextualGemini('implementation')"
                            class="p-3 bg-white border border-slate-200 rounded-xl hover:border-blue-300 hover:shadow-md transition-all text-left flex flex-col gap-2 group">
                            <i data-lucide="lightbulb"
                                class="w-5 h-5 text-blue-500 group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-semibold text-slate-700">Guía de Implementación</span>
                        </button>
                        <button onclick="callContextualGemini('usecases')"
                            class="p-3 bg-white border border-slate-200 rounded-xl hover:border-amber-300 hover:shadow-md transition-all text-left flex flex-col gap-2 group">
                            <i data-lucide="briefcase"
                                class="w-5 h-5 text-amber-500 group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-semibold text-slate-700">Casos Prácticos</span>
                        </button>
                        <button onclick="callContextualGemini('audit')"
                            class="p-3 bg-white border border-slate-200 rounded-xl hover:border-rose-300 hover:shadow-md transition-all text-left flex flex-col gap-2 group">
                            <i data-lucide="help-circle"
                                class="w-5 h-5 text-rose-500 group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-semibold text-slate-700">Preguntas Auditoría</span>
                        </button>
                        <button onclick="callContextualGemini('risks')"
                            class="p-3 bg-white border border-slate-200 rounded-xl hover:border-red-300 hover:shadow-md transition-all text-left flex flex-col gap-2 group">
                            <i data-lucide="alert-triangle"
                                class="w-5 h-5 text-red-500 group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-semibold text-slate-700">Análisis de Riesgos</span>
                        </button>
                        <button onclick="callContextualGemini('iso27001')"
                            class="p-3 bg-white border border-slate-200 rounded-xl hover:border-cyan-300 hover:shadow-md transition-all text-left flex flex-col gap-2 group">
                            <i data-lucide="shield"
                                class="w-5 h-5 text-cyan-500 group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-semibold text-slate-700">Comparar ISO 27001</span>
                        </button>
                        <button onclick="callContextualGemini('documents')"
                            class="p-3 bg-white border border-slate-200 rounded-xl hover:border-indigo-300 hover:shadow-md transition-all text-left flex flex-col gap-2 group">
                            <i data-lucide="folder-open"
                                class="w-5 h-5 text-indigo-500 group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-semibold text-slate-700">Documentación</span>
                        </button>
                    </div>

                    <!-- AI Response Container -->
                    <div id="ai-response-container" class="space-y-4"></div>
                    <div id="ai-loading"
                        class="hidden flex flex-col items-center justify-center p-8 text-slate-400 gap-3 animate-pulse">
                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8"></div>
                        <span class="text-sm font-medium">Analizando norma...</span>
                    </div>
                </div>

                <div class="p-4 bg-white border-t border-slate-200">
                    <div class="relative">
                        <input type="text" id="ai-custom-query" onkeypress="handleAiKeyPress(event)"
                            placeholder="Haz una pregunta específica sobre esta sección..."
                            class="w-full pl-4 pr-12 py-3 bg-slate-100 border-none rounded-xl text-slate-700 placeholder-slate-400 focus:ring-2 focus:ring-purple-500 focus:bg-white transition-all outline-none">
                        <button id="ai-send-btn" onclick="callContextualGemini('custom')" type="button"
                            class="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors cursor-pointer z-10">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <p class="text-[10px] text-center text-slate-400 mt-2">La IA puede cometer errores. Verifica la
                        información importante.</p>
                </div>
            </div>
        </div>

        <!-- Chat Float Module -->
        <div class="fixed bottom-6 right-6 z-40 flex flex-col items-end gap-4">
            <!-- Chat Window -->
            <div id="general-chat-window"
                class="hidden w-[350px] md:w-[450px] h-[500px] bg-white rounded-2xl shadow-2xl flex flex-col border border-slate-200 animate-slideUp origin-bottom-right overflow-hidden transition-all duration-300">
                <div
                    class="bg-gradient-to-r from-blue-600 to-indigo-700 p-4 flex justify-between items-center text-white">
                    <div class="flex items-center gap-3">
                        <div class="bg-white/20 p-2 rounded-full"><i data-lucide="sparkles"
                                class="w-[18px] h-[18px] text-yellow-300"></i></div>
                        <div>
                            <h3 class="font-bold text-sm">Consultor ISO AI</h3>
                            <p class="text-[10px] text-blue-200">Experto en 42001 y 23894</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="toggleChatExpand()"
                            class="hover:bg-white/20 p-1 rounded-full transition-colors" title="Expandir/Contraer">
                            <i data-lucide="maximize-2" class="w-[18px] h-[18px]" id="expand-icon"></i>
                        </button>
                        <button onclick="toggleChat()" class="hover:bg-white/20 p-1 rounded-full transition-colors">
                            <i data-lucide="x" class="w-[18px] h-[18px]"></i>
                        </button>
                    </div>
                </div>

                <div id="general-chat-messages" class="flex-1 overflow-y-auto p-4 bg-slate-50 space-y-4">
                    <!-- Messages injected by JS -->
                </div>

                <!-- File Preview Area -->
                <div id="file-preview-area"
                    class="hidden px-4 py-3 bg-slate-50 border-t border-slate-100 flex items-center justify-between transition-all duration-300">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="bg-blue-100 p-2 rounded-lg shrink-0 text-blue-600" id="file-preview-icon-container">
                            <span id="file-preview-icon"><i data-lucide="file-text" class="w-5 h-5"></i></span>
                        </div>
                        <div class="flex flex-col min-w-0">
                            <span id="file-preview-name"
                                class="text-xs font-semibold text-slate-700 truncate block max-w-[180px]">...</span>
                            <span id="file-preview-size" class="text-[10px] text-slate-500 font-medium">...</span>
                        </div>
                    </div>
                    <button onclick="removeAttachedFile()"
                        class="p-1.5 hover:bg-slate-200 text-slate-400 hover:text-red-500 rounded-full transition-colors"
                        title="Eliminar archivo">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>

                <div class="p-3 bg-white border-t border-slate-100">
                    <div class="relative flex items-center gap-2">
                        <!-- Dynamic file input created by JS -->
                        <button onclick="attachFileToChat()"
                            class="p-2.5 bg-slate-100 text-slate-600 rounded-full hover:bg-slate-200 transition-colors"
                            title="Adjuntar archivo o imagen">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <input type="text" id="general-chat-input" onkeypress="handleChatKeyPress(event)"
                            placeholder="Escribe o pega una imagen (Ctrl+V)..."
                            class="flex-1 bg-slate-100 border-none rounded-full px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all outline-none">
                        <button onclick="sendChatMessage()"
                            class="p-2.5 bg-blue-600 text-white rounded-full hover:bg-blue-700 shadow-md">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Float Button -->
            <button onclick="toggleChat()"
                class="p-4 rounded-full shadow-lg transition-all transform hover:scale-110 flex items-center justify-center bg-gradient-to-r from-blue-600 to-indigo-600 text-white"
                id="chat-float-btn">
                <i data-lucide="message-square" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Config Modal -->
        <div id="config-modal"
            class="hidden fixed inset-0 z-[60] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 border border-slate-200 animate-fadeIn">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="settings" class="w-6 h-6 text-slate-600"></i>
                        Configuración
                    </h3>
                    <button onclick="closeConfigModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
                        <i data-lucide="key" class="w-4 h-4 text-slate-500"></i>
                        Google Gemini API Key
                    </label>
                    <input type="password" id="api-key-input" placeholder="Ingresa tu clave aquí (comienza con AIza...)"
                        class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm font-mono">
                    <p class="text-xs text-slate-500 mt-2 leading-relaxed">
                        Tu clave se guardará de forma segura en el almacenamiento local de tu navegador.
                    </p>
                </div>

                <div class="flex justify-end gap-3">
                    <button onclick="closeConfigModal()"
                        class="px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg transition-colors">Cancelar</button>
                    <button onclick="saveApiKey()"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg flex items-center gap-2 shadow-sm transition-all transform active:scale-95">
                        <i data-lucide="save" class="w-[18px] h-[18px]"></i>
                        Guardar Configuración
                    </button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // Configure PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // --- DATA ---
        // Datos detallados ISO 42001:2023 - Reflejo fiel del documento estándar
        const isoData = {
            clauses: [
                {
                    id: '4', title: '4. Contexto de la organización', icon: 'book',
                    subsections: [
                        {
                            id: '4.1', title: '4.1 Comprensión de la organización y su contexto', content: [
                                { type: 'p', text: 'La organización deberá determinar las cuestiones externas e internas que sean relevantes para su propósito y que afecten su capacidad para lograr los resultados previstos de su sistema de gestión de IA.' },
                                { type: 'p', text: 'La organización debe determinar si el cambio climático es un tema relevante.' },
                                { type: 'p', text: 'La organización deberá considerar la finalidad de los sistemas de IA que desarrolla, proporciona o utiliza. La organización deberá determinar sus funciones con respecto a estos sistemas de IA.' },
                                { type: 'note', id: 'n4.1.1', title: 'NOTA 1', text: 'Roles en relación con el sistema de IA:', list: ['Proveedores de IA', 'Productores de IA', 'Clientes de IA', 'Socios de IA', 'Sujetos de IA', 'Autoridades pertinentes'] },
                                { type: 'note', id: 'n4.1.2', title: 'NOTA 2', text: 'Cuestiones externas e internas:', list: ['a) Contexto externo (legal, competitivo, cultural, político)', 'b) Contexto interno (gobernanza, obligaciones contractuales, capacidades)'] }
                            ]
                        },
                        {
                            id: '4.2', title: '4.2 Necesidades y expectativas de partes interesadas', content: [
                                { type: 'p', text: 'La organización deberá determinar:' },
                                { type: 'list', items: ['las partes interesadas relevantes para el sistema de gestión de IA', 'los requisitos pertinentes de estas partes', 'cuáles de estos requisitos se abordarán a través del sistema de gestión de IA'] },
                                { type: 'note', id: 'n4.2.1', title: 'NOTA', text: 'Requisitos relacionados con cambio climático y derechos fundamentales.' }
                            ]
                        },
                        {
                            id: '4.3', title: '4.3 Alcance del sistema de gestión de IA', content: [
                                { type: 'p', text: 'La organización deberá determinar los límites y la aplicabilidad del sistema de gestión de IA para establecer su alcance.' },
                                { type: 'list', items: ['Considerar cuestiones internas/externas (4.1)', 'Requisitos de partes interesadas (4.2)', 'Roles de la organización (Proveedor, Productor, Usuario)'] }
                            ]
                        },
                        {
                            id: '4.4', title: '4.4 Sistema de gestión de IA', content: [
                                { type: 'p', text: 'La organización deberá establecer, implementar, mantener y mejorar continuamente un sistema de gestión de IA, incluidos los procesos necesarios y sus interacciones, de acuerdo con los requisitos de este documento.' }
                            ]
                        }
                    ]
                },
                {
                    id: '5', title: '5. Liderazgo', icon: 'activity',
                    subsections: [
                        {
                            id: '5.1', title: '5.1 Liderazgo y compromiso', content: [
                                { type: 'p', text: 'La alta dirección deberá demostrar liderazgo y compromiso con respecto al sistema de gestión de IA.' },
                                { type: 'list', items: ['Garantizar política y objetivos alineados con estrategia', 'Integración en procesos de negocio', 'Recursos disponibles', 'Comunicar importancia de la gestión eficaz', 'Asegurar resultados previstos', 'Dirigir y apoyar a las personas', 'Promover mejora continua'] }
                            ]
                        },
                        {
                            id: '5.2', title: '5.2 Política de IA', content: [
                                { type: 'p', text: 'La alta dirección deberá establecer una política de IA que sea apropiada al propósito, proporcione un marco para objetivos, incluya compromiso de cumplimiento de requisitos y mejora continua.' }
                            ]
                        },
                        {
                            id: '5.3', title: '5.3 Roles y responsabilidades', content: [
                                { type: 'p', text: 'La alta dirección debe asegurarse de que las responsabilidades y autoridades se asignen y comuniquen para garantizar que el sistema cumpla los requisitos e informar sobre el desempeño.' }
                            ]
                        }
                    ]
                },
                {
                    id: '6', title: '6. Planificación', icon: 'shield',
                    subsections: [
                        {
                            id: '6.1.1', title: '6.1.1 Acciones para riesgos y oportunidades', content: [
                                { type: 'p', text: 'Determinar riesgos y oportunidades para asegurar que el sistema logre resultados previstos, prevenir efectos no deseados y lograr mejora continua.' },
                                { type: 'p', text: 'La organización debe planificar acciones para abordar estos riesgos y cómo integrarlas en los procesos.' }
                            ]
                        },
                        {
                            id: '6.1.2', title: '6.1.2 Evaluación de riesgos de IA', content: [
                                { type: 'p', text: 'Definir y establecer un proceso de evaluación de riesgos de IA que:' },
                                { type: 'list', items: ['Esté alineado con la política de IA', 'Identifique riesgos que impiden objetivos', 'Analice riesgos (consecuencias y probabilidad)', 'Evalúe riesgos comparando con criterios'] }
                            ]
                        },
                        {
                            id: '6.1.3', title: '6.1.3 Tratamiento de riesgos de IA', content: [
                                { type: 'p', text: 'Seleccionar opciones de tratamiento, determinar controles necesarios (comparando con Anexo A), producir una Declaración de Aplicabilidad (SoA) y formular un plan de tratamiento.' }
                            ]
                        },
                        {
                            id: '6.1.4', title: '6.1.4 Evaluación de impacto', content: [
                                { type: 'p', text: 'Definir proceso para evaluar consecuencias en individuos y sociedades (Impact Assessment) que resulten del desarrollo, provisión o uso de sistemas de IA.' }
                            ]
                        },
                        {
                            id: '6.2', title: '6.2 Objetivos de IA', content: [
                                { type: 'p', text: 'Establecer objetivos de IA en funciones pertinentes, coherentes con la política, mensurables, objeto de seguimiento y comunicados.' }
                            ]
                        },
                        {
                            id: '6.3', title: '6.3 Planificación de cambios', content: [
                                { type: 'p', text: 'Cuando la organización determine la necesidad de cambios en el sistema de gestión de IA, estos cambios se deben llevar a cabo de manera planificada.' },
                                { type: 'p', text: 'La organización debe considerar:' },
                                { type: 'list', items: ['El propósito de los cambios y sus posibles consecuencias', 'La integridad del sistema de gestión de IA', 'La disponibilidad de recursos', 'La asignación o reasignación de responsabilidades y autoridades'] },
                                { type: 'note', id: 'n6.3.1', title: 'NOTA', text: 'Incluso pequeños cambios en sistemas de IA pueden tener efectos significativos en resultados del modelo, introducir sesgos o afectar el cumplimiento normativo. La gestión planificada de cambios previene brechas de seguridad, ineficiencias operativas o incumplimientos.' }
                            ]
                        }
                    ]
                },
                {
                    id: '7', title: '7. Soporte', icon: 'list',
                    subsections: [
                        { id: '7.1', title: '7.1 Recursos', content: [{ type: 'p', text: 'Determinar y proporcionar recursos necesarios (personas, infraestructura, conocimientos) para el establecimiento y mantenimiento del sistema.' }] },
                        { id: '7.2', title: '7.2 Competencia', content: [{ type: 'p', text: 'Garantizar competencia de personas basada en educación, formación o experiencia y tomar acciones para adquirir competencia necesaria.' }] },
                        { id: '7.3', title: '7.3 Toma de conciencia', content: [{ type: 'p', text: 'Personas deben ser conscientes de la política de IA, su contribución a la eficacia y las implicaciones del incumplimiento.' }] },
                        { id: '7.4', title: '7.4 Comunicación', content: [{ type: 'p', text: 'Determinar comunicaciones internas y externas relevantes: qué, cuándo, a quién, cómo y quién comunica.' }] },
                        {
                            id: '7.5',
                            title: '7.5 Información documentada',
                            subsections: [
                                {
                                    id: '7.5.1',
                                    title: '7.5.1 Generalidades',
                                    content: [
                                        { type: 'p', text: 'El sistema de gestión de IA de la organización incluirá:' },
                                        {
                                            type: 'ul', items: [
                                                'La información documentada requerida por este documento',
                                                'La información documentada determinada por la organización como necesaria para la eficacia del sistema de gestión de IA'
                                            ]
                                        },
                                        { type: 'note', text: 'NOTA: La extensión de la información documentada para un sistema de gestión de IA puede diferir de una organización a otra debido al tamaño de la organización y su tipo de actividades, procesos, productos y servicios; la complejidad de los procesos y sus interacciones; la competencia de las personas.' }
                                    ]
                                },
                                {
                                    id: '7.5.2',
                                    title: '7.5.2 Creación y actualización',
                                    content: [
                                        { type: 'p', text: 'Al crear y actualizar información documentada, la organización asegurará la apropiada:' },
                                        {
                                            type: 'ul', items: [
                                                'Identificación y descripción (por ejemplo, un título, fecha, autor o número de referencia)',
                                                'Formato (por ejemplo, idioma, versión de software, gráficos) y soporte (por ejemplo, papel, electrónico)',
                                                'Revisión y aprobación para idoneidad y adecuación'
                                            ]
                                        }
                                    ]
                                },
                                {
                                    id: '7.5.3',
                                    title: '7.5.3 Control de la información documentada',
                                    content: [
                                        { type: 'p', text: 'La información documentada requerida por el sistema de gestión de IA y por este documento será controlada para asegurar:' },
                                        {
                                            type: 'ul', items: [
                                                'Que esté disponible y sea adecuada para su uso, donde y cuando se necesite',
                                                'Que esté adecuadamente protegida (por ejemplo, contra pérdida de confidencialidad, uso indebido o pérdida de integridad)'
                                            ]
                                        },
                                        { type: 'p', text: 'Para el control de la información documentada, la organización abordará las siguientes actividades:' },
                                        {
                                            type: 'ul', items: [
                                                'Distribución, acceso, recuperación y uso',
                                                'Almacenamiento y preservación, incluida la preservación de la legibilidad',
                                                'Control de cambios (por ejemplo, control de versiones)',
                                                'Retención y disposición'
                                            ]
                                        },
                                        { type: 'p', text: 'La información documentada de origen externo determinada por la organización como necesaria para la planificación y operación del sistema de gestión de IA será identificada y controlada.' },
                                        { type: 'note', text: 'NOTA: El acceso puede implicar una decisión respecto al permiso para ver únicamente la información documentada, o el permiso y autoridad para ver y cambiar la información documentada.' }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    id: '8', title: '8. Operación', icon: 'activity',
                    subsections: [
                        { id: '8.1', title: '8.1 Planificación y control', content: [{ type: 'p', text: 'Planificar, implementar y controlar los procesos necesarios para cumplir requisitos y acciones de la Cláusula 6. Controlar cambios y procesos externos.' }] },
                        { id: '8.2', title: '8.2 Evaluación de riesgos de IA', content: [{ type: 'p', text: 'Realizar evaluaciones de riesgos de IA a intervalos planificados o ante cambios significativos. Conservar información documentada.' }] },
                        { id: '8.3', title: '8.3 Tratamiento de riesgos', content: [{ type: 'p', text: 'Implementar plan de tratamiento de riesgos y verificar su eficacia. Actualizar plan si es necesario.' }] },
                        { id: '8.4', title: '8.4 Evaluación de impacto', content: [{ type: 'p', text: 'Realizar evaluaciones de impacto del sistema de IA a intervalos planificados o ante cambios significativos.' }] }
                    ]
                },
                {
                    id: '9', title: '9. Evaluación del desempeño', icon: 'check-square',
                    subsections: [
                        { id: '9.1', title: '9.1 Seguimiento y medición', content: [{ type: 'p', text: 'Determinar qué medir, métodos de seguimiento y análisis, cuándo medir y evaluar. Evaluar desempeño y eficacia.' }] },
                        { id: '9.2', title: '9.2 Auditoría interna', content: [{ type: 'p', text: 'Realizar auditorías internas a intervalos planificados para asegurar conformidad y eficacia. Establecer programa de auditoría.' }] },
                        { id: '9.3', title: '9.3 Revisión por la dirección', content: [{ type: 'p', text: 'La alta dirección debe revisar el sistema de gestión a intervalos planificados. Incluir entradas sobre cambios, desempeño, retroalimentación y riesgos.' }] }
                    ]
                },
                {
                    id: '10', title: '10. Mejora', icon: 'activity',
                    subsections: [
                        { id: '10.1', title: '10.1 Mejora continua', content: [{ type: 'p', text: 'Mejorar continuamente la idoneidad, adecuación y eficacia del sistema de gestión de IA.' }] },
                        { id: '10.2', title: '10.2 No conformidad y acción correctiva', content: [{ type: 'p', text: 'Reaccionar ante no conformidades, evaluar necesidad de acciones para eliminar causas, implementar acciones, revisar eficacia y realizar cambios si es necesario.' }] }
                    ]
                }
            ],
            annexA: [
                {
                    category: 'A.2 Políticas relacionadas con IA', controls: [
                        {
                            code: 'A.2.2',
                            name: 'Política de IA',
                            desc: 'La organización debe documentar una política para el desarrollo o uso de sistemas de IA.',
                            guid: 'B.2.2: Definir política de IA alineada con objetivos estratégicos. Incluir principios éticos (equidad, transparencia, responsabilidad, seguridad). Documentar compromisos de la alta dirección.'
                        },
                        {
                            code: 'A.2.3',
                            name: 'Alineación con otras políticas organizacionales',
                            desc: 'Las políticas de IA deben alinearse con otras políticas organizacionales relevantes.',
                            guid: 'B.2.3: Asegurar coherencia con políticas de privacidad, seguridad de la información, calidad, gestión de riesgos, recursos humanos y cumplimiento normativo.'
                        },
                        {
                            code: 'A.2.4',
                            name: 'Revisión de la política de IA',
                            desc: 'Las políticas relacionadas con la IA deben revisarse a intervalos planificados o si ocurren cambios significativos.',
                            guid: 'B.2.4: Revisar al menos anualmente o ante cambios regulatorios, tecnológicos o de riesgo significativos. Documentar resultados de revisiones.'
                        }
                    ]
                },
                {
                    category: 'A.3 Organización interna', controls: [
                        {
                            code: 'A.3.2',
                            name: 'Roles y responsabilidades de IA',
                            desc: 'Se deben definir y asignar roles y responsabilidades para el sistema de gestión de IA.',
                            guid: 'B.3.2: Designar un responsable de IA (AI Officer/AI Manager). Definir comités de ética de IA. Asignar responsabilidades a equipos de desarrollo, operaciones, cumplimiento y auditoría.'
                        },
                        {
                            code: 'A.3.3',
                            name: 'Reporte de inquietudes',
                            desc: 'Se debe establecer un proceso para que el personal informe sobre inquietudes relacionadas con sistemas de IA.',
                            guid: 'B.3.3: Crear canales de denuncia confidenciales y accesibles. Proteger a denunciantes (whistleblowers). Investigar y actuar sobre las preocupaciones reportadas de manera oportuna.'
                        }
                    ]
                },
                {
                    category: 'A.4 Recursos para sistemas de IA', controls: [
                        {
                            code: 'A.4.2',
                            name: 'Documentación de recursos',
                            desc: 'La organización debe identificar y documentar los recursos relevantes necesarios para las actividades en determinadas etapas del ciclo de vida del sistema de IA.',
                            guid: 'B.4.2: Crear inventario completo de recursos: datos, herramientas, infraestructura y personal. Documentar dependencias y requisitos para cada etapa del ciclo de vida.'
                        },
                        {
                            code: 'A.4.3',
                            name: 'Recursos de datos',
                            desc: 'Como parte de la identificación de recursos, la organización debe documentar información sobre los recursos de datos utilizados para el sistema de IA.',
                            guid: 'B.4.3: Inventariar conjuntos de datos (origen, tipo, volumen). Clasificar según sensibilidad y criticidad. Documentar derechos de uso, licencias y restricciones. Gestionar acceso y almacenamiento seguro.'
                        },
                        {
                            code: 'A.4.4',
                            name: 'Recursos de herramientas',
                            desc: 'Como parte de la identificación de recursos, la organización debe documentar información sobre los recursos de herramientas utilizados para el sistema de IA.',
                            guid: 'B.4.4: Mantener inventario de frameworks (TensorFlow, PyTorch, scikit-learn), plataformas cloud (AWS SageMaker, Azure ML, Google Vertex AI), herramientas de MLOps, versionado y monitoreo.'
                        },
                        {
                            code: 'A.4.5',
                            name: 'Recursos de sistema y computación',
                            desc: 'Como parte de la identificación de recursos, la organización debe documentar información sobre el sistema y recursos informáticos utilizados para el sistema de IA.',
                            guid: 'B.4.5: Planificar y documentar capacidad de cómputo (GPUs, TPUs, clusters). Gestionar entornos de desarrollo, prueba, staging y producción. Considerar impacto ambiental y eficiencia energética.'
                        },
                        {
                            code: 'A.4.6',
                            name: 'Recursos humanos',
                            desc: 'Como parte de la identificación de recursos, documentar información sobre recursos humanos y sus competencias.',
                            guid: 'B.4.6: Evaluar competencias en ciencia de datos, ingeniería de ML, ética de IA, seguridad y cumplimiento. Proporcionar formación continua. Documentar roles, responsabilidades y niveles de experiencia.'
                        }
                    ]
                },
                {
                    category: 'A.5 Evaluación de impactos de sistemas de IA', controls: [
                        {
                            code: 'A.5.2',
                            name: 'Proceso de evaluación de impacto del sistema de IA',
                            desc: 'Establecer proceso para evaluar consecuencias potenciales derivadas del sistema de IA.',
                            guid: 'B.5.2: Definir metodología de evaluación de impacto. Identificar stakeholders afectados. Evaluar impactos positivos y negativos en derechos fundamentales, seguridad, privacidad y sociedad.'
                        },
                        {
                            code: 'A.5.3',
                            name: 'Documentación de evaluaciones de impacto',
                            desc: 'Documentar y conservar resultados de evaluaciones durante período definido.',
                            guid: 'B.5.3: Mantener registros detallados de evaluaciones de impacto. Documentar decisiones tomadas para mitigar efectos negativos. Conservar evidencia de revisiones y actualizaciones.'
                        },
                        {
                            code: 'A.5.4',
                            name: 'Evaluación de impacto en individuos o grupos',
                            desc: 'Evaluar y documentar impactos potenciales en individuos o grupos.',
                            guid: 'B.5.4: Analizar efectos en derechos fundamentales, discriminación, sesgos, privacidad y autonomía. Considerar grupos vulnerables. Evaluar antes del despliegue y ante cambios mayores.'
                        },
                        {
                            code: 'A.5.5',
                            name: 'Evaluación de impactos sociales',
                            desc: 'Evaluar y documentar impactos sociales a lo largo del ciclo de vida.',
                            guid: 'B.5.5: Analizar efectos en empleo, medio ambiente, cohesión social, democracia y bienestar colectivo. Considerar consecuencias a largo plazo y efectos sistémicos.'
                        }
                    ]
                },
                {
                    category: 'A.6 Ciclo de vida del sistema de IA', controls: [
                        {
                            code: 'A.6.1.2',
                            name: 'Objetivos para desarrollo responsable',
                            desc: 'Identificar y documentar objetivos para guiar desarrollo responsable.',
                            guid: 'B.6.1.2: Definir objetivos de equidad, transparencia, explicabilidad, robustez, seguridad y privacidad. Alinear con valores organizacionales y requisitos regulatorios.'
                        },
                        {
                            code: 'A.6.1.3',
                            name: 'Procesos para diseño y desarrollo responsable',
                            desc: 'Definir y documentar procesos específicos para diseño y desarrollo responsable.',
                            guid: 'B.6.1.3: Establecer metodologías de desarrollo (Agile, DevOps, MLOps). Integrar consideraciones éticas desde el diseño (Privacy by Design, Fairness by Design). Documentar flujos de trabajo y puntos de control.'
                        },
                        {
                            code: 'A.6.2.2',
                            name: 'Requisitos y especificación del sistema',
                            desc: 'Especificar y documentar requisitos para nuevos sistemas o mejoras.',
                            guid: 'B.6.2.2: Incluir requisitos funcionales (precisión, rendimiento) y no funcionales (robustez, ciberseguridad, explicabilidad, equidad). Considerar requisitos legales y regulatorios. Documentar casos de uso y restricciones.'
                        },
                        {
                            code: 'A.6.2.3',
                            name: 'Documentación de diseño y desarrollo',
                            desc: 'Documentar diseño basado en objetivos, requisitos y criterios.',
                            guid: 'B.6.2.3: Documentar arquitectura del modelo, selección de algoritmos, hiperparámetros y decisiones de diseño. Mantener trazabilidad entre requisitos y diseño. Controlar versiones del código y modelos.'
                        },
                        {
                            code: 'A.6.2.4',
                            name: 'Verificación y validación del sistema',
                            desc: 'Definir medidas de V&V y criterios para su uso.',
                            guid: 'B.6.2.4: Realizar pruebas unitarias, de integración y de sistema. Validar con conjuntos de datos de prueba separados (Hold-out sets, Cross-validation). Verificar métricas de desempeño, equidad y robustez. Realizar pruebas adversariales.'
                        },
                        {
                            code: 'A.6.2.5',
                            name: 'Despliegue del sistema',
                            desc: 'Documentar plan de implementación y garantizar cumplimiento de requisitos.',
                            guid: 'B.6.2.5: Establecer criterios de aceptación para paso a producción. Planificar estrategia de despliegue (Blue-Green, Canary, Rolling). Preparar rollback en caso de fallos. Monitorizar fase inicial intensivamente.'
                        },
                        {
                            code: 'A.6.2.6',
                            name: 'Operación y monitoreo del sistema',
                            desc: 'Definir elementos para funcionamiento continuo: supervisión, reparaciones, actualizaciones, soporte.',
                            guid: 'B.6.2.6: Monitorizar "Data Drift" (cambio en distribución de datos) y "Model Drift" (degradación de rendimiento). Establecer alertas y umbrales. Implementar supervisión humana (Human-in-the-loop) cuando sea crítico. Gestionar actualizaciones y reentrenamiento.'
                        },
                        {
                            code: 'A.6.2.8',
                            name: 'Registro de eventos',
                            desc: 'Garantizar registro automático de eventos durante operación.',
                            guid: 'B.6.2.8: Registrar predicciones, decisiones, entradas, salidas, errores y eventos de seguridad. Mantener logs para auditoría, explicabilidad y depuración. Asegurar integridad y protección de registros.'
                        }
                    ]
                },
                {
                    category: 'A.7 Datos para sistemas de IA', controls: [
                        {
                            code: 'A.7.2',
                            name: 'Datos para desarrollo y mejora',
                            desc: 'Definir, documentar e implementar procesos de gestión de datos.',
                            guid: 'B.7.2: Establecer procesos para recopilación, almacenamiento, procesamiento y eliminación de datos. Definir roles y responsabilidades. Asegurar cumplimiento con regulaciones de protección de datos.'
                        },
                        {
                            code: 'A.7.3',
                            name: 'Adquisición de datos',
                            desc: 'Determinar y documentar detalles sobre adquisición y selección de datos.',
                            guid: 'B.7.3: Verificar licencias y derechos de propiedad intelectual. Asegurar consentimiento si hay datos personales. Documentar fuentes, métodos de recopilación y criterios de selección. Evaluar calidad y representatividad.'
                        },
                        {
                            code: 'A.7.4',
                            name: 'Calidad de los datos',
                            desc: 'Definir requisitos de calidad y garantizar que datos cumplan requisitos.',
                            guid: 'B.7.4: Verificar exactitud, completitud, consistencia, actualidad y relevancia. Detectar y mitigar sesgos en los datos de entrenamiento. Implementar controles de calidad automatizados y manuales.'
                        },
                        {
                            code: 'A.7.5',
                            name: 'Procedencia de los datos',
                            desc: 'Definir proceso para registrar procedencia de datos a lo largo de ciclos de vida.',
                            guid: 'B.7.5: Mantener trazabilidad desde el origen hasta su uso en el modelo. Documentar transformaciones, agregaciones y derivaciones aplicadas. Registrar versiones de conjuntos de datos.'
                        },
                        {
                            code: 'A.7.6',
                            name: 'Preparación de datos',
                            desc: 'Definir criterios para seleccionar métodos de preparación de datos.',
                            guid: 'B.7.6: Documentar limpieza, etiquetado, normalización, aumento y balanceo de datos. Asegurar que el proceso es consistente y reproducible entre entrenamiento y producción. Validar calidad de datos preparados.'
                        }
                    ]
                },
                {
                    category: 'A.8 Información para partes interesadas', controls: [
                        {
                            code: 'A.8.2',
                            name: 'Documentación e información para usuarios',
                            desc: 'Determinar y proporcionar información necesaria a usuarios.',
                            guid: 'B.8.2: Crear fichas técnicas del modelo (Model Cards) o fichas de sistema. Explicar propósito, capacidades, limitaciones y uso previsto. Proporcionar guías de usuario y documentación técnica.'
                        },
                        {
                            code: 'A.8.3',
                            name: 'Reporte externo',
                            desc: 'Proporcionar capacidades para que partes informen impactos adversos.',
                            guid: 'B.8.3: Establecer canales para que usuarios y stakeholders reporten problemas, errores, sesgos o impactos negativos. Facilitar mecanismos de feedback accesibles.'
                        },
                        {
                            code: 'A.8.4',
                            name: 'Comunicación de incidentes',
                            desc: 'Determinar y documentar plan para comunicar incidentes a usuarios.',
                            guid: 'B.8.4: Establecer proceso de comunicación de fallos, brechas de seguridad, decisiones erróneas o impactos adversos a reguladores, usuarios y partes afectadas. Definir plazos y canales de notificación.'
                        },
                        {
                            code: 'A.8.5',
                            name: 'Información para partes interesadas',
                            desc: 'Determinar y documentar obligaciones de informar a partes interesadas.',
                            guid: 'B.8.5: Identificar requisitos de transparencia y divulgación según regulaciones (ej. EU AI Act, GDPR). Comunicar uso de IA en decisiones automatizadas. Revelar cuando usuarios interactúan con sistemas de IA.'
                        }
                    ]
                },
                {
                    category: 'A.9 Uso de sistemas de IA', controls: [
                        {
                            code: 'A.9.2',
                            name: 'Procesos para uso responsable',
                            desc: 'Definir y documentar procesos para uso responsable de sistemas.',
                            guid: 'B.9.2: Establecer políticas de uso aceptable. Definir procedimientos operativos estándar. Implementar controles de acceso y autorización. Monitorizar uso para detectar desviaciones.'
                        },
                        {
                            code: 'A.9.3',
                            name: 'Objetivos para uso responsable',
                            desc: 'Identificar y documentar objetivos para guiar uso responsable.',
                            guid: 'B.9.3: Definir objetivos de uso ético, seguro y conforme a regulaciones. Alinear con valores organizacionales y expectativas de stakeholders. Comunicar objetivos a usuarios y operadores.'
                        },
                        {
                            code: 'A.9.4',
                            name: 'Uso previsto del sistema',
                            desc: 'Asegurar uso según usos previstos y documentación.',
                            guid: 'B.9.4: Formar a usuarios en el uso correcto y limitaciones. Monitorizar para detectar uso indebido, malicioso o fuera de alcance (out-of-scope). Prevenir ataques adversariales y manipulación.'
                        }
                    ]
                },
                {
                    category: 'A.10 Relaciones con terceros y clientes', controls: [
                        {
                            code: 'A.10.1',
                            name: 'Evaluación de proveedores externos',
                            desc: 'Evaluar y valorar los riesgos asociados con proveedores externos de sistemas de IA.',
                            guid: 'B.10.1: Realizar due diligence de proveedores. Evaluar capacidades técnicas, cumplimiento normativo, seguridad y prácticas éticas. Verificar certificaciones y auditorías.'
                        },
                        {
                            code: 'A.10.2',
                            name: 'Asignación de responsabilidades',
                            desc: 'Asegurar distribución clara de responsabilidades entre organización, socios, proveedores, clientes y terceros.',
                            guid: 'B.10.2: Definir y documentar responsabilidades en contratos y acuerdos. Especificar quién es responsable de datos, modelos, decisiones, incidentes y cumplimiento. Establecer mecanismos de rendición de cuentas.'
                        },
                        {
                            code: 'A.10.3',
                            name: 'Proveedores',
                            desc: 'Establecer proceso para garantizar que uso de servicios/productos de proveedores se alinee con enfoque responsable.',
                            guid: 'B.10.3: Incluir cláusulas de IA en contratos (propiedad de datos, responsabilidad, transparencia, seguridad). Monitorizar desempeño y cumplimiento de proveedores. Gestionar cambios y actualizaciones de servicios externos.'
                        },
                        {
                            code: 'A.10.4',
                            name: 'Clientes',
                            desc: 'Asegurar que enfoque responsable considere expectativas y necesidades de clientes.',
                            guid: 'B.10.4: Proporcionar documentación técnica y guías de usuario a clientes. Establecer canales de soporte para incidencias. Comunicar limitaciones, riesgos y mejores prácticas. Recopilar feedback para mejora continua.'
                        }
                    ]
                }
            ],
            annexB: [
                {
                    section: 'B.2 Políticas relacionadas con la IA',
                    objetivo: 'Proporcionar dirección y soporte de gestión para los sistemas de IA de acuerdo con los requisitos comerciales.',
                    subsections: [
                        {
                            id: 'B.2.2',
                            title: 'Política de IA',
                            control: 'La organización debe documentar una política para el desarrollo o uso de sistemas de IA.',
                            guidance: 'La política de IA debe basarse en: estrategia empresarial, valores y cultura organizacional, entorno de riesgo, nivel de riesgo de los sistemas de IA, requisitos legales (contratos), e impacto para partes interesadas. La política debe incluir principios que guían actividades relacionadas con IA. ISO/IEC 38507 proporciona orientación para habilitar y gobernar sistemas de IA a lo largo de su ciclo de vida.',
                            other: ''
                        },
                        {
                            id: 'B.2.3',
                            title: 'Alineación con otras políticas organizacionales',
                            control: 'La organización debe determinar dónde otras políticas pueden verse afectadas o aplicarse a los objetivos con respecto a sistemas de IA.',
                            guidance: 'Muchos ámbitos se intersecan con la IA: calidad, seguridad, protección y privacidad. La política de IA debe considerar aspectos específicos cuando sea necesario (evaluaciones de impacto, recursos y activos de IA, desarrollo de sistemas, gestión de datos, gestión de activos, supervisión humana, relaciones con proveedores, seguridad, privacidad, desarrollo, actuación, procesos para gestionar desviaciones y excepciones). Las políticas del órgano de gobierno deben informar la política de IA.',
                            other: ''
                        },
                        {
                            id: 'B.2.4',
                            title: 'Revisión de la política de IA',
                            control: 'La política de IA debe revisarse a intervalos planificados o según sea necesario para garantizar su continua idoneidad, adecuación y eficacia.',
                            guidance: 'Un puesto aprobado por la dirección debe ser responsable del desarrollo, revisión y evaluación de la política de IA. La revisión debe incluir evaluación de oportunidades de mejora en respuesta a cambios en el entorno organizacional, circunstancias empresariales, condiciones legales o entorno técnico. Debe tener en cuenta resultados de revisiones de gestión.',
                            other: ''
                        }
                    ]
                },
                {
                    section: 'B.3 Organización interna',
                    objetivo: 'Establecer responsabilidad dentro de la organización para mantener su enfoque responsable en implementación, operación y gestión de sistemas de IA.',
                    subsections: [
                        {
                            id: 'B.3.2',
                            title: 'Funciones y responsabilidades de la IA',
                            control: 'Los roles y responsabilidades de IA deben definirse y asignarse según las necesidades de la organización.',
                            guidance: 'Definir roles es fundamental para garantizar rendición de cuentas. La organización debe considerar políticas de IA, objetivos y riesgos identificados al asignar roles. Ejemplos de áreas: gestión de riesgos, evaluaciones de impacto, gestión de activos y recursos, gestión de calidad de datos (todo el ciclo de vida), supervisión humana, seguridad, privacidad, desarrollo, actuación. Las responsabilidades deben definirse al nivel apropiado.',
                            other: ''
                        },
                        {
                            id: 'B.3.3',
                            title: 'Notificación de inquietudes',
                            control: 'La organización debe definir e implementar un proceso para informar inquietudes sobre el rol de la organización con respecto a un sistema de IA a lo largo de su ciclo de vida.',
                            guidance: 'El mecanismo debe: a) ofrecer opciones de confidencialidad o anonimato, b) estar disponible y promovido entre empleados y contratados, c) contar con personal calificado, d) estipular facultades de investigación y resolución adecuadas, e) establecer mecanismos para informar y escalar a gerencia oportunamente, f) prever protección contra represalias, g) proporcionar informes cumpliendo con confidencialidad y anonimato, h) proporcionar mecanismos de respuesta en plazo adecuado.',
                            other: 'ISO 37002 proporciona orientación adicional. NOTA: La organización puede utilizar mecanismos de informes existentes.'
                        }
                    ]
                },
                {
                    section: 'B.4 Recursos para sistemas de IA',
                    objetivo: 'Garantizar que la organización rinda cuentas de los recursos (incluidos componentes y activos del sistema de IA) para comprender y abordar plenamente los riesgos e impactos.',
                    subsections: [
                        {
                            id: 'B.4.2',
                            title: 'Documentación de recursos',
                            control: 'La organización debe identificar y documentar los recursos relevantes necesarios para las actividades en determinadas etapas del ciclo de vida del sistema de IA.',
                            guidance: 'Los recursos pueden incluir: recursos de datos (datos used in en cualquier etapa), recursos humanos (personas con experiencia necesaria), recursos informáticos y del sistema (hardware, almacenamiento), recursos de herramientas (algoritmos, modelos, herramientas de IA). La documentación puede usar diagramas de flujo de datos o arquitectura del sistema para fundamentar evaluaciones de impacto. También ayuda a determinar disponibilidad de recursos.',
                            other: 'Los recursos pueden ser proporcionados por la propia organización, clientes o terceros.'
                        },
                        {
                            id: 'B.4.3',
                            title: 'Recursos de datos',
                            control: 'Como parte de la identificación de recursos, la organización debe documentar información sobre los recursos de datos utilizados para el sistema de IA.',
                            guidance: 'La documentación debe incluir: uso previsto de datos, categorías de datos (ISO/IEC 19944-1), para ML las categorías (entrenamiento, validación, prueba, producción), calidad de datos (ISO/IEC 5259 series), procedencia, fecha de última actualización, problemas de sesgo conocidos o potenciales, proceso de etiquetado, preparación de datos, políticas de retención y eliminación.',
                            other: ''
                        },
                        {
                            id: 'B.4.4',
                            title: 'Recursos de herramientas',
                            control: 'Como parte de la identificación de recursos, la organización debe documentar información sobre los recursos de herramientas utilizados para el sistema de IA.',
                            guidance: 'Los recursos de herramientas para sistemas de IA (especialmente ML) pueden incluir: tipos de algoritmos y modelos de ML, métodos de evaluación, herramientas para ayudar al desarrollo de modelos, herramientas o procesos de acondicionamiento de datos, herramientas de aprovisionamiento de recursos, métodos de optimización, software y hardware para diseño, desarrollo e implementación.',
                            other: 'ISO/IEC 23053 proporciona orientación detallada sobre tipos, métodos y enfoques para recursos de herramientas de ML.'
                        },
                        {
                            id: 'B.4.5',
                            title: 'Recursos del sistema y computacionales',
                            control: 'Como parte de la identificación de recursos, la organización debe documentar información sobre el sistema y recursos informáticos utilizados para el sistema de IA.',
                            guidance: 'La información puede incluir: recursos de procesamiento (red y almacenamiento), dónde se encuentran (en instalaciones, nube o borde), requisitos de recursos del sistema, impacto del hardware utilizado (impacto ambiental por uso o fabricación, o costo de uso). Pueden requerirse diferentes recursos para mejora continua. Desarrollo, implementación y operación pueden tener diferentes necesidades.',
                            other: 'ISO/IEC 22989 describe consideraciones sobre recursos del sistema.'
                        },
                        {
                            id: 'B.4.6',
                            title: 'Recursos humanos',
                            control: 'Como parte de la identificación de recursos, documentar información sobre recursos humanos y sus competencias para desarrollo, implementación, operación, gestión de cambios, mantenimiento, transferencia, desmantelamiento, verificación e integración.',
                            guidance: 'La organización debe considerar experiencia diversa e incluir tipos de roles necesarios (por ejemplo, grupos demográficos relacionados con conjuntos de datos). Ejemplos: científicos de datos, expertos en confiabilidad (seguridad, protección, privacidad), funciones relacionadas con supervisión humana, investigadores y especialistas en IA y expertos en el dominio relevante. Pueden ser necesarios distintos recursos en distintas etapas del ciclo de vida.',
                            other: ''
                        }
                    ]
                },
                {
                    section: 'B.5 Evaluación de impactos',
                    objetivo: 'Evaluar impactos del sistema en individuos, grupos y sociedades a lo largo del ciclo de vida.',
                    subsections: [
                        { id: 'B.5.2', title: 'Proceso de evaluación de impacto', control: 'Establecer proceso para evaluar consecuencias potenciales derivadas del sistema de IA.', guidance: 'Procedimientos: 1) identificación, 2) análisis, 3) evaluación, 4) tratamiento, 5) documentación. Considerar: criticidad del propósito, complejidad de tecnología, sensibilidad de datos. Afecta: derechos humanos, situación jurídica, bienestar físico/psicológico.', other: 'ISO/IEC 23894 describe análisis de impacto.' },
                        { id: 'B.5.3', title: 'Documentación de evaluaciones', control: 'Documentar y conservar resultados de evaluaciones durante período definido.', guidance: 'Documentar: uso previsto/mal uso, grupos demográficos, fallos previsibles, papel de humanos, impactos positivos/negativos, complejidad. Actualizar según necesidad.', other: '' },
                        { id: 'B.5.4', title: 'Impacto en individuos/grupos', control: 'Evaluar y documentar impactos potenciales en individuos o grupos.', guidance: 'Considerar: políticas, objetivos, grupos vulnerables. Áreas: equidad, responsabilidad, seguridad, privacidad, transparencia, accesibilidad, empleo.', other: '' },
                        { id: 'B.5.5', title: 'Impactos sociales', control: 'Evaluar y documentar impactos sociales a lo largo del ciclo de vida.', guidance: 'Ejemplos: económicos, gobierno, sostenibilidad ambiental, normas y cultura, salud, derechos humanos. Considerar uso indebido o positivo.', other: 'ISO/IEC TR 24368 proporciona descripción de preocupaciones éticas.' }
                    ]
                },
                {
                    section: 'B.6 Ciclo de vida del sistema',
                    objetivo: 'Identificar objetivos e implementar procesos para diseño y desarrollo responsable.',
                    subsections: [
                        { id: 'B.6.1.2', title: 'Objetivos para desarrollo responsable', control: 'Identificar y documentar objetivos para guiar desarrollo responsable.', guidance: 'Si "equidad" es objetivo, incorporar en: especificación requisitos, adquisición datos, entrenamiento, V&V. Sistemas en salud/vehículos requieren considerar resultados positivos/negativos.', other: 'Anexo C proporciona ejemplos. Técnicas IA mejoran seguridad.' },
                        { id: 'B.6.1.3', title: 'Procesos para diseño responsable', control: 'Definir y documentar procesos específicos para diseño y desarrollo responsable.', guidance: 'Considerar: etapas ciclo vida, experiencia requerida, evaluaciones impacto, aprobaciones, control cambios, pruebas, criterios liberación, supervisión humana, reglas datos capacitación, participación partes.', other: '' },
                        { id: 'B.6.2.2', title: 'Requisitos y especificaciones', control: 'Especificar y documentar requisitos para nuevos sistemas o mejoras.', guidance: 'Requisitos deben abarcar todo ciclo vida. Revisar si no funciona según previsto. Documentar justificación desarrollo: ¿Por qué? (negocio, cliente, política), ¿Cómo entrenar modelo?', other: 'ISO/IEC 5338, ISO 9241-210.' },
                        { id: 'B.6.2.3', title: 'Documentación de diseño', control: 'Documentar diseño basado en objetivos, requisitos y criterios.', guidance: 'Opciones diseño: algoritmo/modelo, enfoque aprendizaje, calidad datos, componentes hardware/software, interfaz, interacción humanos, interoperabilidad. Mantener documentación final.', other: '' },
                        { id: 'B.6.2.4', title: 'Verificación y validación', control: 'Definir medidas de V&V y criterios para su uso.', guidance: 'Medidas: metodologías prueba, datos prueba, evaluación modelos, amenazas seguridad (envenenamiento datos, robo modelos). Evaluar según criterios.', other: 'ISO/IEC TR 24029-1 sobre robustez redes neuronales.' },
                        { id: 'B.6.2.5', title: 'Implementación', control: 'Documentar plan implementación y garantizar cumplimiento de requisitos.', guidance: 'Considerar: desarrollo local/nube, componentes separados, criterios lanzamiento (V&V aprobadas, métricas cumplidas, pruebas usuario, aprobaciones gerencia), perspectivas partes interesadas.', other: '' },
                        { id: 'B.6.2.6', title: 'Operación y monitoreo', control: 'Definir elementos para funcionamiento continuo: supervisión, reparaciones, actualizaciones, soporte.', guidance: 'Monitorización: errores/fallos, rendimiento. Criterios: tasas error, duración, éxito, confianza. Aprendizaje continuo requiere supervisión. Reparaciones: respuestas a errores. Actualizaciones: evolución, cumplimiento. Soporte: contacto ayuda, reportes, acuerdos.', other: 'ISO/IEC 23053, ISO/IEC 22989.' },
                        { id: 'B.6.2.7', title: 'Documentación técnica', control: 'Determinar documentación técnica necesaria para partes interesadas y proporcionarla.', guidance: 'Elementos: descripción sistema, limitaciones técnicas, instrucciones uso, arquitectura, información datos, suposiciones, decisiones diseño, registros V&V, gestión riesgos, evaluación impacto, capacidades monitoreo. Actualizada, precisa, aprobada.', other: '' },
                        { id: 'B.6.2.8', title: 'Registro de eventos', control: 'Garantizar registro automático de eventos durante operación.', guidance: 'Registro: trazabilidad funcionalidad, detección rendimiento fuera condiciones, supervisión salud, procesos fallos, cambios. Documentar: funciones personal, plan gestión fallos (reversión, desactivación, actualización, notificación), procedimientos estándar, actualizaciones. Registros eventos: hora/fecha uso, datos producción, salidas fuera rango. Conservar según políticas/requisitos legales. Habilitar registro mínimo cuando sistema en uso.', other: 'Sistemas biométricos: requisitos adicionales según jurisdicción. ISO/IEC 22989.' }
                    ]
                },
                {
                    section: 'B.7 Datos para sistemas de IA',
                    objetivo: 'Comprender papel e impactos de datos en sistemas de IA a lo largo de ciclos de vida.',
                    subsections: [
                        { id: 'B.7.2', title: 'Datos para desarrollo y mejora', control: 'Definir, documentar e implementar procesos de gestión de datos.', guidance: 'Gestión incluye: representatividad datos entrenamiento, exactitud e integridad, implicaciones privacidad/seguridad (datos sensibles), transparencia y explicabilidad (procedencia), amenazas seguridad/protección, calidad datos. Diferentes categorías de fuentes según alcance. Sistemas ML necesitan datos entrenamiento, validación, prueba.', other: 'ISO/IEC 22989.' },
                        { id: 'B.7.3', title: 'Adquisición de datos', control: 'Determinar y documentar detalles sobre adquisición y selección de datos.', guidance: 'Detalles: categorías datos, fuentes (internos, comprados, abiertos, sintéticos), características fuente, cantidad, datos demográficos (sesgos), tratamiento previo, metadatos, derechos datos (PII, copyright), procedencia. Especialistas con habilidades interdisciplinarias.', other: 'ISO/IEC 19944-1.' },
                        { id: 'B.7.4', title: 'Calidad de datos', control: 'Definir requisitos de calidad y garantizar que datos cumplan requisitos.', guidance: 'Calidad impacta validez resultados. ISO/IEC 25024: grado que características satisfacen necesidades. Para ML supervisado: definir, medir, mejorar calidad datos entrenamiento, validación, prueba, producción. Datos adecuados para propósito. Considerar impacto sesgo en rendimiento e imparcialidad, ajustar modelo y datos.', other: 'ISO/IEC 5259 series. ISO/IEC TR 24027 sobre sesgos.' },
                        { id: 'B.7.5', title: 'Procedencia de datos', control: 'Definir proceso para registrar procedencia de datos a lo largo de ciclos de vida.', guidance: 'ISO 8000-2: registro puede incluir creación, actualización, transcripción, abstracción, validación, transferencia control. También intercambio y transformaciones. Según fuente, contenido, contexto, considerar implementar medidas para verificar procedencia.', other: '' },
                        { id: 'B.7.6', title: 'Preparación de datos', control: 'Definir criterios para seleccionar métodos de preparación de datos.', guidance: 'Datos necesitan preparación. Algoritmos ML no toleran entradas faltantes/incorrectas, distribución normal, escalas variables. Métodos: limpieza, imputación, codificación, exploración estadística, metadatos, normalización, escalamiento, etiquetado. Preparación incorrecta provoca errores. Documentar criterios y métodos usados.', other: 'ISO/IEC 5259 series, ISO/IEC 23053.' }
                    ]
                },
                {
                    section: 'B.8 Información para partes interesadas',
                    objetivo: 'Garantizar que partes tengan información para comprender y evaluar riesgos e impactos.',
                    subsections: [
                        { id: 'B.8.2', title: 'Documentación e información para usuarios', control: 'Determinar y proporcionar información necesaria a usuarios.', guidance: 'Usuarios deben comprender: cómo funciona, propósito, usos previstos, potencial perjuicio/beneficio. Información para técnicos (administradores). Comprender necesidades diferentes partes. Accesible (fácil buscar, funciones accesibilidad). Incluye: interacción con IA, finalidad, cómo interactuar, cómo anular, supervisión humana, precisión/rendimiento, evaluación impacto, requisitos técnicos, limitaciones/vida útil, actualizaciones/cambios, revisiones beneficios, contacto, materiales educativos. Proporcionar en: instrucciones, alertas, página web. Validar acceso y que sea completa, actualizada, precisa. Criterios: uso previsto, uso indebido previsible, experiencia usuario, impacto.', other: 'Considerar controles Tabla A.1.' },
                        { id: 'B.8.3', title: 'Informes externos', control: 'Determinar y documentar obligaciones de informar a partes interesadas.', guidance: 'Jurisdicción puede exigir compartir información con autoridades. Conocer requisitos jurisdiccionales. Información compartida a cliente s/autoridades dentro plazo. Puede incluir: documentación técnica (datos entrenamiento/validación/pruebas, opciones algorítmicas, V&V), evaluaciones impacto, riesgos, registros.', other: '' },
                        { id: 'B.8.4', title: 'Comunicación de incidentes', control: 'Determinar y documentar plan para comunicar incidentes a usuarios.', guidance: 'Incidentes: específicos sistema o seguridad/privacidad información (filtración datos). Comprender obligaciones notificación según contexto. Requisitos legales/regulatorios pueden especificar: tipos incidentes, plazo notificación, autoridades, detalles. Integrar actividades respuesta e informes IA en gestión incidentes organizacional, considerar requisitos únicos sistemas IA/componentes (violación PII en datos entrenamiento).', other: 'ISO/IEC 27001, ISO/IEC 27701.' },
                        { id: 'B.8.5', title: 'Información para partes interesadas', control: 'Proporcionar capacidades para que partes informen impactos adversos.', guidance: 'Monitorear funcionamiento para detectar problemas/fallas. Brindar capacidades a usuarios/partes externas para reportar impactos adversos (injusticias).', other: '' }
                    ]
                },
                {
                    section: 'B.9 Uso de sistemas de IA',
                    objetivo: 'Garantizar uso responsable de sistemas de IA según políticas organizacionales.',
                    subsections: [
                        { id: 'B.9.2', title: 'Procesos para uso responsable', control: 'Definir y documentar procesos para uso responsable de sistemas.', guidance: 'Según contexto, consideraciones para determinar si utilizar sistema particular. Desarrollado por organización o tercero, tener claras consideraciones y desarrollar políticas. Ejemplos: requisitos legales, abastecimiento aprobado, costes (seguimiento/mantenimiento), riesgos. Políticas para otros sistemas/activos pueden incorporarse.', other: '' },
                        { id: 'B.9.3', title: 'Objetivos para uso responsable', control: 'Identificar y documentar objetivos para guiar uso responsable.', guidance: 'Objetivos según contexto: equidad, robustez/redundancia, fiabilidad, seguridad, privacidad, responsabilidad, transparencia, explicabilidad, accesibilidad. Implementar mecanismos para alcanzar (solución terceros/desarrollada internamente). Determinar etapas ciclo vida para supervisión humana. Puede incluir: garantizar supervisión según necesidad, considerar si toma decisiones automatizada adecuada, supervisar rendimiento (precisión), revisores humanos verificar resultados (autoridad anular), informar inquietudes a partes sobre resultados/impacto, informar cambios rendimiento/capacidad. Personal supervisión: informado, capacitado, comprender instrucciones/documentación. Supervisión complementa monitorización automatizada.', other: 'Anexo C: ejemplos objetivos.' },
                        { id: 'B.9.4', title: 'Uso previsto del sistema', control: 'Asegurar uso según usos previstos y documentación.', guidance: 'Implementar según instrucciones y documentación (B.8.2). Puede requerir recursos específicos, supervisión humana (B.9.3). Datos usados deben coincidir con documentación. Supervisar funcionamiento (B.6.2.6). Si implementación correcta genera inquietudes sobre impacto/requisitos legales, comunicar a personal/proveedor. Conservar registros eventos/documentación para demostrar uso previsto. Plazo conservación: uso previsto, políticas retención, requisitos legales. Usos para fines distintos/formas no previstas: considerar idoneidad.', other: '' }
                    ]
                },
                {
                    section: 'B.10 Relaciones con terceros y clientes',
                    objetivo: 'Garantizar comprensión de responsabilidades y rendición de cuentas, distribución adecuada de riesgos con terceros.',
                    subsections: [
                        { id: 'B.10.2', title: 'Asignación de responsabilidades', control: 'Asegurar distribución de responsabilidades entre organización, socios, proveedores, clientes, terceros.', guidance: 'Responsabilidades divididas entre: quienes proporcionan datos, algoritmos/modelos, quienes desarrollan/utilizan, quienes son responsables ante partes. Documentar todas partes en ciclo vida, roles, responsabilidades. Datos con PII: responsabilidades entre encargados/responsables tratamiento. Suministrar sistema a tercero: enfoque responsable desarrollo. Consultar B.6. Proporcionar documentación (B.6.2.7, B.8.2) a partes/tercero.', other: 'ISO/IEC 29100 sobre responsables/encargados tratamiento. PII: ISO/IEC 27701. Organización puede asumir rol responsable PII (corresponsable), encargado o ambos.' },
                        { id: 'B.10.3', title: 'Proveedores', control: 'Establecer proceso para garantizar que uso de servicios/productos de proveedores se alinee con enfoque responsable.', guidance: 'Usar proveedores: obtención datos, algoritmos, modelos ML, componentes, sistema completo. Considerar: tipos proveedores, qué suministran, nivel riesgo para sistema/organización al determinar selección, requisitos impuestos, seguimiento/evaluación continuos. Si sistema/componentes no funcionan según previsto o afectan personas/grupos/sociedades inadecuadamente: exigir medidas correctivas, colaborar. Asegurar proveedor entregue documentación apropiada (B.6.2.7, B.8.2). Documentar integración sistema/componentes.', other: '' },
                        { id: 'B.10.4', title: 'Clientes', control: 'Asegurar enfoque responsable considere expectativas y necesidades de clientes.', guidance: 'Comprender expectativas/necesidades al suministrar producto/servicio (organización como proveedora). Requisitos para producto/servicio en diseño/ingeniería, o requisitos contractuales/acuerdos uso. Diversos tipos relaciones con clientes, cada una con necesidades/expectativas diferentes. Comprender naturaleza compleja relaciones proveedores-clientes, dónde recae responsabilidad satisfaciendo necesidades/expectativas. Ejemplo: identificar riesgos relacionados con uso por cliente, tratar brindando información adecuada para que cliente trate riesgos. Sistema válido para dominio uso: comunicar límites dominio (B.6.2.7, B.8.2).', other: '' }
                    ]
                }
            ],
            annexC: {
                title: 'Anexo C: Objetivos organizacionales y fuentes de riesgo relacionados con IA',
                intro: 'Este anexo describe posibles objetivos organizacionales, fuentes de riesgo y descripciones que la organización puede considerar al gestionar riesgos. No pretende ser exhaustivo ni aplicable a todas las organizaciones. La organización debe determinar los objetivos y fuentes de riesgo relevantes. ISO/IEC 23894 proporciona información más detallada.',
                objectives: [
                    { id: 'C.2.1', name: 'Rendición de cuentas', desc: 'El uso de IA puede transformar marcos de rendición de cuentas existentes. Donde antes las personas debían rendir cuentas por sus acciones, ahora estas pueden estar respaldadas por un sistema de IA o basarse en él.' },
                    { id: 'C.2.2', name: 'Experiencia en IA', desc: 'Se necesita una selección de especialistas dedicados con habilidades interdisciplinarias y experiencia en la evaluación, desarrollo e implementación de sistemas de IA.' },
                    { id: 'C.2.3', name: 'Disponibilidad y calidad de datos', desc: 'Los sistemas de IA basados en ML necesitan entrenamiento, validación y datos de prueba para entrenar y verificar los sistemas para el comportamiento previsto.' },
                    { id: 'C.2.4', name: 'Impacto ambiental', desc: 'El uso de la IA puede tener impactos positivos y negativos en el medio ambiente (consumo computacional alto tiene consecuencias para sostenibilidad; también se puede usar IA para mejorar sostenibilidad).' },
                    { id: 'C.2.5', name: 'Equidad', desc: 'La aplicación inadecuada de sistemas de IA para toma de decisiones automatizada puede ser injusta para personas o grupos de personas específicas.' },
                    { id: 'C.2.6', name: 'Mantenibilidad', desc: 'Relacionada con la capacidad de la organización para manejar modificaciones del sistema de IA para corregir defectos o adaptarse a nuevos requisitos.' },
                    { id: 'C.2.7', name: 'Privacidad', desc: 'El uso indebido o divulgación de datos personales y sensibles (ej. registros médicos) pueden tener efectos perjudiciales para los interesados.' },
                    { id: 'C.2.8', name: 'Seguridad (Security)', desc: 'En el contexto de IA y ML, se deben considerar nuevas cuestiones de seguridad más allá de preocupaciones clásicas de seguridad de información y del sistema.' },
                    { id: 'C.2.9', name: 'Seguridad (Safety)', desc: 'Los sistemas de IA se están usando en situaciones donde averías pueden provocar la muerte o lesiones a personas (vehículos autónomos, equipos de trabajo persona-máquina, diagnóstico médico).' },
                    { id: 'C.2.10', name: 'Transparencia y Explicabilidad', desc: 'Transparencia se relaciona tanto con características de la organización como con los sistemas. Explicabilidad se relaciona con la explicación de factores importantes que influyen en resultados del sistema de IA.' }
                ],
                risks: [
                    { id: 'C.3.1', name: 'Automatización', desc: 'El nivel de automatización puede  tener impacto en áreas de preocupación como seguridad, equidad o protección.' },
                    { id: 'C.3.2', name: 'Datos de entrenamiento', desc: 'La calidad de datos utilizados para ML y el proceso utilizado para recopilarlos pueden ser fuentes de riesgo, afectando objetivos como seguridad y solidez (problemas en calidad o envenenamiento de datos).' },
                    { id: 'C.3.3', name: 'Complejidad', desc: 'Cuando sistemas de IA operan en entornos complejos donde el rango de situaciones es amplio, puede haber incertidumbre sobre rendimiento y, por tanto, una fuente de riesgo (ej. entorno de conducción autónoma).' },
                    { id: 'C.3.4', name: 'Información inadecuada', desc: 'La incapacidad de proporcionar información adecuada a partes interesadas puede ser fuente de riesgo (en términos de confiabilidad y responsabilidad de la organización).' }
                ]
            },
            annexD: {
                title: 'Anexo D: Uso entre dominios y sectores (Integración)',
                intro: 'La norma ISO/IEC 42001 está diseñada para integrarse con otros sistemas de gestión existentes en la organización, siguiendo la Estructura de Alto Nivel (HLS). Esto permite que diferentes estándares de gestión trabajen juntos de manera coherente.',
                integration: [
                    { std: 'ISO/IEC 27001', sector: 'Seguridad de la Información', desc: 'ISO 42001 complementa el SGSI abordando vulnerabilidades específicas de IA (ej. envenenamiento de datos, extracción de modelos, ataques adversarios) que no son cubiertas completamente por controles tradicionales de ciberseguridad. Controles A.6 y A.7 de ISO 42001 se alinean con A.8 y A.12 de ISO 27001.' },
                    { std: 'ISO/IEC 27701', sector: 'Gestión de Privacidad', desc: 'Crítico cuando la IA procesa datos personales (PII). Control A.7 (Datos para sistemas de IA) y A.5 (Evaluación de impactos) de ISO 42001 deben alinearse con requisitos de privacidad. Particularmente relevante para cumplimiento con GDPR, CCPA, y leyes de protección de datos.' },
                    { std: 'ISO 9001', sector: 'Gestión de Calidad', desc: 'Asegura consistencia y calidad en el desarrollo de sistemas de IA. El ciclo de vida de IA (Control A.6) se integra en los procesos operativos de calidad. Especialmente relevante para verificación y validación (V&V) de modelos de IA en producción.' },
                    { std: 'ISO 31000 / ISO/IEC 23894', sector: 'Gestión de Riesgos de IA', desc: 'ISO/IEC 23894 proporciona directrices específicas para aplicar el proceso de ISO 31000 a riesgos de IA, alimentando la cláusula 6.1 de ISO 42001. Anexo C de ISO 42001 hace referencia directa a objetivos y fuentes de riesgo de ISO 23894.' },
                    { std: 'ISO 22301', sector: 'Continuidad del Negocio', desc: 'Cuando sistemas de IA son críticos para la operación del negocio, ISO 22301 ayuda a planificar la continuidad ante fallas o interrupciones de sistemas de IA. Control A.6.5 (Despliegue) y A.6.6 (Monitoreo) de ISO 42001 alimentan planes de continuidad.' },
                    { std: 'ISO 26000', sector: 'Responsabilidad Social', desc: 'Principios de responsabilidad social se alinean con objetivos éticos de IA. Particularmente relevante para evaluación de impactos sociales (Control A.5) y garantizar que sistemas de IA no generen daños sociales o discriminación.' },
                    { std: 'ISO/IEC 38500', sector: 'Gobernanza Corporativa de TI', desc: 'Proporciona marco de gobernanza para toma de decisiones sobre IA a nivel de alta dirección. Control A.3 (Organización interna) y cláusula 5 (Liderazgo) de ISO 42001  se alinean con principios de gobernanza de ISO 38500.' },
                    { std: 'Estándares Sectoriales', sector: 'Salud, Finanzas, Automotriz', desc: 'En sector salud: IEC 62304 (software médico), ISO 13485 (dispositivos médicos). En finanzas: PCI-DSS, requisitos de auditoría bancaria. En automotriz: ISO 26262 (seguridad funcional), ISO/SAE 21434 (ciberseguridad). Estos estándares específicos complementan ISO 42001 en sus dominios respectivos.' }
                ]
            }
        };

        // --- STATE ---
        let state = {
            activeTab: 'dashboard', // 'dashboard' | 'clauses' | 'clauses-dashboard' | 'annex-a-dashboard' | 'annexes' | 'audit' | 'notebook'
            activeSection: '4',
            activeAnnexTab: 'A', // 'A' | 'B' | 'C' | 'D'
            expandedItems: {},
            chatOpen: false,
            chatExpanded: false,
            messages: [{ role: 'system', text: 'Hola, soy tu asistente experto en ISO 42001. ¿En qué puedo ayudarte?' }],
            apiKey: localStorage.getItem('iso_gemini_api_key') || '',
            aiContext: null,
            // NotebookLM State
            notebookSources: [],
            notebookUrl: localStorage.getItem('iso_notebook_url') || '',
            notebookMode: 'internal', // 'internal' | 'external'
            notebookResearcherNotes: localStorage.getItem('iso_notebook_notes') || '',
            notebookConversation: [],
            // File attachment state
            attachedFile: null,
            attachedFileContent: null,
            // Audit module state
            auditDocuments: [],
            auditImages: [],
            auditNotes: '',
            auditFocus: '',
            auditReport: null,
            auditCharts: null,
            auditGenerating: false,
            auditExtendedAnalysis: null,
            auditNotebookUrl: '',
            // New audit features
            auditChecklist: {}, // { controlCode: { checked: boolean, notes: string, evidence: [] } }
            auditTemplate: 'internal', // 'internal' | 'external' | 'followup'
            auditHistory: [], // Previous audits for comparison
            auditCurrentStep: 0, // For step-by-step assistant
            auditRiskMatrix: [], // Risk assessments
            evidencesByControl: {} // { controlCode: [evidences] }
        };

        // --- RENDER FUNCTIONS ---

        function init() {
            lucide.createIcons();
            renderSidebar();
            renderMainContent();
            renderChatMessages();
            applyTheme();
            updateApiKeyStatus();
            updateTopNavigation();
            const apiKeyInput = document.getElementById('api-key-input');
            if (apiKeyInput) apiKeyInput.value = state.apiKey;

            // Paste event listener for images
            const chatInput = document.getElementById('general-chat-input');
            if (chatInput) {
                chatInput.addEventListener('paste', handlePaste);
            }
        }

        function renderSidebar() {
            const nav = document.getElementById('clauses-nav');
            nav.innerHTML = isoData.clauses.map(clause => {
                const isActive = state.activeTab === 'clauses' && state.activeSection === clause.id;
                const activeClass = isActive ? 'bg-blue-600 text-white font-medium shadow-md shadow-blue-900/30 translate-x-1' : 'hover:bg-slate-800 hover:text-white hover:translate-x-1 text-slate-500';
                const iconClass = isActive ? 'text-blue-200' : 'text-slate-500 group-hover:text-white';

                return `
                <li>
                    <button onclick="navigateTo('clauses', '${clause.id}')" class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition-all duration-200 group ${activeClass}">
                        <i data-lucide="${clause.icon}" class="${iconClass} w-5 h-5"></i>
                        <span class="truncate text-left">${clause.title}</span>
                    </button>
                </li>`;
            }).join('');

            // Update annexes button
            const annexBtn = document.getElementById('nav-annexes');
            if (state.activeTab === 'annexes') {
                annexBtn.classList.add('bg-emerald-600', 'text-white', 'font-medium', 'shadow-md', 'translate-x-1');
                annexBtn.classList.remove('text-slate-500');
            } else {
                annexBtn.classList.remove('bg-emerald-600', 'text-white', 'font-medium', 'shadow-md', 'translate-x-1');
                annexBtn.classList.add('text-slate-500');
            }

            // Update notebook button
            const notebookBtn = document.getElementById('nav-notebook');
            if (state.activeTab === 'notebook') {
                notebookBtn.classList.add('bg-purple-600', 'text-white', 'font-medium', 'shadow-md', 'translate-x-1');
                notebookBtn.classList.remove('text-slate-500');
            } else {
                notebookBtn.classList.remove('bg-purple-600', 'text-white', 'font-medium', 'shadow-md', 'translate-x-1');
                notebookBtn.classList.add('text-slate-500');
            }

            // Update audit button
            const auditBtn = document.getElementById('nav-audit');
            if (state.activeTab === 'audit') {
                auditBtn.classList.add('bg-emerald-600', 'text-white', 'font-medium', 'shadow-md', 'translate-x-1');
                auditBtn.classList.remove('text-slate-500');
            } else {
                auditBtn.classList.remove('bg-emerald-600', 'text-white', 'font-medium', 'shadow-md', 'translate-x-1');
                auditBtn.classList.add('text-slate-500');
            }

            lucide.createIcons();
        }

        function renderMainContent() {
            const container = document.getElementById('content-area');
            const breadcrumbSection = document.getElementById('breadcrumb-section');
            const breadcrumbTitle = document.getElementById('breadcrumb-title');

            if (state.activeTab === 'dashboard') {
                breadcrumbSection.innerText = 'Inicio';
                breadcrumbTitle.innerText = 'Composición de la Norma';
                renderDashboard(container);
            } else if (state.activeTab === 'clauses-dashboard') {
                breadcrumbSection.innerText = 'Dashboard';
                breadcrumbTitle.innerText = 'Cláusulas 4-10';
                renderClausesDashboard(container);
            } else if (state.activeTab === 'annex-a-dashboard') {
                breadcrumbSection.innerText = 'Dashboard';
                breadcrumbTitle.innerText = 'Anexo A - Controles';
                renderAnnexADashboard(container);
            } else if (state.activeTab === 'clauses') {
                const section = isoData.clauses.find(c => c.id === state.activeSection);
                breadcrumbSection.innerText = 'Cuerpo Normativo';
                breadcrumbTitle.innerText = section.title;

                let html = `
                    <div class="space-y-8 animate-fadeIn pb-24">
                        <header class="border-b pb-4 mb-6 border-slate-200">
                            <h2 class="text-3xl font-bold text-slate-800 flex items-center gap-3">
                                <span class="p-3 bg-blue-100 text-blue-700 rounded-xl shadow-sm"><i data-lucide="${section.icon}" class="w-6 h-6"></i></span>
                                ${section.title}
                            </h2>
                        </header>
                `;

                html += section.subsections.map(sub => {
                    // Check if subsection has nested subsections (e.g., 7.5.1, 7.5.2, 7.5.3)
                    if (sub.subsections) {
                        // Render nested subsections
                        return `
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-blue-900 mb-4">${sub.title}</h3>
                            ${sub.subsections.map(nestedSub => {
                            const contentString = JSON.stringify(nestedSub.content).replace(/"/g, '&quot;');
                            return `
                                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 group transition-all hover:shadow-md">
                                    <div class="p-4 border-b border-slate-100 bg-slate-50 flex items-center justify-between">
                                        <h4 class="text-lg font-bold text-blue-900">${nestedSub.title}</h4>
                                        <div class="flex items-center gap-2">
                                            <button onclick="openAiAssistant('${nestedSub.title}', ${contentString})" class="flex items-center gap-1.5 px-3 py-1.5 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-full text-xs font-bold shadow-sm hover:shadow-md hover:scale-105 transition-all">
                                                <i data-lucide="sparkles" class="w-3 h-3"></i> <span>Analizar</span>
                                            </button>
                                            <i data-lucide="file-check" class="w-[18px] h-[18px] text-green-500 opacity-50 group-hover:opacity-100 transition-opacity"></i>
                                        </div>
                                    </div>
                                    <div class="p-6">
                                        ${nestedSub.content.map((item, idx) => renderContentItem(item, idx, nestedSub.id)).join('')}
                                    </div>
                                </div>`;
                        }).join('')}
                        </div>`;
                    } else {
                        // Render regular subsection with content
                        const contentString = JSON.stringify(sub.content).replace(/"/g, '&quot;');
                        return `
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 group transition-all hover:shadow-md">
                            <div class="p-4 border-b border-slate-100 bg-slate-50 flex items-center justify-between">
                                <h3 class="text-lg font-bold text-blue-900">${sub.title}</h3>
                                <div class="flex items-center gap-2">
                                    <button onclick="openAiAssistant('${sub.title}', ${contentString})" class="flex items-center gap-1.5 px-3 py-1.5 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-full text-xs font-bold shadow-sm hover:shadow-md hover:scale-105 transition-all">
                                        <i data-lucide="sparkles" class="w-3 h-3"></i> <span>Analizar</span>
                                    </button>
                                    <i data-lucide="file-check" class="w-[18px] h-[18px] text-green-500 opacity-50 group-hover:opacity-100 transition-opacity"></i>
                                </div>
                            </div>
                            <div class="p-6">
                                ${sub.content.map((item, idx) => renderContentItem(item, idx, sub.id)).join('')}
                            </div>
                        </div>`;
                    }
                }).join('');

                html += `</div>`;
                container.innerHTML = html;

            } else if (state.activeTab === 'annexes') { // Annexes
                breadcrumbSection.innerText = 'Anexos Técnicos';
                breadcrumbTitle.innerText = `Anexo ${state.activeAnnexTab}`;

                // Render Tabs
                let html = `
                    <div class="flex flex-wrap gap-2 border-b border-slate-200 pb-1 mb-6">
                        ${['A', 'B', 'C', 'D'].map(tab => `
                            <button onclick="setAnnexTab('${tab}')" class="px-6 py-3 text-sm font-bold rounded-t-lg transition-all ${state.activeAnnexTab === tab ? 'bg-white border border-slate-200 border-b-white text-blue-600 shadow-[0_-2px_5px_rgba(0,0,0,0.02)] translate-y-[1px]' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'}">
                                Anexo ${tab}
                            </button>
                        `).join('')}
                    </div>
                    <div class="animate-fadeIn pb-24">
                `;

                if (state.activeAnnexTab === 'A') {
                    html += `
                        <div class="bg-emerald-50 border border-emerald-200 p-4 rounded-lg flex items-start gap-3 mb-6">
                            <i data-lucide="check-square" class="text-emerald-600 mt-1 w-5 h-5 shrink-0"></i>
                            <div>
                                <h3 class="font-bold text-emerald-900">Anexo A (Controles Normativos) + Guía B (Implementación)</h3>
                                <p class="text-sm text-emerald-800">Controles completos según ISO/IEC 42001:2023. Haz clic en <strong>"Ver Guía de Implementación"</strong> para ver el detalle del Anexo B correspondiente.</p>
                            </div>
                        </div>
                        <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-1">
                            ${isoData.annexA.map(cat => `
                                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                    <div class="bg-slate-100 p-3 border-b border-slate-200 font-bold text-slate-700">${cat.category}</div>
                                    <div class="divide-y divide-slate-100">
                                        ${cat.controls.map(ctrl => `
                                            <div class="p-4 hover:bg-slate-50 transition-colors group">
                                                <div class="flex gap-4">
                                                    <span class="bg-slate-200 text-slate-700 text-xs font-bold px-2 py-1 rounded h-fit shrink-0 font-mono">${ctrl.code}</span>
                                                    <div class="flex-1">
                                                        <div class="flex justify-between items-start">
                                                            <h4 class="font-bold text-slate-900 text-sm">${ctrl.name}</h4>
                                                            <button onclick="openAiAssistant('${ctrl.code} ${ctrl.name}', '${ctrl.desc} Guía: ${ctrl.guid}')" class="text-purple-600 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="sparkles" class="w-4 h-4"></i></button>
                                                        </div>
                                                        <p class="text-sm text-slate-600 mt-1 leading-relaxed">${ctrl.desc}</p>
                                                        <button onclick="toggleExpand('guide-${ctrl.code}')" class="mt-3 text-xs flex items-center gap-1 text-blue-600 font-bold hover:text-blue-800 transition-colors">
                                                            <i data-lucide="lightbulb" class="w-3.5 h-3.5"></i> ${state.expandedItems['guide-' + ctrl.code] ? 'Ocultar Guía (Anexo B)' : 'Ver Guía de Implementación (Anexo B)'}
                                                        </button>
                                                        ${state.expandedItems['guide-' + ctrl.code] ? `
                                                            <div class="mt-3 p-3 bg-blue-50 border border-blue-100 rounded-lg text-sm text-slate-700 animate-fadeIn relative">
                                                                <div class="absolute top-0 left-4 w-3 h-3 bg-blue-50 border-t border-l border-blue-100 transform rotate-45 -translate-y-1/2"></div>
                                                                <span class="font-bold block mb-1 text-blue-800 text-xs uppercase">Guía Anexo B:</span>
                                                                ${ctrl.guid}
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else if (state.activeAnnexTab === 'B') {
                    html += `
                        <div class="space-y-8">
                            ${isoData.annexB.map(section => `
                                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                    <h3 class="text-xl font-bold text-blue-900 mb-2">${section.section}</h3>
                                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 rounded">
                                        <p class="text-sm font-semibold text-blue-800 uppercase mb-1">Objetivo</p>
                                        <p class="text-sm text-slate-700">${section.objetivo}</p>
                                    </div>
                                    ${section.subsections.map(sub => {
                        const subContent = JSON.stringify({ control: sub.control, guidance: sub.guidance, other: sub.other }).replace(/"/g, '&quot;');
                        return `\r\n                                        <div class="border-l-4 border-blue-500 pl-4 mb-6">
                                            <div class="flex items-start justify-between mb-2">
                                                <h4 class="font-bold text-slate-800 flex items-center gap-2">
                                                    <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-mono">${sub.id}</span>
                                                    ${sub.title}
                                                </h4>
                                                <button onclick="openAiAssistant('${sub.id}: ${sub.title}', ${subContent})" class="flex items-center gap-1.5 px-3 py-1.5 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-full text-xs font-bold shadow-sm hover:shadow-md hover:scale-105 transition-all shrink-0">
                                                    <i data-lucide="sparkles" class="w-3 h-3"></i> <span>Analizar</span>
                                                </button>
                                            </div>
                                            <div class="mt-3 space-y-3">
                                                <div>
                                                    <span class="text-xs font-bold text-blue-600 uppercase block mb-1">Control:</span>
                                                    <p class="text-sm text-slate-700 leading-relaxed">${sub.control}</p>
                                                </div>
                                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg">
                                                    <span class="text-xs font-bold text-blue-800 uppercase block mb-1">Guía de Implementación:</span>
                                                    <p class="text-sm text-slate-700 leading-relaxed">${sub.guidance}</p>
                                                </div>
                                                ${sub.other ? `
                                                    <div class="bg-slate-50 p-3 rounded">
                                                        <span class="text-xs font-bold text-slate-600 uppercase block mb-1">Otra Información:</span>
                                                        <p class="text-sm text-slate-600 italic">${sub.other}</p>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `}).join('')}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else if (state.activeAnnexTab === 'C') {
                    html += `
                        <div class="space-y-8">
                            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                <h3 class="font-bold text-blue-900">${isoData.annexC.title}</h3>
                                <p class="text-sm text-blue-800 mt-2">${isoData.annexC.intro}</p>
                            </div>
                            
                            <div>
                                <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2"><i data-lucide="target" class="w-5 h-5 text-blue-600"></i> C.2 Objetivos Organizacionales</h4>
                                <div class="grid md:grid-cols-2 gap-4">
                                    ${isoData.annexC.objectives.map(obj => {
                        const objContent = JSON.stringify({ name: obj.name, desc: obj.desc }).replace(/"/g, '&quot;');
                        return `
                                        <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                                            <div class="flex items-start justify-between gap-2 mb-2">
                                                <div class="flex items-start gap-2 flex-1">
                                                    <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-mono font-bold">${obj.id}</span>
                                                    <div class="font-bold text-slate-800">${obj.name}</div>
                                                </div>
                                                <button onclick="openAiAssistant('${obj.id}: ${obj.name}', ${objContent})" class="flex items-center gap-1 px-2 py-1 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-full text-xs font-bold shadow-sm hover:shadow-md hover:scale-105 transition-all shrink-0">
                                                    <i data-lucide="sparkles" class="w-3 h-3"></i>
                                                </button>
                                            </div>
                                            <div class="text-sm text-slate-600">${obj.desc}</div>
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>

                            <div>
                                <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-5 h-5 text-amber-500"></i> C.3 Fuentes de Riesgo de IA</h4>
                                <div class="grid md:grid-cols-2 gap-4">
                                    ${isoData.annexC.risks.map(risk => {
                            const riskContent = JSON.stringify({ name: risk.name, desc: risk.desc }).replace(/"/g, '&quot;');
                            return `
                                        <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm border-l-4 border-l-amber-400">
                                            <div class="flex items-start justify-between gap-2 mb-2">
                                                <div class="flex items-start gap-2 flex-1">
                                                    <span class="bg-amber-100 text-amber-700 px-2 py-1 rounded text-xs font-mono font-bold">${risk.id}</span>
                                                    <div class="font-bold text-slate-800">${risk.name}</div>
                                                </div>
                                                <button onclick="openAiAssistant('${risk.id}: ${risk.name}', ${riskContent})" class="flex items-center gap-1 px-2 py-1 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-full text-xs font-bold shadow-sm hover:shadow-md hover:scale-105 transition-all shrink-0">
                                                    <i data-lucide="sparkles" class="w-3 h-3"></i>
                                                </button>
                                            </div>
                                            <div class="text-sm text-slate-600">${risk.desc}</div>
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (state.activeAnnexTab === 'D') {
                    html += `
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
                            <h3 class="text-xl font-bold text-slate-800 mb-2">${isoData.annexD.title}</h3>
                            <p class="text-slate-600 mb-8 leading-relaxed">${isoData.annexD.intro}</p>
                            <div class="space-y-4">
                                ${isoData.annexD.integration.map(item => {
                        const itemContent = JSON.stringify({ std: item.std, sector: item.sector, desc: item.desc }).replace(/"/g, '&quot;');
                        return `
                                    <div class="p-4 bg-slate-50 rounded-lg border border-slate-100 hover:border-blue-200 hover:bg-blue-50/30 transition-all">
                                        <div class="flex items-start justify-between gap-3 mb-2">
                                            <div class="flex items-start gap-3 flex-1">
                                                <span class="font-mono font-bold text-blue-600 shrink-0">${item.std}</span>
                                                ${item.sector ? `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-semibold">${item.sector}</span>` : ''}
                                            </div>
                                            <button onclick="openAiAssistant('${item.std}: ${item.sector || 'Integración'}', ${itemContent})" class="flex items-center gap-1 px-2 py-1 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-full text-xs font-bold shadow-sm hover:shadow-md hover:scale-105 transition-all shrink-0">
                                                <i data-lucide="sparkles" class="w-3 h-3"></i>
                                            </button>
                                        </div>
                                        <div class="text-sm text-slate-700 leading-relaxed">${item.desc}</div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    `;
                }

                html += `</div>`;
                container.innerHTML = html;
            } else if (state.activeTab === 'audit') {
                breadcrumbSection.innerText = 'Herramientas';
                breadcrumbTitle.innerText = 'Auditoría Interna';

                let html = `
                    <div class="animate-fadeIn">
                        <div class="bg-gradient-to-r from-emerald-600 to-teal-600 rounded-xl p-4 mb-6 text-white shadow-md">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-white/20 rounded-lg">
                                    <i data-lucide="clipboard-check" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h2 class="text-lg font-bold">Auditoría Interna</h2>
                                    <p class="text-emerald-100 text-xs">Análisis con IA basado en ISO 42001</p>
                                </div>
                            </div>
                        </div>

                        <!-- Proceso de Análisis Automático -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200 p-6 mb-6">
                            <div class="flex items-start gap-4">
                                <div class="p-3 bg-blue-600 rounded-xl text-white shrink-0">
                                    <i data-lucide="brain" class="w-6 h-6"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold text-blue-900 mb-2">Análisis Automatizado por IA</h3>
                                    <p class="text-sm text-blue-700 mb-4">
                                        La IA analizará toda la documentación, imágenes y notas proporcionadas para:
                                    </p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div class="flex items-center gap-2 text-sm text-blue-800">
                                            <i data-lucide="search" class="w-4 h-4 text-blue-600"></i>
                                            <span>Identificar controles incumplidos</span>
                                        </div>
                                        <div class="flex items-center gap-2 text-sm text-blue-800">
                                            <i data-lucide="file-warning" class="w-4 h-4 text-blue-600"></i>
                                            <span>Detectar cláusulas con deficiencias</span>
                                        </div>
                                        <div class="flex items-center gap-2 text-sm text-blue-800">
                                            <i data-lucide="alert-triangle" class="w-4 h-4 text-blue-600"></i>
                                            <span>Evaluar riesgos asociados</span>
                                        </div>
                                        <div class="flex items-center gap-2 text-sm text-blue-800">
                                            <i data-lucide="clipboard-list" class="w-4 h-4 text-blue-600"></i>
                                            <span>Generar mapa de calor de riesgos</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        ${state.auditReport ? `
                            <!-- Audit Report View -->
                            <div class="space-y-6" id="audit-report-export">
                                <!-- Report Header -->
                                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6" id="audit-report-actions">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 class="text-2xl font-bold text-slate-800 mb-2">Informe de Auditoría ISO 42001</h3>
                                            <div class="flex flex-wrap gap-3 text-sm">
                                                <span class="flex items-center gap-1 text-slate-600">
                                                    <i data-lucide="calendar" class="w-4 h-4"></i>
                                                    ${new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}
                                                </span>
                                                <span class="flex items-center gap-1 text-slate-600">
                                                    <i data-lucide="file-text" class="w-4 h-4"></i>
                                                    ${state.auditDocuments.length} documentos
                                                </span>
                                                <span class="flex items-center gap-1 text-slate-600">
                                                    <i data-lucide="image" class="w-4 h-4"></i>
                                                    ${state.auditImages.length} imágenes
                                                </span>
                                            </div>
                                        </div>
                                        <button onclick="resetAudit()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors flex items-center gap-2">
                                            <i data-lucide="plus" class="w-4 h-4"></i>
                                            Nueva Auditoría
                                        </button>
                                    </div>
                                    <div class="p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                                        <p class="text-sm font-semibold text-emerald-800 mb-1">Enfoque de Auditoría:</p>
                                        <p class="text-sm text-emerald-700">${state.auditFocus}</p>
                                    </div>
                                </div>

                                <!-- Charts Section -->
                                <div id="audit-charts-section" class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                    <h4 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                        <i data-lucide="bar-chart-3" class="w-5 h-5 text-blue-600"></i>
                                        Métricas Visuales
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div class="bg-slate-50 p-4 rounded-lg">
                                            <h5 class="text-sm font-semibold text-slate-700 mb-3 text-center">Distribución de Hallazgos</h5>
                                            <canvas id="findings-chart" class="max-h-64"></canvas>
                                        </div>
                                        <div class="bg-slate-50 p-4 rounded-lg">
                                            <h5 class="text-sm font-semibold text-slate-700 mb-3 text-center">Nivel de Cumplimiento</h5>
                                            <canvas id="compliance-chart" class="max-h-64"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <!-- Mapa de Calor de Riesgos -->
                                <div id="risk-heatmap-container">
                                    <!-- El mapa de calor se genera dinámicamente -->
                                </div>

                                <!-- Report Content -->
                                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
                                    <div id="audit-report-content" class="prose prose-slate prose-headings:text-slate-800 prose-h2:text-2xl prose-h2:font-bold prose-h2:border-b prose-h2:border-slate-200 prose-h2:pb-2 prose-h2:mb-4 prose-h3:text-xl prose-h3:font-semibold prose-h3:text-slate-700 prose-p:text-slate-600 prose-p:leading-relaxed prose-li:text-slate-600 prose-strong:text-slate-800 prose-table:w-full prose-th:bg-slate-100 prose-th:p-3 prose-th:text-left prose-th:font-semibold prose-td:p-3 prose-td:border-t prose-td:border-slate-200 max-w-none">
                                        <!-- Content will be rendered here -->
                                    </div>
                                </div>

                                <!-- Export Buttons -->
                                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                    <h4 class="text-lg font-bold text-slate-800 mb-4">Acciones del Informe</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <button onclick="exportAuditReport('pdf')" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                                            <i data-lucide="file-down" class="w-5 h-5"></i>
                                            Exportar PDF
                                        </button>
                                        <button onclick="exportAuditReport('md')" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                                            <i data-lucide="download" class="w-5 h-5"></i>
                                            Descargar Markdown
                                        </button>
                                        <button onclick="openNotebookExtension()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                                            <i data-lucide="brain" class="w-5 h-5"></i>
                                            Extender con Notebook
                                        </button>
                                    </div>
                                </div>

                                <!-- Extended Analysis Section -->
                                ${state.auditExtendedAnalysis ? `
                                    <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-xl shadow-sm border-2 border-purple-200 p-8">
                                        <div class="flex items-center gap-3 mb-6">
                                            <div class="p-3 bg-purple-600 rounded-xl">
                                                <i data-lucide="brain" class="w-6 h-6 text-white"></i>
                                            </div>
                                            <div>
                                                <h4 class="text-xl font-bold text-purple-900">Análisis Extendido con NotebookLM</h4>
                                                <p class="text-sm text-purple-700">Análisis adicional basado en fuentes de conocimiento del Notebook</p>
                                            </div>
                                        </div>
                                        <div id="extended-analysis-content" class="prose prose-purple prose-headings:text-purple-900 prose-p:text-purple-800 prose-li:text-purple-800 prose-strong:text-purple-900 max-w-none bg-white rounded-lg p-6 shadow-inner">
                                            <!-- Extended content will be rendered here -->
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <!-- Audit Input Form -->
                            <div class="grid gap-6">
                                <!-- Documents Section -->
                                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="flex items-center gap-3">
                                            <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                                            <h3 class="text-lg font-bold text-slate-800">Documentos</h3>
                                            <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded-full">Opcional</span>
                                        </div>
                                        <label class="cursor-pointer px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                                            <i data-lucide="upload" class="w-4 h-4 inline mr-2"></i>
                                            Cargar Documentos
                                            <input type="file" multiple accept=".pdf,.docx,.txt" onchange="handleAuditDocuments(event)" class="hidden">
                                        </label>
                                    </div>
                                    <p class="text-sm text-slate-600 mb-4">Soporta: PDF, DOCX, TXT (máx 10MB cada uno)</p>
                                    <div id="audit-docs-preview" class="space-y-2">
                                        ${state.auditDocuments.map((doc, idx) => `
                                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                                                <div class="flex items-center gap-2">
                                                    <i data-lucide="file" class="w-4 h-4 text-blue-600"></i>
                                                    <span class="text-sm font-medium text-slate-700">${doc.name}</span>
                                                    <span class="text-xs text-slate-400">${formatFileSize(doc.size)}</span>
                                                </div>
                                                <button onclick="removeAuditDocument(${idx})" class="p-1 hover:bg-red-50 rounded transition-colors">
                                                    <i data-lucide="x" class="w-4 h-4 text-red-500"></i>
                                                </button>
                                            </div>
                                        `).join('') || '<p class="text-sm text-slate-400 italic">No hay documentos cargados</p>'}
                                    </div>
                                </div>

                                <!-- Images Section -->
                                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="flex items-center gap-3">
                                            <i data-lucide="image" class="w-5 h-5 text-purple-600"></i>
                                            <h3 class="text-lg font-bold text-slate-800">Imágenes</h3>
                                            <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded-full">Opcional</span>
                                        </div>
                                        <label class="cursor-pointer px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium">
                                            <i data-lucide="upload" class="w-4 h-4 inline mr-2"></i>
                                            Cargar Imágenes
                                            <input type="file" multiple accept="image/*" onchange="handleAuditImages(event)" class="hidden">
                                        </label>
                                    </div>
                                    <p class="text-sm text-slate-600 mb-4">Soporta: PNG, JPG, WEBP (máx 5MB cada una)</p>
                                    <div id="audit-images-preview" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        ${state.auditImages.map((img, idx) => `
                                            <div class="relative group">
                                                <img src="${img.dataUrl}" class="w-full h-32 object-cover rounded-lg border border-slate-200">
                                                <button onclick="removeAuditImage(${idx})" class="absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <i data-lucide="x" class="w-3 h-3"></i>
                                                </button>
                                                <p class="text-xs text-slate-500 mt-1 truncate">${img.name}</p>
                                            </div>
                                        `).join('') || '<p class="text-sm text-slate-400 italic col-span-full">No hay imágenes cargadas</p>'}
                                    </div>
                                </div>

                                <!-- Auditor Notes -->
                                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                    <div class="flex items-center gap-3 mb-4">
                                        <i data-lucide="pen-tool" class="w-5 h-5 text-amber-600"></i>
                                        <h3 class="text-lg font-bold text-slate-800">Conceptos del Auditor</h3>
                                        <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded-full">Opcional</span>
                                    </div>
                                    <textarea 
                                        id="audit-notes" 
                                        rows="4" 
                                        placeholder="Ingrese observaciones, hallazgos previos, áreas de enfoque específicas..."
                                        class="w-full p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none resize-none"
                                        oninput="state.auditNotes = this.value"
                                    >${state.auditNotes}</textarea>
                                    <p class="text-xs text-slate-500 mt-2">${state.auditNotes.length} caracteres</p>
                                </div>

                                <!-- Audit Focus -->
                                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                    <div class="flex items-center gap-3 mb-4">
                                        <i data-lucide="target" class="w-5 h-5 text-emerald-600"></i>
                                        <h3 class="text-lg font-bold text-slate-800">Enfoque de Auditoría</h3>
                                        <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full font-semibold">Obligatorio</span>
                                    </div>
                                    <textarea 
                                        id="audit-focus" 
                                        rows="3" 
                                        placeholder="Describa el enfoque y objetivos de esta auditoría (ej: Auditoría de cumplimiento ISO 42001 - Controles del Anexo A)"
                                        class="w-full p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none resize-none"
                                        oninput="state.auditFocus = this.value"
                                    >${state.auditFocus}</textarea>
                                    <div class="mt-3 flex flex-wrap gap-2">
                                        <button onclick="setAuditFocus('Auditoría de cumplimiento ISO 42001 - Controles del Anexo A')" class="text-xs px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded-full text-slate-700 transition-colors">
                                            Cumplimiento Anexo A
                                        </button>
                                        <button onclick="setAuditFocus('Evaluación de riesgos de IA según Anexo C')" class="text-xs px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded-full text-slate-700 transition-colors">
                                            Evaluación Riesgos
                                        </button>
                                        <button onclick="setAuditFocus('Revisión de documentación del ciclo de vida de IA')" class="text-xs px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded-full text-slate-700 transition-colors">
                                            Ciclo de Vida IA
                                        </button>
                                    </div>
                                </div>

                                <!-- Generate Button -->
                                <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-xl p-6 border border-emerald-200">
                                    <button 
                                        onclick="generateAuditReport()" 
                                        ${state.auditGenerating ? 'disabled' : ''}
                                        class="w-full py-4 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3">
                                        ${state.auditGenerating ? `
                                            <div class="loader ease-linear rounded-full border-4 border-t-4 border-white h-6 w-6"></div>
                                            Generando Informe...
                                        ` : `
                                            <i data-lucide="sparkles" class="w-6 h-6"></i>
                                            Generar Informe de Auditoría con IA
                                        `}
                                    </button>
                                    <p class="text-xs text-center text-slate-600 mt-3">
                                        ${state.auditDocuments.length > 0 || state.auditImages.length > 0 || state.auditNotes ?
                        '✅ Información cargada. Asegúrate de definir el enfoque de auditoría.' :
                        '⚠️ Carga al menos un documento, imagen o escribe conceptos del auditor.'}
                                    </p>
                                </div>
                            </div>
                        `}
                    </div>
                `;
                container.innerHTML = html;
            } else if (state.activeTab === 'notebook') {
                breadcrumbSection.innerText = 'Cerebro AI';
                breadcrumbTitle.innerText = 'NotebookLM';

                // Notebook UI
                let html = `
                    <div class="h-[calc(100vh-140px)] flex flex-col lg:flex-row gap-6 animate-fadeIn pb-4">
                        
                        <!-- Left Panel: Sources -->
                        <div class="w-full lg:w-1/3 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                            <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                <h3 class="font-bold text-slate-700">Fuentes</h3>
                                <div class="flex gap-2">
                                     <button onclick="toggleAllSources()" class="text-xs text-blue-600 font-medium hover:text-blue-800">Seleccionar todas</button>
                                     <button onclick="openNotebookConfig()" class="text-slate-400 hover:text-slate-600" title="Configurar URL"><i data-lucide="settings" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                            
                            <div class="overflow-y-auto p-4 space-y-3 bg-slate-50/50 flex-1 custom-scrollbar">
                                <div onclick="${state.notebookUrl ? 'toggleNotebookMode()' : 'openNotebookConfig()'}" 
                                     class="p-4 rounded-xl mb-4 cursor-pointer transition-all border ${state.notebookMode === 'external' ? 'bg-purple-50 border-purple-200 shadow-md' : 'bg-white border-slate-200 hover:border-purple-300'}">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 ${state.notebookMode === 'external' ? 'bg-purple-600 text-white' : 'bg-slate-100 text-slate-400'} rounded-lg transition-colors">
                                            <i data-lucide="external-link" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <div class="text-xs font-bold ${state.notebookMode === 'external' ? 'text-purple-800' : 'text-slate-500'} uppercase tracking-wider">Notebook de Google</div>
                                            <div class="text-sm font-medium text-slate-700 truncate w-36">
                                                ${state.notebookUrl ? 'Conectado (Clic para cambiar)' : 'Haz clic para conectar'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            
                                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 px-1 top-0 bg-slate-50/50 backdrop-blur z-10 sticky py-1">Memoria Interna (ISO 42001)</div>
                                
                                ${isoData.clauses.map(c => `
                                    <label class="flex items-center gap-3 p-3 bg-white border border-slate-200 rounded-xl cursor-pointer hover:border-blue-300 transition-colors shadow-sm">
                                        <input type="checkbox" onchange="toggleSource('clause', '${c.id}')" ${state.notebookSources.includes('clause-' + c.id) ? 'checked' : ''} class="w-4 h-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500">
                                        <div class="flex items-center gap-2 overflow-hidden">
                                            <div class="p-1.5 bg-blue-50 text-blue-600 rounded-lg shrink-0"><i data-lucide="${c.icon}" class="w-4 h-4"></i></div>
                                            <span class="text-sm font-medium text-slate-700 truncate">${c.title}</span>
                                        </div>
                                    </label>
                                `).join('')}
                                
                                <div class="my-2 border-t border-slate-200"></div>
                                
                                ${['A', 'B', 'C', 'D'].map(annex => `
                                    <label class="flex items-center gap-3 p-3 bg-white border border-slate-200 rounded-xl cursor-pointer hover:border-emerald-300 transition-colors shadow-sm">
                                        <input type="checkbox" onchange="toggleSource('annex', '${annex}')" ${state.notebookSources.includes('annex-' + annex) ? 'checked' : ''} class="w-4 h-4 text-emerald-600 rounded border-slate-300 focus:ring-emerald-500">
                                        <div class="flex items-center gap-2">
                                             <div class="p-1.5 bg-emerald-50 text-emerald-600 rounded-lg shrink-0"><i data-lucide="layers" class="w-4 h-4"></i></div>
                                            <span class="text-sm font-medium text-slate-700">Anexo ${annex}</span>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Right Panel: Chat / Content -->
                        <div class="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden relative">
                             ${state.notebookMode === 'external' ? `
                                <div class="absolute inset-0 z-10 bg-slate-50 flex flex-col items-center justify-center p-8 text-center animate-fadeIn">
                                    ${state.notebookUrl ? `
                                        <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center shadow-lg mb-6 animate-slideUp">
                                            <img src="https://www.gstatic.com/images/branding/product/1x/notebook_lm_96dp.png" alt="NotebookLM" class="w-16 h-16 opacity-80" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/Google_Chrome_icon_%28February_2022%29.svg/800px-Google_Chrome_icon_%28February_2022%29.svg.png'">
                                        </div>
                                        <h3 class="text-2xl font-bold text-slate-800 mb-3">Abrir Notebook Externo</h3>
                                        <p class="text-slate-600 max-w-md mb-8 leading-relaxed">
                                            Google NotebookLM no permite ser incrustado directamente en otras aplicaciones por razones de seguridad.
                                            <br>Puedes abrir tu cuaderno en una nueva pestaña.
                                        </p>
                                        <a href="${state.notebookUrl}" target="_blank" class="inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all group">
                                            <span>Abrir mi Notebook</span>
                                            <i data-lucide="external-link" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
                                        </a>
                                        <button onclick="toggleNotebookMode()" class="mt-8 text-sm text-slate-400 hover:text-purple-600 underline">Volver a Cerebro AI Interno</button>
                                    ` : `
                                        <div class="w-20 h-20 bg-slate-200 rounded-full flex items-center justify-center mb-6">
                                            <i data-lucide="link" class="w-10 h-10 text-slate-400"></i>
                                        </div>
                                        <h3 class="text-xl font-bold text-slate-800 mb-2">Conectar NotebookLM</h3>
                                        <p class="text-slate-500 mb-6">Necesitas configurar la URL de tu cuaderno primero.</p>
                                        <button onclick="openNotebookConfig()" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors shadow-md">
                                            Configurar URL
                                        </button>
                                    `}
                                </div>
                            ` : `
                                <div class="p-6 flex-1 overflow-y-auto" id="notebook-chat-area">
                                 <div class="flex flex-col items-center justify-center h-full text-center space-y-6 opacity-80" id="notebook-empty-state">
                                    <div class="w-20 h-20 bg-gradient-to-tr from-blue-100 to-purple-100 rounded-full flex items-center justify-center shadow-inner">
                                        <i data-lucide="sparkles" class="w-10 h-10 text-slate-400"></i>
                                    </div>
                                    <div class="max-w-md">
                                        <h3 class="text-xl font-bold text-slate-800 mb-2">Cerebro ISO 42001 AI</h3>
                                        <p class="text-slate-500 text-sm leading-relaxed">
                                            Chat contextual potenciado por Gemini. Selecciona tus fuentes a la izquierda.
                                        </p>
                                    </div>
                                    <!-- Prompts Sugeridos para Auditoría -->
                                <div class="w-full max-w-2xl">
                                    <p class="text-xs text-slate-400 mb-3 uppercase tracking-wide font-medium">Preguntas sugeridas para auditores</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                        <button onclick="notebookAsk('¿Qué evidencias debo solicitar para verificar el cumplimiento de la cláusula 5 (Liderazgo)?')" class="p-3 bg-slate-50 border border-slate-200 rounded-xl text-left text-sm text-slate-600 hover:bg-white hover:shadow-md hover:border-blue-300 transition-all">
                                            <i data-lucide="search" class="w-3.5 h-3.5 inline mr-1.5 text-blue-500"></i>
                                            Evidencias para Cláusula 5
                                        </button>
                                        <button onclick="notebookAsk('Compara los controles A.6 (Ciclo de Vida) con los requisitos de la cláusula 8 (Operación)')" class="p-3 bg-slate-50 border border-slate-200 rounded-xl text-left text-sm text-slate-600 hover:bg-white hover:shadow-md hover:border-blue-300 transition-all">
                                            <i data-lucide="git-compare" class="w-3.5 h-3.5 inline mr-1.5 text-purple-500"></i>
                                            Comparar A.6 con Cláusula 8
                                        </button>
                                        <button onclick="notebookAsk('Genera un cuestionario de auditoría para evaluar los controles del Anexo A.7 (Datos)')" class="p-3 bg-slate-50 border border-slate-200 rounded-xl text-left text-sm text-slate-600 hover:bg-white hover:shadow-md hover:border-blue-300 transition-all">
                                            <i data-lucide="help-circle" class="w-3.5 h-3.5 inline mr-1.5 text-emerald-500"></i>
                                            Cuestionario A.7 Datos
                                        </button>
                                        <button onclick="notebookAsk('¿Cuáles son los requisitos obligatorios vs recomendaciones del Anexo B para la evaluación de impacto?')" class="p-3 bg-slate-50 border border-slate-200 rounded-xl text-left text-sm text-slate-600 hover:bg-white hover:shadow-md hover:border-blue-300 transition-all">
                                            <i data-lucide="scale" class="w-3.5 h-3.5 inline mr-1.5 text-amber-500"></i>
                                            Obligatorio vs Guía (Impacto)
                                        </button>
                                        <button onclick="notebookAsk('Resume los hallazgos típicos que un auditor encuentra en el Anexo A.5 (Evaluación de Impactos)')" class="p-3 bg-slate-50 border border-slate-200 rounded-xl text-left text-sm text-slate-600 hover:bg-white hover:shadow-md hover:border-blue-300 transition-all">
                                            <i data-lucide="alert-triangle" class="w-3.5 h-3.5 inline mr-1.5 text-red-500"></i>
                                            Hallazgos típicos A.5
                                        </button>
                                        <button onclick="notebookAsk('¿Qué documentación debe existir para demostrar conformidad con la cláusula 6.1 (Acciones para riesgos)?')" class="p-3 bg-slate-50 border border-slate-200 rounded-xl text-left text-sm text-slate-600 hover:bg-white hover:shadow-md hover:border-blue-300 transition-all">
                                            <i data-lucide="file-text" class="w-3.5 h-3.5 inline mr-1.5 text-indigo-500"></i>
                                            Documentación Cláusula 6.1
                                        </button>
                                    </div>
                                    
                                    <!-- Modo Comparación -->
                                    <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-xl">
                                        <div class="flex items-center gap-2 mb-2">
                                            <i data-lucide="git-compare" class="w-4 h-4 text-blue-600"></i>
                                            <span class="text-sm font-semibold text-blue-800">Modo Comparación</span>
                                        </div>
                                        <div class="flex gap-2">
                                            <select id="compare-source-1" class="flex-1 text-xs p-2 border border-blue-200 rounded-lg bg-white">
                                                <option value="">Seleccionar fuente 1...</option>
                                                ${isoData.clauses.map(c => `<option value="clause-${c.id}">${c.title}</option>`).join('')}
                                                ${['A', 'B', 'C', 'D'].map(a => `<option value="annex-${a}">Anexo ${a}</option>`).join('')}
                                            </select>
                                            <select id="compare-source-2" class="flex-1 text-xs p-2 border border-blue-200 rounded-lg bg-white">
                                                <option value="">Seleccionar fuente 2...</option>
                                                ${isoData.clauses.map(c => `<option value="clause-${c.id}">${c.title}</option>`).join('')}
                                                ${['A', 'B', 'C', 'D'].map(a => `<option value="annex-${a}">Anexo ${a}</option>`).join('')}
                                            </select>
                                            <button onclick="compareSources()" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs hover:bg-blue-700">
                                                Comparar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Botón Exportar Conversación -->
                                <div id="notebook-export-btn" class="hidden mt-4 flex justify-end">
                                    <button onclick="exportNotebookConversation()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm transition-colors">
                                        <i data-lucide="download" class="w-4 h-4"></i>
                                        Exportar conversación
                                    </button>
                                </div>
                                
                                <!-- Notas del Investigador -->
                                <div class="mt-4 bg-amber-50 border border-amber-200 rounded-xl p-4">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i data-lucide="sticky-note" class="w-4 h-4 text-amber-600"></i>
                                        <span class="text-sm font-semibold text-amber-800">Mis Notas de Investigación</span>
                                    </div>
                                    <textarea 
                                        id="notebook-researcher-notes" 
                                        placeholder="Escribe tus apuntes, conclusiones o ideas mientras investigas..."
                                        class="w-full p-3 text-sm border border-amber-200 rounded-lg resize-none bg-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                        rows="3"
                                        onchange="saveNotebookNotes(this.value)"
                                    >${state.notebookResearcherNotes || ''}</textarea>
                                </div>
                            </div>
                                <div id="notebook-messages" class="space-y-6 pb-4 hidden">
                                    <!-- Messages injected -->
                                </div>
                            </div>

                            <div class="p-4 border-t border-slate-100 bg-white">
                                <div class="relative shadow-lg rounded-2xl border border-slate-200 overflow-hidden focus-within:ring-2 focus-within:ring-blue-500/20 transition-shadow">
                                    <textarea id="notebook-input" rows="1" placeholder="Haz una pregunta a tus fuentes..." 
                                        class="w-full pl-4 pr-14 py-4 resize-none outline-none text-slate-700 bg-transparent placeholder-slate-400"
                                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                                    <button onclick="sendNotebookMessage()" class="absolute right-2 bottom-2 p-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i data-lucide="arrow-up" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                <div class="text-center mt-2">
                                     <span class="text-[10px] text-slate-400">
                                        ${state.notebookSources.length} fuentes seleccionadas
                                     </span>
                                </div>
                            </div>
                            `}
                        </div>
                    </div>
                `;
                html += `
                    <!-- Notebook Config Modal -->
                    <div id="notebook-config-modal" class="hidden fixed inset-0 z-[60] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
                        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 border border-slate-200 animate-fadeIn relative">
                             <div class="absolute -top-12 left-0 w-full flex justify-center">
                                 <div class="bg-white p-3 rounded-full shadow-lg">
                                     <i data-lucide="link" class="w-8 h-8 text-purple-600"></i>
                                 </div>
                             </div>
                             <div class="mt-6 text-center mb-6">
                                <h3 class="text-xl font-bold text-slate-800">Conectar NotebookLM</h3>
                                <p class="text-sm text-slate-500">Ingresa la URL de tu cuaderno para acceso rápido</p>
                            </div>
                            
                            <div class="mb-6 text-left">
                                <label class="block text-xs font-bold text-slate-700 uppercase tracking-wide mb-2">URL del Notebook</label>
                                <input type="text" id="notebook-url-input" placeholder="https://notebooklm.google.com/..." value="${state.notebookUrl}"
                                    class="w-full p-3 border border-slate-300 rounded-xl focus:ring-4 focus:ring-purple-100 focus:border-purple-500 outline-none transition-all text-sm font-mono text-slate-700">
                                <div class="mt-3 p-3 bg-amber-50 border border-amber-100 rounded-lg flex gap-2 items-start">
                                    <i data-lucide="alert-circle" class="w-4 h-4 text-amber-600 shrink-0 mt-0.5"></i>
                                    <p class="text-xs text-amber-800 leading-relaxed">
                                        Google no permite incrustar Notebooks dentro de otras webs. Esta configuración creará un <strong>acceso directo optimizado</strong> para abrir tu cuaderno.
                                    </p>
                                </div>
                            </div>
                            <div class="flex flex-col gap-3">
                                <button onclick="saveNotebookUrl()" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-md transition-all transform hover:scale-[1.02] active:scale-95">
                                    Guardar y Conectar
                                </button>
                                <button onclick="closeNotebookConfig()" class="w-full py-3 text-slate-500 font-medium hover:bg-slate-50 rounded-xl transition-colors">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                html += `</div>`; // Close fadein container
                container.innerHTML = html;
            }

            lucide.createIcons();

            // Initialize audit module components if on audit tab
            if (state.activeTab === 'audit' && !state.auditReport) {
                setTimeout(() => {
                    // Componentes eliminados: checklist, matriz manual, evidencias por control, asistente
                }, 0);
            }

            document.getElementById('main-scroll-area').scrollTop = 0;
        }

        function renderContentItem(item, idx, sectionId) {
            if (item.type === 'p') return `<p class="text-slate-700 mb-4 text-justify leading-relaxed">${item.text}</p>`;
            if (item.type === 'list') return `<ul class="list-disc pl-6 mb-4 space-y-2 text-slate-700">${item.items.map(li => `<li>${li}</li>`).join('')}</ul>`;
            if (item.type === 'note') {
                const isExpanded = state.expandedItems[item.id];
                return `
                <div class="mb-4 border border-blue-100 rounded-lg bg-blue-50/50">
                    <button onclick="toggleExpand('${item.id}')" class="w-full flex justify-between p-3 text-left hover:bg-blue-100 transition-colors">
                        <span class="flex items-center gap-2 font-semibold text-blue-800 text-xs uppercase"><i data-lucide="info" class="w-3.5 h-3.5"></i> ${item.title}</span>
                        <i data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4 text-blue-500"></i>
                    </button>
                    ${isExpanded ? `
                        <div class="p-4 pt-0 text-sm text-slate-600 animate-fadeIn border-t border-blue-100/50">
                            <p class="mt-2 mb-2">${item.text}</p>
                            ${item.list ? `<ul class="list-disc pl-5">${item.list.map(l => `<li>${l}</li>`).join('')}</ul>` : ''}
                        </div>
                    ` : ''}
                </div>`;
            }
            return '';
        }

        function renderChatMessages() {
            const container = document.getElementById('general-chat-messages');
            container.innerHTML = state.messages.map(msg => {
                const isUser = msg.role === 'user';
                // Parse markdown if marked is available
                const content = typeof marked !== 'undefined' ? marked.parse(msg.text) : msg.text.replace(/\n/g, '<br>');

                // Add prose class for bot messages to properly style markdown (headings, lists, bold, etc.)
                // For user messages, keep it simple as they are usually short text
                const proseClass = isUser ? '' : 'prose prose-sm prose-slate max-w-none';

                return `
                <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                    <div class="flex gap-2 max-w-[85%] ${isUser ? 'flex-row-reverse' : ''}">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 ${isUser ? 'bg-blue-100 text-blue-600' : 'bg-indigo-100 text-indigo-600'}">
                            <i data-lucide="${isUser ? 'user' : 'bot'}" class="w-4 h-4"></i>
                        </div>
                        <div class="p-3 rounded-2xl text-sm leading-relaxed shadow-sm ${isUser ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-700 rounded-tl-none'} ${proseClass}">
                            ${content}
                        </div>
                    </div>
                </div>
            `}).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
            lucide.createIcons();
        }

        // --- ACTIONS ---

        function navigateTo(tab, sectionId = null) {
            state.activeTab = tab;
            if (sectionId) state.activeSection = sectionId;
            renderSidebar();
            renderMainContent();
            updateTopNavigation();
            toggleMobileMenu(false); // Close if open
        }

        function updateTopNavigation() {
            // Update top bar dashboard buttons (solo los 3 dashboards)
            const topButtons = ['dashboard', 'clauses-dashboard', 'annex-a-dashboard'];
            topButtons.forEach(btn => {
                const btnEl = document.getElementById('top-nav-' + btn);
                if (btnEl) {
                    if (state.activeTab === btn) {
                        btnEl.className = 'px-3 py-1.5 rounded-md text-xs font-medium transition-colors flex items-center gap-1.5 bg-blue-600 text-white shadow-sm';
                    } else {
                        btnEl.className = 'px-3 py-1.5 rounded-md text-xs font-medium transition-colors flex items-center gap-1.5 text-slate-600 hover:text-slate-900 hover:bg-white hover:shadow-sm';
                    }
                }
            });
        }

        function setAnnexTab(tab) {
            state.activeAnnexTab = tab;
            renderMainContent();
        }

        function toggleExpand(id) {
            state.expandedItems[id] = !state.expandedItems[id];
            renderMainContent();
        }

        function toggleMobileMenu(forceState = null) {
            const sidebar = document.getElementById('sidebar');
            const isOpen = !sidebar.classList.contains('-translate-x-full');
            const newState = forceState !== null ? forceState : !isOpen;

            if (newState) {
                sidebar.classList.remove('-translate-x-full');
            } else {
                sidebar.classList.add('-translate-x-full');
            }
        }

        // --- CHAT LOGIC ---

        function toggleChat() {
            const chatWin = document.getElementById('general-chat-window');
            const floatBtn = document.getElementById('chat-float-btn');
            state.chatOpen = !state.chatOpen;

            if (state.chatOpen) {
                chatWin.classList.remove('hidden');
                floatBtn.classList.add('bg-slate-700', 'rotate-90');
                floatBtn.classList.remove('bg-gradient-to-r');
                floatBtn.innerHTML = '<i data-lucide="x" class="w-6 h-6"></i>';
            } else {
                chatWin.classList.add('hidden');
                floatBtn.classList.remove('bg-slate-700', 'rotate-90');
                floatBtn.classList.add('bg-gradient-to-r');
                floatBtn.innerHTML = '<i data-lucide="message-square" class="w-6 h-6"></i>';
            }
            lucide.createIcons();
        }

        function toggleChatExpand() {
            const chatWin = document.getElementById('general-chat-window');
            const expandIcon = document.getElementById('expand-icon');
            state.chatExpanded = !state.chatExpanded;

            if (state.chatExpanded) {
                // Expand to fullscreen, respecting sidebar on large screens
                chatWin.classList.remove('w-[350px]', 'md:w-[450px]', 'h-[500px]', 'rounded-2xl');
                chatWin.classList.add('fixed', 'w-auto', 'h-auto', 'rounded-xl', 'z-50');
                // On large screens (lg), leave space for sidebar (320px + 1rem margin)
                // On mobile, use full width with margin
                chatWin.classList.add('top-4', 'right-4', 'bottom-4');
                chatWin.classList.add('left-4', 'lg:left-[21rem]'); // 320px sidebar + 1rem margin
                expandIcon.setAttribute('data-lucide', 'minimize-2');
            } else {
                // Return to normal size
                chatWin.classList.remove('fixed', 'w-auto', 'h-auto', 'rounded-xl', 'z-50', 'top-4', 'right-4', 'bottom-4', 'left-4', 'lg:left-[21rem]');
                chatWin.classList.add('w-[350px]', 'md:w-[450px]', 'h-[500px]', 'rounded-2xl');
            }

            lucide.createIcons();
        }

        function handleChatKeyPress(e) {
            if (e.key === 'Enter') sendChatMessage();
        }

        async function sendChatMessage() {
            const input = document.getElementById('general-chat-input');
            const text = input.value.trim();
            if (!text && !state.attachedFileContent) return;

            if (!state.apiKey) {
                state.messages.push({ role: 'user', text: text || '[Archivo adjunto]' });
                state.messages.push({ role: 'system', text: '⚠️ Configura tu API Key primero.' });
                input.value = '';
                removeAttachedFile();
                renderChatMessages();
                return;
            }

            // --- CONSTRUCCIÓN DEL PROMPT MULTIMODAL ---
            let parts = [];

            // 1. Mensaje de Sistema / Reglas (Texto)
            let systemPrompt = `Eres un Consultor Experto en ISO/IEC 42001:2023, ISO 27001, Ciberseguridad e Inteligencia Artificial.

⚠️ REGLAS CRÍTICAS:
1. FILTRO DE TEMAS: Responde SOLO sobre ISO 42001, ISO 27001, IA, ciberseguridad y auditoría.
2. NO AGREGAR INFO NO SOLICITADA.
3. ESTILO: Conciso y directo.

HISTORIAL:
${state.messages.slice(-6).map(m => `${m.role === 'user' ? 'Usuario' : 'Experto'}: ${m.text}`).join('\n')}`;

            // Contexto normativo básico
            let normativeContent = "--- REQUISITOS NORMATIVOS (ANEXO A) ---\n";
            let informativeGuidance = "--- GUÍA DE IMPLEMENTACIÓN (ANEXO B / INFORMATIVO) ---\n";
            isoData.annexA.forEach(cat => {
                normativeContent += `\nCategoría ${cat.category}\n`;
                cat.controls.forEach(ctrl => {
                    normativeContent += `Control ${ctrl.code}: ${ctrl.name}\n- Requisito: ${ctrl.desc}\n`;
                    informativeGuidance += `Guía para ${ctrl.code}: ${ctrl.guid}\n`;
                });
            });

            // Detectar si la pregunta es sobre ISO/normas
            const textLower = text.toLowerCase();
            const isIsoQuestion = textLower.includes('iso') || textLower.includes('norma') || textLower.includes('42001') ||
                textLower.includes('27001') || textLower.includes('anexo') || textLower.includes('control') ||
                textLower.includes('auditor') || textLower.includes('cumplimiento') || textLower.includes('certificación') ||
                textLower.includes('gestión de ia') || textLower.includes('sistema de gestión');

            if (isIsoQuestion && !state.attachedFile) {
                systemPrompt += `\n\nCONTEXTO NORMATIVO (Usar si es relevante):\n${normativeContent}\n\nGUÍAS:\n${informativeGuidance}`;
            }

            // 2. Manejo de Archivos (Texto o Imagen)
            if (state.attachedFile) {
                const fileType = state.attachedFile.type;

                if (fileType.startsWith('image/')) {
                    // CASO IMAGEN: Prompt + Imagen
                    systemPrompt += `\n\nTAREA: Analiza la imagen adjunta. ${text || 'Describe lo que ves y su relevancia para la auditoría o ISO 42001.'}`;

                    // Añadir texto primero
                    parts.push({ text: systemPrompt });

                    // Añadir imagen (Base64 sin prefijo)
                    const base64Data = state.attachedFileContent.split(',')[1];
                    parts.push({
                        inlineData: {
                            mimeType: fileType,
                            data: base64Data
                        }
                    });

                } else {
                    // CASO TEXTO/PDF/DOC: Prompt + Contenido de texto
                    systemPrompt += `\n\nDOCUMENTO A AUDITAR: "${state.attachedFile.name}"
CONTENIDO EXTRAÍDO:
${state.attachedFileContent}

TAREA: Revisa el documento contra los requisitos del Anexo A. Identifica hallazgos y oportunidades de mejora: "${text || 'Audita este documento'}"`;

                    parts.push({ text: systemPrompt });
                }
            } else {
                // CASO SOLO TEXTO
                systemPrompt += `\n\nPREGUNTA DEL USUARIO: "${text}"`;
                parts.push({ text: systemPrompt });
            }

            // User msg for UI
            let userMessageUI = text;
            if (state.attachedFile) {
                userMessageUI = `${state.attachedFile.type.startsWith('image/') ? '🖼️ [Imagen]' : '📄 [Documento]'} ${state.attachedFile.name}\n${text}`;
            }
            state.messages.push({ role: 'user', text: userMessageUI });
            input.value = '';
            renderChatMessages();

            // Loading state
            const container = document.getElementById('general-chat-messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = `<div class="flex justify-start"><div class="bg-white border border-slate-200 p-3 rounded-2xl rounded-tl-none shadow-sm flex items-center gap-2"><div class="loader ease-linear rounded-full border-2 border-t-2 border-indigo-500 h-3 w-3"></div><span class="text-xs text-slate-400">Analizando...</span></div></div>`;
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;

            try {
                const response = await callGemini(parts);
                state.messages.push({ role: 'system', text: response });
            } catch (err) {
                state.messages.push({ role: 'system', text: `Error: ${err.message}` });
            }

            // Cleanup
            removeAttachedFile();
            loadingDiv.remove();
            renderChatMessages();
        }

        // --- FILE HANDLING FUNCTIONS ---

        function attachFileToChat() {
            // Create dynamic input to avoid caching issues
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = false;
            input.accept = '.pdf,.txt,.docx,.md,.json,.png,.jpg,.jpeg,.webp';
            input.onchange = handleUserFileSelect;
            input.click();
        }

        async function handleUserFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            await processUserFile(file);
            event.target.value = ''; // Reset
        }

        async function handlePaste(e) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (const item of items) {
                if (item.kind === 'file') {
                    const file = item.getAsFile();
                    await processUserFile(file);
                    e.preventDefault();
                    return;
                }
            }
        }

        async function processUserFile(file) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showToast('error', 'Archivo muy grande (máx 10MB)');
                return;
            }

            try {
                showToast('success', 'Procesando archivo...');

                let content;
                const extension = file.name.split('.').pop().toLowerCase();
                const isImage = file.type.startsWith('image/');

                if (isImage) {
                    // IMAGE PROCESSING
                    content = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (e) => reject(new Error('Error al leer imagen'));
                        reader.readAsDataURL(file);
                    });
                } else {
                    // DOCUMENT PROCESSING
                    if (extension === 'txt' || extension === 'md' || extension === 'json') {
                        content = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.onerror = (e) => reject(new Error('Error al leer texto'));
                            reader.readAsText(file);
                        });
                    } else if (extension === 'pdf') {
                        if (typeof pdfjsLib === 'undefined') throw new Error('PDF.js no disponible');
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                        }
                        content = fullText;
                    } else if (extension === 'docx') {
                        if (typeof mammoth === 'undefined') throw new Error('Mammoth.js no disponible');
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        content = result.value;
                    } else {
                        throw new Error(`Formato no soportado: .${extension} - Intenta subir una captura de pantalla si es un documento visual.`);
                    }
                }

                if (!content || (typeof content === 'string' && content.trim().length === 0)) {
                    showToast('error', 'No se pudo leer contenido del archivo');
                    return;
                }

                state.attachedFile = file;
                state.attachedFileContent = content; // String(text) or Base64(image)

                // Update UI with preview
                const previewArea = document.getElementById('file-preview-area');
                const nameEl = document.getElementById('file-preview-name');
                const sizeEl = document.getElementById('file-preview-size');
                const iconContainer = document.getElementById('file-preview-icon-container');

                previewArea.classList.remove('hidden');
                nameEl.textContent = file.name;
                sizeEl.textContent = formatFileSize(file.size);

                // Thumbnail for images
                if (isImage) {
                    iconContainer.innerHTML = `<img src="${content}" class="w-8 h-8 object-cover rounded-md border border-blue-200">`;
                } else {
                    iconContainer.innerHTML = `<span id="file-preview-icon"><i data-lucide="file-text" class="w-5 h-5"></i></span>`;
                    lucide.createIcons();
                }

                showToast('success', 'Archivo adjunto listo');

            } catch (error) {
                console.error(error);
                showToast('error', `Error: ${error.message}`);
            }
        }

        function removeAttachedFile() {
            state.attachedFile = null;
            state.attachedFileContent = null;
            const previewArea = document.getElementById('file-preview-area');
            if (previewArea) previewArea.classList.add('hidden');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // --- AUDIT MODULE FUNCTIONS ---

        async function handleAuditDocuments(event) {
            const files = Array.from(event.target.files);

            for (const file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    showToast('error', `Archivo muy grande: ${file.name}`);
                    continue;
                }

                try {
                    const content = await extractTextFromFile(file);
                    state.auditDocuments.push({
                        name: file.name,
                        size: file.size,
                        content: content,
                        file: file
                    });
                } catch (error) {
                    showToast('error', `Error procesando ${file.name}: ${error.message}`);
                }
            }

            event.target.value = '';
            renderMainContent();
        }

        async function handleAuditImages(event) {
            const files = Array.from(event.target.files);

            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast('error', `Imagen muy grande: ${file.name}`);
                    continue;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    state.auditImages.push({
                        name: file.name,
                        size: file.size,
                        dataUrl: e.target.result,
                        file: file
                    });
                    renderMainContent();
                };
                reader.readAsDataURL(file);
            }

            event.target.value = '';
        }

        function removeAuditDocument(index) {
            state.auditDocuments.splice(index, 1);
            renderMainContent();
        }

        function removeAuditImage(index) {
            state.auditImages.splice(index, 1);
            renderMainContent();
        }

        function setAuditFocus(text) {
            state.auditFocus = text;
            document.getElementById('audit-focus').value = text;
        }

        async function generateAuditReport() {
            if (!state.apiKey) {
                showToast('error', 'Configura tu API Key primero');
                return;
            }

            if (!state.auditFocus || state.auditFocus.trim().length < 20) {
                showToast('error', 'Define el enfoque de auditoría (mínimo 20 caracteres)');
                return;
            }

            if (state.auditDocuments.length === 0 && state.auditImages.length === 0 && !state.auditNotes.trim()) {
                showToast('error', 'Carga al menos un documento, imagen o escribe conceptos del auditor');
                return;
            }

            state.auditGenerating = true;
            renderMainContent();

            try {
                let prompt = `Actúa como Auditor Líder de Certificación ISO/IEC 42001:2023 consultor senior. Tu tono debe ser neutral, técnico y 100% fiel al lenguaje de gestión de riesgos.

REGLAS DE LENGUAJE (HACIA LA PERFECCIÓN ISO):
1. TERMINOLOGÍA DE GESTIÓN: No uses "cumplimiento mandatorio" o "adhesión obligatoria". Usa "requisitos aplicables", "gestión sistemática" o "implementación coherente".
2. NEUTRALIDAD TECNOLÓGICA: Evita términos prescriptivos que sugieran herramientas específicas o automatización. No uses "medibles" (usa "definidos"), no uses "automáticamente" (usa "registrar o documentar") y no uses "idéntica" (usa "de manera consistente").
3. EVITAR ABSOLUTOS: No digas que se deben documentar "todas" las transformaciones. Usa "transformaciones relevantes" o "datos significativos", según el enfoque de riesgo.
4. ENFOQUE "CONSIDERAR": Para controles de análisis, usa "la organización debería considerar mecanismos" en lugar de prescribir su implementación técnica.
5. DIFERENCIACIÓN: Mantén la separación clara entre "Requisito Normativo" (Anexo A) y "Guía de Implementación" (Anexo B). El Anexo A oficial termina en A.10.
6. EVIDENCIA NO PRESCRIPTIVA: No exijas formatos específicos de documentos. En lugar de "Bias Assessment Reports" usa "evidencia de análisis de sesgos". No exijas nombres de artefactos específicos, describe el tipo de evidencia que demuestra el control.
7. TÉRMINOS TÉCNICOS OPCIONALES: Términos como "data drift", "reweighting", "dataset final de entrenamiento" pueden mencionarse SOLO como ejemplos entre paréntesis, nunca como requisitos. La norma ISO 42001 es agnóstica de técnica.
8. GESTIÓN DE SESGOS: La norma exige gestionar el riesgo de sesgo, pero NO exige informes formales con nombres específicos. Usa "evidencia de que se analizan y mitigan los sesgos" en lugar de prescribir formatos.
9. CRITERIOS VS MÉTRICAS: No uses "métricas de calidad" (implica medición cuantitativa obligatoria). Usa "criterios de calidad" o "requisitos de calidad definidos". La norma no exige KPIs técnicos formales.
10. UMBRALES Y ALERTAS: No prescribas "umbrales de alerta" o "umbrales técnicos" como obligatorios. Usa "criterios definidos para detectar degradación" o "mecanismos apropiados según el enfoque de riesgo".
11. PROPORCIONALIDAD: Para exigencias técnicas complejas (ej. reconstrucción de predicciones, trazabilidad completa), añade "cuando sea razonablemente posible y proporcional al nivel de riesgo del sistema".
12. NIVEL DE RIESGO NEUTRO: No asumas que todos los sistemas son críticos. Evita lenguaje que implique obligaciones de sistemas de alto riesgo para todos los casos. Adapta la granularidad al enfoque de riesgo.

ENFOQUE DE AUDITORÍA:
${state.auditFocus}

`;

                if (state.auditDocuments.length > 0) {
                    prompt += `DOCUMENTOS ANALIZADOS (${state.auditDocuments.length}):\n`;
                    state.auditDocuments.forEach((doc, idx) => {
                        prompt += `\nDocumento ${idx + 1}: ${doc.name}\n`;
                        prompt += `${doc.content.substring(0, 5000)}\n...\n`;
                    });
                }

                if (state.auditNotes.trim()) {
                    prompt += `\nCONCEPTOS DEL AUDITOR:\n${state.auditNotes}\n`;
                }

                if (state.auditImages.length > 0) {
                    prompt += `\nIMAGENES ADJUNTAS: ${state.auditImages.length} imágenes para análisis visual\n`;
                }

                prompt += `
                ANALISIS AUTOMATICO DE INCUMPLIMIENTOS - ISO 42001
                
                Analiza TODA la documentacion, imagenes y notas para detectar automaticamente:
                1. Controles del Anexo A que NO se cumplen
                2. Clausulas con deficiencias  
                3. Riesgos asociados a cada incumplimiento
                
                Genera informe Markdown con:
                
                ## 1. RESUMEN EJECUTIVO
                
                ### Controles y Clausulas con Deficiencias Detectadas
                **Controles Anexo A:**
                - [Lista especifica: A.2.2, A.5.2, A.7.4, etc. con problema detectado]
                
                **Clausulas Cuerpo Normativo:**
                - [Lista: 4.1, 5.2, 6.1, etc. con incumplimiento]
                
                ### Hallazgos Principales (maximo 7)
                1. **[Titulo]:** [Descripcion vinculada a control/clausula especifica]
                2. **[Titulo]:** [Descripcion]
                
                ### Nivel Cumplimiento
                **[Porcentaje %]** - Basado en controles evaluados
                
                ---
                
                ## 2. MATRIZ DE RIESGOS - MAPA DE CALOR
                
                Generada automaticamente desde incumplimientos detectados:
                
                | Control Afectado | Riesgo Identificado | Prob. | Impacto | Nivel | Control ISO Relacionado |
                |------------------|---------------------|-------|---------|-------|------------------------|
                | [Ej: A.7.4] | [Riesgo de datos] | [Alta] | [Alto] | **CRITICO** | [A.7.4] |
                | [Continua...] |
                
                **Distribucion de Riesgos:**
                - CRITICOS: [X] | ALTOS: [X] | MEDIOS: [X] | BAJOS: [X]
                
                ---
                
                ## 3. HALLAZGOS DETALLADOS
                
                | ID | Hallazgo | Severidad | Control/Clausula Afectada | Evidencia Documental | Riesgo Asociado |
                |----|----------|-----------|---------------------------|----------------------|-----------------|
                | H-01 | **[Titulo]:** [Desc. especifica] | [Critico/Alto/Medio/Bajo] | [A.X.X o Clausula X.X] | [Cita de evidencia] | [Riesgo que genera] |
                | H-02 | [Continua...] |
                
                ---
                
                ## 4. ANALISIS POR CATEGORIA
                
                Para cada categoria evaluada del Anexo A:
                - **A.X [Nombre]:** [Analisis] - **[Cumple/No Cumple/Parcial]**
                
                ---
                
                ## 5. RECOMENDACIONES Y PLAN DE ACCION
                
                Recomendaciones priorizadas por nivel de riesgo y timeline de mitigacion.`;

                // Guardar datos del analisis para el dashboard
                state.auditAnalysisData = {
                    timestamp: new Date().toISOString(),
                    documentsAnalyzed: state.auditDocuments.length,
                    imagesAnalyzed: state.auditImages.length,
                    focus: state.auditFocus,
                    template: state.auditTemplate
                };

                const response = await callGemini(prompt);

                state.auditReport = response;
                state.auditGenerating = false;
                renderMainContent();

                // Render Markdown and create charts
                setTimeout(() => {
                    renderAuditMarkdown();
                    createAuditCharts();
                    createRiskHeatmap();
                    lucide.createIcons();
                }, 100);

                showToast('success', 'Informe generado exitosamente');

            } catch (error) {
                state.auditGenerating = false;
                renderMainContent();
                showToast('error', `Error generando informe: ${error.message}`);
            }
        }

        function renderAuditMarkdown() {
            const contentDiv = document.getElementById('audit-report-content');
            if (!contentDiv || !state.auditReport) return;

            // Render Markdown with marked.js
            if (typeof marked !== 'undefined') {
                contentDiv.innerHTML = marked.parse(state.auditReport);
            } else {
                // Fallback: simple formatting
                contentDiv.innerHTML = state.auditReport
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            }
        }

        function createAuditCharts() {
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded');
                return;
            }

            // Extract data from report (simplified - you can enhance this)
            const findingsData = extractFindingsData();
            const complianceData = extractComplianceData();

            // Findings Distribution Chart
            const findingsCtx = document.getElementById('findings-chart');
            if (findingsCtx) {
                new Chart(findingsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Crítico', 'Alto', 'Medio', 'Bajo', 'Observación'],
                        datasets: [{
                            data: findingsData,
                            backgroundColor: [
                                '#ef4444', // red
                                '#f97316', // orange
                                '#eab308', // yellow
                                '#3b82f6', // blue
                                '#94a3b8'  // gray
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.label + ': ' + context.parsed + ' hallazgos';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Compliance Level Chart
            const complianceCtx = document.getElementById('compliance-chart');
            if (complianceCtx) {
                new Chart(complianceCtx, {
                    type: 'bar',
                    data: {
                        labels: complianceData.labels,
                        datasets: [{
                            label: 'Nivel de Cumplimiento (%)',
                            data: complianceData.values,
                            backgroundColor: complianceData.values.map(v =>
                                v >= 80 ? '#10b981' : v >= 50 ? '#eab308' : '#ef4444'
                            ),
                            borderRadius: 6,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function (value) {
                                        return value + '%';
                                    }
                                },
                                grid: {
                                    color: '#e2e8f0'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return 'Cumplimiento: ' + context.parsed.y + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function extractFindingsData() {
            // Intentar extraer de la tabla de hallazgos primero
            const sections = parseReportSections(state.auditReport || '');
            const findings = getDetailedFindings(sections);
            const counts = { critico: 0, alto: 0, medio: 0, bajo: 0, observacion: 0 };

            if (findings.length > 0) {
                findings.forEach(f => {
                    const sev = (f.severidad || '').toLowerCase();
                    if (sev.includes('crítico') || sev.includes('critico')) counts.critico++;
                    else if (sev.includes('alto')) counts.alto++;
                    else if (sev.includes('medio')) counts.medio++;
                    else if (sev.includes('bajo')) counts.bajo++;
                    else if (sev.includes('observación') || sev.includes('observacion')) counts.observacion++;
                });

                // Si se encontraron datos de la tabla, usarlos
                if (Object.values(counts).some(v => v > 0)) {
                    return [counts.critico, counts.alto, counts.medio, counts.bajo, counts.observacion];
                }
            }

            // Fallback: contar menciones en el texto
            const report = (state.auditReport || '').toLowerCase();
            return [
                Math.max(1, (report.match(/crítico/g) || []).length),
                Math.max(1, (report.match(/\balto\b/g) || []).length),
                Math.max(1, (report.match(/\bmedio\b/g) || []).length),
                Math.max(0, (report.match(/\bbajo\b/g) || []).length),
                Math.max(0, (report.match(/observación/g) || []).length)
            ];
        }

        function extractComplianceData() {
            const report = (state.auditReport || '').toLowerCase();

            // Intentar extraer datos reales del informe
            const categories = [
                { label: 'Políticas IA', keywords: ['política', 'politica', 'a.2', 'políticas de ia'] },
                { label: 'Liderazgo', keywords: ['liderazgo', 'gobernanza', 'a.3', 'organización'] },
                { label: 'Planificación', keywords: ['planificación', 'planificacion', 'a.4', 'recursos'] },
                { label: 'Gestión Riesgos', keywords: ['riesgo', 'a.5', 'evaluación de riesgos'] },
                { label: 'Ciclo de Vida', keywords: ['ciclo de vida', 'a.6', 'desarrollo'] },
                { label: 'Datos', keywords: ['datos', 'a.7', 'calidad de datos', 'protección'] },
                { label: 'Monitoreo', keywords: ['monitoreo', 'a.8', 'supervisión', 'evaluación'] }
            ];

            const results = { labels: [], values: [] };

            // Buscar porcentajes en el informe asociados a cada categoría
            categories.forEach(cat => {
                let found = false;

                // Buscar patrones como "Políticas: 75%" o "cumplimiento de políticas 75%"
                for (const keyword of cat.keywords) {
                    const regex = new RegExp(keyword + '[^0-9]*?(\\d{1,3})\\s*%', 'i');
                    const match = report.match(regex);
                    if (match) {
                        results.labels.push(cat.label);
                        results.values.push(parseInt(match[1]));
                        found = true;
                        break;
                    }
                }

                // Si no se encontró porcentaje específico, estimar basado en menciones negativas
                if (!found) {
                    let negativeCount = 0;
                    cat.keywords.forEach(kw => {
                        const negativePatterns = [
                            new RegExp('no.*' + kw, 'gi'),
                            new RegExp('falta.*' + kw, 'gi'),
                            new RegExp('ausencia.*' + kw, 'gi'),
                            new RegExp(kw + '.*deficiente', 'gi'),
                            new RegExp(kw + '.*crítico', 'gi')
                        ];
                        negativePatterns.forEach(pattern => {
                            negativeCount += (report.match(pattern) || []).length;
                        });
                    });

                    results.labels.push(cat.label);
                    // Estimar cumplimiento basado en hallazgos negativos
                    const estimatedCompliance = Math.max(20, 80 - (negativeCount * 15));
                    results.values.push(Math.min(100, estimatedCompliance));
                }
            });

            // Si no se pudo extraer nada útil, usar valores por defecto más realistas basados en el nivel de cumplimiento
            if (results.labels.length === 0 || results.values.every(v => v === 80)) {
                const isIncipient = report.includes('no conforme') || report.includes('incipiente');
                const baseValue = isIncipient ? 35 : 65;

                return {
                    labels: ['Políticas IA', 'Liderazgo', 'Gestión Riesgos', 'Ciclo de Vida', 'Datos'],
                    values: [
                        baseValue + Math.floor(Math.random() * 15),
                        baseValue - 10 + Math.floor(Math.random() * 20),
                        baseValue - 15 + Math.floor(Math.random() * 20),
                        baseValue + Math.floor(Math.random() * 15),
                        baseValue - 5 + Math.floor(Math.random() * 15)
                    ]
                };
            }

            return results;
        }

        // ==================== AUDIT ENHANCEMENT FUNCTIONS ====================

        function toggleAuditChecklist(controlCode) {
            if (!state.auditChecklist[controlCode]) {
                state.auditChecklist[controlCode] = { checked: false, notes: '', evidence: [] };
            }
            state.auditChecklist[controlCode].checked = !state.auditChecklist[controlCode].checked;
            renderAuditChecklist();
        }

        function updateChecklistNotes(controlCode, notes) {
            if (!state.auditChecklist[controlCode]) {
                state.auditChecklist[controlCode] = { checked: false, notes: '', evidence: [] };
            }
            state.auditChecklist[controlCode].notes = notes;
        }

        function renderAuditChecklist() {
            const container = document.getElementById('audit-checklist-container');
            if (!container) return;

            const allControls = isoData.annexA.flatMap(cat => cat.controls);
            const completed = Object.values(state.auditChecklist).filter(c => c.checked).length;
            const total = allControls.length;
            const progress = Math.round((completed / total) * 100);

            let html = `
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-semibold text-slate-700">Progreso del Checklist</span>
                        <span class="text-sm font-bold text-blue-600">${completed}/${total} (${progress}%)</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full transition-all" style="width: ${progress}%"></div>
                    </div>
                </div>
            `;

            isoData.annexA.forEach(cat => {
                html += `
                    <div class="mb-4">
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">${cat.category}</h4>
                        <div class="space-y-2">
                            ${cat.controls.map(ctrl => {
                    const item = state.auditChecklist[ctrl.code] || { checked: false, notes: '' };
                    return `
                                    <div class="flex items-start gap-3 p-3 bg-slate-50 rounded-lg border ${item.checked ? 'border-green-300 bg-green-50' : 'border-slate-200'}">
                                        <input type="checkbox" 
                                            ${item.checked ? 'checked' : ''} 
                                            onchange="toggleAuditChecklist('${ctrl.code}')"
                                            class="w-5 h-5 mt-0.5 text-blue-600 rounded focus:ring-blue-500">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs font-mono font-bold text-slate-500">${ctrl.code}</span>
                                                <span class="text-sm font-medium text-slate-800">${ctrl.name}</span>
                                            </div>
                                            <textarea 
                                                placeholder="Notas de auditoría..."
                                                onchange="updateChecklistNotes('${ctrl.code}', this.value)"
                                                class="mt-2 w-full text-xs p-2 border border-slate-200 rounded resize-none focus:ring-1 focus:ring-blue-500"
                                                rows="2">${item.notes}</textarea>
                                        </div>
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function setAuditTemplate(template) {
            state.auditTemplate = template;
            const templates = {
                'internal': 'Auditoría Interna - Evaluación del Sistema de Gestión de IA',
                'external': 'Auditoría Externa - Certificación ISO 42001',
                'followup': 'Auditoría de Seguimiento - Verificación de Acciones Correctivas'
            };
            if (!state.auditFocus) {
                state.auditFocus = templates[template];
                const focusEl = document.getElementById('audit-focus');
                if (focusEl) focusEl.value = state.auditFocus;
            }
            renderMainContent();
        }

        function addEvidenceToControl(controlCode) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf,.docx,.txt,image/*';
            input.onchange = function (e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (event) {
                    if (!state.evidencesByControl[controlCode]) {
                        state.evidencesByControl[controlCode] = [];
                    }
                    state.evidencesByControl[controlCode].push({
                        name: file.name,
                        type: file.type,
                        data: event.target.result,
                        date: new Date().toISOString()
                    });
                    renderEvidencesByControl();
                };

                if (file.type.startsWith('image/')) {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function renderEvidencesByControl() {
            const container = document.getElementById('evidences-by-control-container');
            if (!container) return;

            let html = '<div class="space-y-4">';
            Object.entries(state.evidencesByControl).forEach(([controlCode, evidences]) => {
                if (evidences.length === 0) return;
                html += `
                    <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                        <h4 class="text-sm font-bold text-slate-800 mb-2">${controlCode}</h4>
                        <div class="space-y-2">
                            ${evidences.map((ev, idx) => `
                                <div class="flex items-center justify-between p-2 bg-white rounded border">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="${ev.type.startsWith('image/') ? 'image' : 'file-text'}" class="w-4 h-4 text-blue-500"></i>
                                        <span class="text-xs text-slate-700">${ev.name}</span>
                                    </div>
                                    <button onclick="removeEvidence('${controlCode}', ${idx})" class="text-red-500 hover:text-red-700">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
            lucide.createIcons();
        }

        function removeEvidence(controlCode, index) {
            if (state.evidencesByControl[controlCode]) {
                state.evidencesByControl[controlCode].splice(index, 1);
                renderEvidencesByControl();
            }
        }

        function updateRiskMatrix(controlCode, likelihood, impact) {
            const existing = state.auditRiskMatrix.find(r => r.control === controlCode);
            if (existing) {
                existing.likelihood = likelihood;
                existing.impact = impact;
                existing.level = calculateRiskLevel(likelihood, impact);
            } else {
                state.auditRiskMatrix.push({
                    control: controlCode,
                    likelihood,
                    impact,
                    level: calculateRiskLevel(likelihood, impact)
                });
            }
            renderRiskMatrix();
        }

        function calculateRiskLevel(likelihood, impact) {
            const matrix = {
                'low': { 'low': 'bajo', 'medium': 'bajo', 'high': 'medio' },
                'medium': { 'low': 'bajo', 'medium': 'medio', 'high': 'alto' },
                'high': { 'low': 'medio', 'medium': 'alto', 'high': 'critico' }
            };
            return matrix[likelihood]?.[impact] || 'medio';
        }

        function renderRiskMatrix() {
            const container = document.getElementById('risk-matrix-container');
            if (!container) return;

            const levels = { 'bajo': 0, 'medio': 0, 'alto': 0, 'critico': 0 };
            state.auditRiskMatrix.forEach(r => levels[r.level]++);

            container.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div class="bg-green-100 border-2 border-green-300 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-green-700">${levels.bajo}</div>
                        <div class="text-xs text-green-600">Riesgo Bajo</div>
                    </div>
                    <div class="bg-yellow-100 border-2 border-yellow-300 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-yellow-700">${levels.medio}</div>
                        <div class="text-xs text-yellow-600">Riesgo Medio</div>
                    </div>
                    <div class="bg-orange-100 border-2 border-orange-300 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-orange-700">${levels.alto}</div>
                        <div class="text-xs text-orange-600">Riesgo Alto</div>
                    </div>
                    <div class="bg-red-100 border-2 border-red-300 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-red-700">${levels.critico}</div>
                        <div class="text-xs text-red-600">Riesgo Crítico</div>
                    </div>
                </div>
            `;
        }

        function nextAuditStep() {
            state.auditCurrentStep++;
            renderAuditAssistant();
        }

        function renderAuditAssistant() {
            const container = document.getElementById('audit-assistant-container');
            if (!container) return;

            const steps = [
                { title: 'Planificación', desc: 'Define el alcance y objetivos de la auditoría', icon: 'clipboard' },
                { title: 'Preparación', desc: 'Revisa documentación y prepara checklist', icon: 'folder-open' },
                { title: 'Ejecución', desc: 'Realiza entrevistas y evalúa controles', icon: 'users' },
                { title: 'Hallazgos', desc: 'Documenta no conformidades y observaciones', icon: 'search' },
                { title: 'Informe', desc: 'Genera el informe final con conclusiones', icon: 'file-text' }
            ];

            const current = steps[state.auditCurrentStep] || steps[4];

            container.innerHTML = `
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="p-3 bg-blue-600 rounded-xl text-white">
                            <i data-lucide="${current.icon}" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-blue-900">Paso ${state.auditCurrentStep + 1}: ${current.title}</h4>
                            <p class="text-sm text-blue-700">${current.desc}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        ${steps.map((s, i) => `
                            <div class="flex-1 h-2 rounded-full ${i <= state.auditCurrentStep ? 'bg-blue-600' : 'bg-blue-200'}"></div>
                        `).join('')}
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button onclick="nextAuditStep()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
                            ${state.auditCurrentStep < 4 ? 'Siguiente Paso →' : 'Finalizar'}
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function saveAuditToHistory() {
            if (!state.auditReport) return;

            const auditRecord = {
                id: Date.now(),
                date: new Date().toISOString(),
                focus: state.auditFocus,
                template: state.auditTemplate,
                report: state.auditReport,
                checklist: state.auditChecklist,
                riskMatrix: state.auditRiskMatrix,
                summary: {
                    totalControls: Object.keys(state.auditChecklist).length,
                    completed: Object.values(state.auditChecklist).filter(c => c.checked).length,
                    risks: state.auditRiskMatrix.length
                }
            };

            state.auditHistory.unshift(auditRecord);
            if (state.auditHistory.length > 10) state.auditHistory.pop(); // Keep last 10

            showToast('Auditoría guardada en historial', 'success');
        }

        function compareWithPreviousAudit(auditId) {
            const previous = state.auditHistory.find(a => a.id === auditId);
            if (!previous) return;

            const currentCompleted = Object.values(state.auditChecklist).filter(c => c.checked).length;
            const previousCompleted = previous.summary.completed;
            const improvement = currentCompleted - previousCompleted;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-slate-800">Comparativa de Auditorías</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-slate-400 hover:text-slate-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div class="bg-slate-50 p-4 rounded-xl">
                            <div class="text-sm text-slate-500 mb-1">Auditoría Anterior</div>
                            <div class="text-3xl font-bold text-slate-700">${previousCompleted}</div>
                            <div class="text-xs text-slate-400">controles verificados</div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-xl">
                            <div class="text-sm text-blue-500 mb-1">Auditoría Actual</div>
                            <div class="text-3xl font-bold text-blue-700">${currentCompleted}</div>
                            <div class="text-xs text-blue-400">controles verificados</div>
                        </div>
                    </div>
                    <div class="p-4 rounded-xl ${improvement >= 0 ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
                        <div class="flex items-center gap-3">
                            <i data-lucide="${improvement >= 0 ? 'trending-up' : 'trending-down'}" class="w-8 h-8 ${improvement >= 0 ? 'text-green-600' : 'text-red-600'}"></i>
                            <div>
                                <div class="font-bold ${improvement >= 0 ? 'text-green-800' : 'text-red-800'}">
                                    ${improvement >= 0 ? '+' : ''}${improvement} controles
                                </div>
                                <div class="text-sm ${improvement >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${improvement >= 0 ? 'Mejora respecto a la auditoría anterior' : 'Disminución en cobertura'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        function showAuditHistory() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-3xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-slate-800">Historial de Auditorías</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-slate-400 hover:text-slate-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    ${state.auditHistory.length === 0 ?
                    '<p class="text-slate-500 text-center py-8">No hay auditorías previas guardadas</p>' :
                    `<div class="space-y-3">
                            ${state.auditHistory.map(audit => `
                                <div class="p-4 border border-slate-200 rounded-xl hover:bg-slate-50 transition-colors">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-bold text-slate-800">${new Date(audit.date).toLocaleDateString()}</div>
                                            <div class="text-sm text-slate-500">${audit.focus.substring(0, 60)}...</div>
                                            <div class="flex gap-4 mt-2 text-xs text-slate-400">
                                                <span>${audit.summary.completed}/${audit.summary.totalControls} controles</span>
                                                <span>${audit.summary.risks} riesgos</span>
                                            </div>
                                        </div>
                                        <button onclick="compareWithPreviousAudit(${audit.id})" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-xs hover:bg-blue-200">
                                            Comparar
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`
                }
                </div>
            `;
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        function resetAudit() {
            state.auditDocuments = [];
            state.auditImages = [];
            state.auditNotes = '';
            state.auditFocus = '';
            state.auditReport = null;
            state.auditCharts = null;
            state.auditExtendedAnalysis = null;
            state.auditNotebookUrl = '';
            state.auditChecklist = {};
            state.auditTemplate = 'internal';
            state.auditCurrentStep = 0;
            state.auditRiskMatrix = [];
            state.evidencesByControl = {};
            renderMainContent();
        }

        function openNotebookExtension() {
            // Create modal HTML with file picker
            const modalHTML = `
                <div id="notebook-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fadeIn">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 animate-slideUp">
                        <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-6 rounded-t-2xl">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-white/20 rounded-lg">
                                    <i data-lucide="brain" class="w-6 h-6 text-white"></i>
                                </div>
                                <h3 class="text-xl font-bold text-white">Extender Análisis con NotebookLM Local</h3>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                                <p class="text-sm text-blue-900 font-semibold mb-2">📋 Instrucciones:</p>
                                <ol class="text-sm text-blue-800 ml-4 space-y-1">
                                    <li>Haz clic en "Seleccionar Archivos del Notebook"</li>
                                    <li>Navega a la carpeta <code class="bg-blue-100 px-1 rounded">NoteBook_Cerebro_ISO 42001</code></li>
                                    <li>Selecciona <strong>todos los archivos .md</strong> (Ctrl+A para seleccionar todos)</li>
                                    <li>Haz clic en "Generar Análisis Extendido"</li>
                                </ol>
                            </div>
                            
                            <input 
                                type="file" 
                                id="notebook-files-input" 
                                multiple
                                accept=".md,.markdown"
                                class="hidden"
                            />
                            
                            <button 
                                onclick="document.getElementById('notebook-files-input').click()"
                                class="w-full px-6 py-4 bg-slate-100 border-2 border-dashed border-slate-300 rounded-lg hover:bg-slate-50 hover:border-purple-400 transition-all mb-4 flex items-center justify-center gap-3"
                            >
                                <i data-lucide="folder-open" class="w-5 h-5 text-slate-600"></i>
                                <span class="font-semibold text-slate-700">Seleccionar Archivos del Notebook</span>
                            </button>
                            
                            <div id="files-selected-info" class="hidden bg-green-50 border-l-4 border-green-500 p-3 mb-4">
                                <p class="text-sm text-green-800">
                                    <i data-lucide="check-circle" class="w-4 h-4 inline mr-1"></i>
                                    <span id="files-count">0</span> archivos seleccionados
                                </p>
                            </div>
                            
                            <p class="text-xs text-slate-500 mt-2">💡 Los archivos se procesarán localmente. El contenido se enviará a Gemini para generar el análisis extendido.</p>
                        </div>
                        <div class="flex gap-3 p-6 pt-0">
                            <button 
                                onclick="closeNotebookModal()" 
                                class="flex-1 px-6 py-3 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors font-semibold"
                            >
                                Cancelar
                            </button>
                            <button 
                                id="generate-analysis-btn"
                                onclick="confirmNotebookExtension()" 
                                disabled
                                class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all font-semibold shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Generar Análisis Extendido
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();

            // Handle file selection
            const fileInput = document.getElementById('notebook-files-input');
            const filesInfo = document.getElementById('files-selected-info');
            const filesCount = document.getElementById('files-count');
            const generateBtn = document.getElementById('generate-analysis-btn');

            fileInput.addEventListener('change', (e) => {
                const files = e.target.files;
                if (files.length > 0) {
                    filesCount.textContent = files.length;
                    filesInfo.classList.remove('hidden');
                    generateBtn.disabled = false;
                    lucide.createIcons();
                } else {
                    filesInfo.classList.add('hidden');
                    generateBtn.disabled = true;
                }
            });
        }

        function closeNotebookModal() {
            const modal = document.getElementById('notebook-modal');
            if (modal) modal.remove();
        }

        async function confirmNotebookExtension() {
            const fileInput = document.getElementById('notebook-files-input');
            const files = fileInput?.files;

            if (!files || files.length === 0) {
                showToast('error', 'Por favor selecciona archivos del notebook');
                return;
            }

            // Store files count for later use
            state.auditNotebookUrl = `Local: ${files.length} archivos`;

            closeNotebookModal();
            showToast('info', `Leyendo ${files.length} archivos del notebook...`);

            try {
                // Read all files
                const fileContents = [];
                let totalChars = 0;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];

                    // Only process markdown files
                    if (!file.name.endsWith('.md') && !file.name.endsWith('.markdown')) {
                        continue;
                    }

                    const content = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (e) => reject(e);
                        reader.readAsText(file);
                    });

                    fileContents.push({
                        filename: file.name,
                        content: content,
                        size: content.length
                    });

                    totalChars += content.length;
                }

                if (fileContents.length === 0) {
                    throw new Error('No se encontraron archivos markdown válidos');
                }

                showToast('success', `${fileContents.length} archivos leídos (${Math.round(totalChars / 1000)}K caracteres). Generando análisis...`);

                // Call the analysis function with the file contents
                await extendAuditWithNotebook(fileContents);

            } catch (error) {
                console.error('Error leyendo archivos:', error);
                showToast('error', `Error: ${error.message}`);
            }
        }

        async function extendAuditWithNotebook(fileContents) {
            if (!state.apiKey) {
                showToast('error', 'Configura tu API Key primero');
                return;
            }

            if (!state.auditReport) {
                showToast('error', 'Primero debes generar un informe de auditoría');
                return;
            }

            if (!fileContents || fileContents.length === 0) {
                showToast('error', 'No se proporcionaron archivos del notebook');
                return;
            }

            showToast('info', 'Procesando contenido del notebook...');

            try {
                // Combine all file contents
                let notebookContent = '';
                const sourcesList = [];

                fileContents.forEach((file, index) => {
                    // Extract title from filename
                    const title = file.filename
                        .replace('Source_', '')
                        .replace('.md', '')
                        .replace(/_/g, ' ');

                    sourcesList.push(title);

                    // Add file content with header
                    notebookContent += `\n\n### FUENTE ${index + 1}: ${title}\n\n`;
                    notebookContent += file.content.substring(0, 5000); // Limit each file to 5000 chars
                    notebookContent += '\n\n---\n';
                });

                // Limit total content to avoid token limits
                const maxChars = 50000;
                if (notebookContent.length > maxChars) {
                    notebookContent = notebookContent.substring(0, maxChars);
                    showToast('info', `Contenido limitado a ${maxChars / 1000}K caracteres para optimizar el análisis`);
                }

                showToast('info', 'Generando análisis extendido con Gemini...');

                // Generate extended analysis with real notebook content
                const prompt = `Actúa como Auditor Líder de Certificación ISO/IEC 42001:2023 consultor senior. Tu tono debe ser neutral, técnico y 100% fiel al lenguaje de gestión de riesgos.

REGLAS DE LENGUAJE (HACIA LA PERFECCIÓN ISO):
1. TERMINOLOGÍA DE GESTIÓN: No uses "cumplimiento mandatorio" o "adhesión obligatoria". Usa "requisitos aplicables", "gestión sistemática" o "implementación coherente".
2. NEUTRALIDAD TECNOLÓGICA: Evita términos prescriptivos que sugieran herramientas específicas o automatización. No uses "medibles" (usa "definidos"), no uses "automáticamente" (usa "registrar o documentar") y no uses "idéntica" (usa "de manera consistente").
3. EVITAR ABSOLUTOS: No digas que se deben documentar "todas" las transformaciones. Usa "transformaciones relevantes" o "datos significativos", según el enfoque de riesgo.
4. ENFOQUE "CONSIDERAR": Para controles de análisis, usa "la organización debería considerar mecanismos" en lugar de prescribir su implementación técnica.
5. DIFERENCIACIÓN: Mantén la separación clara entre "Requisito Normativo" (Anexo A) y "Guía de Implementación" (Anexo B). El Anexo A oficial termina en A.10.
6. EVIDENCIA NO PRESCRIPTIVA: No exijas formatos específicos de documentos. En lugar de "Bias Assessment Reports" usa "evidencia de análisis de sesgos". No exijas nombres de artefactos específicos, describe el tipo de evidencia que demuestra el control.
7. TÉRMINOS TÉCNICOS OPCIONALES: Términos como "data drift", "reweighting", "dataset final de entrenamiento" pueden mencionarse SOLO como ejemplos entre paréntesis, nunca como requisitos. La norma ISO 42001 es agnóstica de técnica.
8. GESTIÓN DE SESGOS: La norma exige gestionar el riesgo de sesgo, pero NO exige informes formales con nombres específicos. Usa "evidencia de que se analizan y mitigan los sesgos" en lugar de prescribir formatos.
9. CRITERIOS VS MÉTRICAS: No uses "métricas de calidad" (implica medición cuantitativa obligatoria). Usa "criterios de calidad" o "requisitos de calidad definidos". La norma no exige KPIs técnicos formales.
10. UMBRALES Y ALERTAS: No prescribas "umbrales de alerta" o "umbrales técnicos" como obligatorios. Usa "criterios definidos para detectar degradación" o "mecanismos apropiados según el enfoque de riesgo".
11. PROPORCIONALIDAD: Para exigencias técnicas complejas (ej. reconstrucción de predicciones, trazabilidad completa), añade "cuando sea razonablemente posible y proporcional al nivel de riesgo del sistema".
12. NIVEL DE RIESGO NEUTRO: No asumas que todos los sistemas son críticos. Evita lenguaje que implique obligaciones de sistemas de alto riesgo para todos los casos. Adapta la granularidad al enfoque de riesgo.

INFORME DE AUDITORÍA ORIGINAL:
${state.auditReport.substring(0, 2500)}

ENFOQUE DE AUDITORÍA:
${state.auditFocus}

FUENTES DEL NOTEBOOKLM (${fileContents.length} archivos):
${sourcesList.slice(0, 20).map((s, i) => `${i + 1}. ${s}`).join('\n')}

CONTENIDO REAL DEL NOTEBOOKLM:
${notebookContent}

INSTRUCCIONES DE INTEGRIDAD:
Genera un análisis extendido basándote ESPECÍFICAMENTE en el contenido real del NotebookLM y la norma oficial ISO 42001:2023 (Anexo A: A.2-A.10).
Este contenido proviene de ${fileContents.length} archivos markdown locales con fuentes sobre ISO 42001.

Debes:
1. Identificar información relevante del NotebookLM que complemente el informe de auditoría
2. Citar fuentes específicas del notebook por su nombre/título
3. Proporcionar insights adicionales basados en las fuentes del notebook
4. Hacer recomendaciones fundamentadas en el conocimiento del notebook

El análisis debe incluir:

## INSIGHTS ADICIONALES DEL NOTEBOOKLM
- Perspectivas específicas encontradas en las fuentes del notebook
- Información relevante que complementa el informe de auditoría
- Conexiones entre el contenido del notebook y los hallazgos de la auditoría

## RECOMENDACIONES AVANZADAS
- Acciones específicas basadas en el conocimiento del notebook
- Roadmap de implementación fundamentado en las fuentes
- KPIs y métricas sugeridas según las mejores prácticas encontradas

## REFERENCIAS DEL NOTEBOOK
Crea una tabla con las fuentes más relevantes del NotebookLM y cómo se relacionan con las cláusulas de ISO 42001.

| Fuente del Notebook | Cláusula ISO 42001 | Relevancia |
|---------------------|-------------------|------------|

Formato: Markdown profesional. IMPORTANTE: Menciona explícitamente cuando uses información del NotebookLM y cita las fuentes específicas por nombre.`;

                const response = await callGemini(prompt);
                state.auditExtendedAnalysis = response;
                renderMainContent();

                setTimeout(() => {
                    renderExtendedAnalysis();
                    lucide.createIcons();
                }, 100);

                showToast('success', '✅ Análisis extendido generado con contenido REAL del NotebookLM local');
            } catch (error) {
                console.error('Error en extendAuditWithNotebook:', error);
                showToast('error', `Error: ${error.message}`);
            }
        }

        function extractNotebookContent(html) {
            // Create a temporary DOM parser
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Remove script and style tags
            const scripts = doc.querySelectorAll('script, style, noscript');
            scripts.forEach(el => el.remove());

            // Try to find main content areas (NotebookLM specific selectors)
            let content = '';

            // Try various selectors that might contain notebook content
            const selectors = [
                '[role="main"]',
                'main',
                '.notebook-content',
                '.sources',
                '.notes',
                'article',
                '[data-content]'
            ];

            for (const selector of selectors) {
                const elements = doc.querySelectorAll(selector);
                if (elements.length > 0) {
                    elements.forEach(el => {
                        content += el.textContent + '\n\n';
                    });
                }
            }

            // If no specific selectors found, get body text
            if (!content || content.length < 100) {
                content = doc.body?.textContent || '';
            }

            // Clean up the content
            content = content
                .replace(/\s+/g, ' ')  // Normalize whitespace
                .replace(/\n\s*\n/g, '\n\n')  // Remove excessive newlines
                .trim();

            return content;
        }

        function renderExtendedAnalysis() {
            const contentDiv = document.getElementById('extended-analysis-content');
            if (!contentDiv || !state.auditExtendedAnalysis) return;

            if (typeof marked !== 'undefined') {
                contentDiv.innerHTML = marked.parse(state.auditExtendedAnalysis);
            } else {
                contentDiv.innerHTML = state.auditExtendedAnalysis
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            }
        }

        function exportAuditReport(format) {
            if (!state.auditReport) return;

            if (format === 'md') {
                // Download as Markdown
                const blob = new Blob([state.auditReport], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Informe_Auditoria_ISO42001_${new Date().toISOString().split('T')[0]}.md`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('success', 'Informe descargado como Markdown');
            } else if (format === 'pdf') {
                generateExecutivePdf();
            }
        }

        function escapeHtml(value) {
            if (!value) return '';
            return value
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function stripMarkdown(value) {
            if (!value) return '';
            return value
                .replace(/!\[.*?\]\(.*?\)/g, '')
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
                .replace(/`{1,3}[^`]*`{1,3}/g, '')
                .replace(/[*_~>#]/g, '')
                .replace(/\s{2,}/g, ' ')
                .trim();
        }

        function parseReportSections(markdown) {
            const sections = {};
            let current = 'Intro';
            sections[current] = [];

            markdown.split(/\r?\n/).forEach(line => {
                const headingMatch = line.match(/^\s*#{1,6}\s+(.*)$/);
                if (headingMatch) {
                    current = headingMatch[1].trim() || 'Seccion';
                    if (!sections[current]) sections[current] = [];
                } else {
                    sections[current].push(line);
                }
            });

            Object.keys(sections).forEach(key => {
                sections[key] = sections[key].join('\n').trim();
            });

            return sections;
        }

        function findSectionContent(sections, keywords) {
            const entries = Object.entries(sections);
            for (const [title, content] of entries) {
                const normalized = title.toLowerCase();
                if (keywords.some(keyword => normalized.includes(keyword))) {
                    return content;
                }
            }
            return '';
        }

        function getParagraphs(text, maxCount) {
            if (!text) return [];
            const raw = text.split(/\n\s*\n/).map(chunk => stripMarkdown(chunk)).filter(Boolean);
            return raw.slice(0, maxCount);
        }

        function getBullets(text, maxCount) {
            if (!text) return [];
            const lines = text.split(/\r?\n/);
            const bullets = lines
                .map(line => line.trim())
                .filter(line => /^(-|\*|\d+[\).])\s+/.test(line))
                .map(line => line.replace(/^(-|\*|\d+[\).])\s+/, ''))
                .map(item => stripMarkdown(item))
                .filter(Boolean);

            if (bullets.length > 0) return bullets.slice(0, maxCount);

            const fallback = stripMarkdown(text);
            return fallback ? fallback.split('. ').slice(0, maxCount).map(item => item.trim()).filter(Boolean) : [];
        }

        function parseMarkdownTable(text) {
            if (!text) return [];

            const lines = text.split(/\r?\n/);
            const tableRows = [];
            let inTable = false;
            let headers = [];

            for (const line of lines) {
                const trimmed = line.trim();

                // Detectar línea de tabla (contiene |)
                if (trimmed.includes('|')) {
                    const cells = trimmed.split('|').map(cell => cell.trim()).filter(Boolean);

                    // Saltar línea separadora (contiene solo - y :)
                    if (cells.every(cell => /^[-:]+$/.test(cell))) {
                        inTable = true;
                        continue;
                    }

                    if (!inTable && cells.length > 0) {
                        // Esta es la fila de encabezados
                        headers = cells;
                        continue;
                    }

                    if (inTable && cells.length > 0) {
                        // Esta es una fila de datos
                        const row = {};
                        cells.forEach((cell, idx) => {
                            const header = headers[idx] || `col${idx}`;
                            row[header.toLowerCase()] = stripMarkdown(cell);
                        });
                        tableRows.push(row);
                    }
                } else if (inTable && trimmed === '') {
                    // Fin de la tabla
                    inTable = false;
                }
            }

            return tableRows;
        }

        function getDetailedFindings(sections) {
            // Buscar la sección de hallazgos detallados
            const findingsText = findSectionContent(sections, ['hallazgos detallados', 'hallazgos', '2. hallazgos']);

            if (!findingsText) return [];

            // Parsear la tabla de hallazgos
            const tableData = parseMarkdownTable(findingsText);

            // Mapear los datos a un formato consistente
            return tableData.map(row => ({
                id: row.id || row['id'] || '',
                hallazgo: row.hallazgo || row['hallazgo'] || '',
                severidad: row.severidad || row['severidad'] || '',
                control: row['control iso 42001'] || row.control || row['requisito normativo iso 42001'] || row['control'] || '',
                evidencia: row.evidencia || row['evidencia'] || row['evidencia documental'] || ''
            })).filter(row => row.id || row.hallazgo);
        }

        function getNumberedFindings(text, maxCount) {
            if (!text) return [];

            const lines = text.split(/\r?\n/);
            const findings = [];
            let currentFinding = null;

            for (const line of lines) {
                const trimmed = line.trim();

                // Detectar inicio de hallazgo numerado (1. **Título**: descripción)
                const numberedMatch = trimmed.match(/^(\d+)\.\s*\*\*([^*:]+)\*\*:?\s*(.*)$/);
                if (numberedMatch) {
                    if (currentFinding) findings.push(currentFinding);
                    currentFinding = {
                        num: numberedMatch[1],
                        title: numberedMatch[2].trim(),
                        desc: numberedMatch[3].trim()
                    };
                    continue;
                }

                // Detectar formato alternativo (- **Título**: descripción)
                const bulletMatch = trimmed.match(/^[-*]\s*\*\*([^*:]+)\*\*:?\s*(.*)$/);
                if (bulletMatch) {
                    if (currentFinding) findings.push(currentFinding);
                    currentFinding = {
                        num: (findings.length + 1).toString(),
                        title: bulletMatch[1].trim(),
                        desc: bulletMatch[2].trim()
                    };
                    continue;
                }

                // Continuar descripción si estamos en un hallazgo
                if (currentFinding && trimmed && !trimmed.startsWith('#')) {
                    currentFinding.desc += ' ' + stripMarkdown(trimmed);
                }
            }

            if (currentFinding) findings.push(currentFinding);

            return findings.slice(0, maxCount);
        }

        function extractRealFindingsData(sections) {
            const findings = getDetailedFindings(sections);
            const counts = { critico: 0, alto: 0, medio: 0, bajo: 0, observacion: 0 };

            findings.forEach(f => {
                const sev = (f.severidad || '').toLowerCase();
                if (sev.includes('crítico') || sev.includes('critico')) counts.critico++;
                else if (sev.includes('alto')) counts.alto++;
                else if (sev.includes('medio')) counts.medio++;
                else if (sev.includes('bajo')) counts.bajo++;
                else if (sev.includes('observación') || sev.includes('observacion')) counts.observacion++;
            });

            // Si no hay datos de la tabla, usar el conteo simple del texto
            if (Object.values(counts).every(v => v === 0)) {
                const report = (state.auditReport || '').toLowerCase();
                return [
                    (report.match(/crítico/g) || []).length || 0,
                    (report.match(/\balto\b/g) || []).length || 0,
                    (report.match(/\bmedio\b/g) || []).length || 0,
                    (report.match(/\bbajo\b/g) || []).length || 0,
                    (report.match(/observación/g) || []).length || 0
                ];
            }

            return [counts.critico, counts.alto, counts.medio, counts.bajo, counts.observacion];
        }

        function getSeverityClass(severity) {
            const sev = (severity || '').toLowerCase();
            if (sev.includes('crítico') || sev.includes('critico')) return 'pdf-severity-critico';
            if (sev.includes('alto')) return 'pdf-severity-alto';
            if (sev.includes('medio')) return 'pdf-severity-medio';
            if (sev.includes('bajo')) return 'pdf-severity-bajo';
            return 'pdf-severity-observacion';
        }

        function getCanvasDataUrl(id) {
            const canvas = document.getElementById(id);
            if (!canvas) return '';
            try {
                return canvas.toDataURL('image/png');
            } catch (error) {
                return '';
            }
        }

        function buildExecutiveReportElement() {
            const existing = document.getElementById('executive-report-export');
            if (existing) existing.remove();

            // Obtener el contenido HTML renderizado directamente del módulo
            const reportContentDiv = document.getElementById('audit-report-content');
            const renderedReportHtml = reportContentDiv ? reportContentDiv.innerHTML : '';

            // Obtener imágenes de los gráficos
            const findingsImg = getCanvasDataUrl('findings-chart');
            const complianceImg = getCanvasDataUrl('compliance-chart');

            const reportDate = new Date().toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Datos para métricas
            const sections = parseReportSections(state.auditReport || '');
            const findingsData = extractFindingsData();
            const complianceData = extractComplianceData();
            const complianceAverage = Math.round(
                complianceData.values.reduce((sum, value) => sum + value, 0) / complianceData.values.length
            );
            const totalFindings = findingsData.reduce((sum, value) => sum + value, 0);

            const severityLabels = ['Crítico', 'Alto', 'Medio', 'Bajo', 'Observación'];

            const container = document.createElement('div');
            container.id = 'executive-report-export';
            container.className = 'pdf-executive';
            container.style.position = 'fixed';
            container.style.left = '-10000px';
            container.style.top = '0';
            container.style.zIndex = '-1';

            container.innerHTML = `
                <!-- PORTADA -->
                <section class="pdf-page">
                    <div class="pdf-banner">
                        <div class="pdf-kicker">Informe de Auditoría Interna</div>
                        <h1>ISO/IEC 42001:2023</h1>
                        <p>Sistemas de Gestión de la Inteligencia Artificial (AIMS)</p>
                    </div>

                    <div class="pdf-meta" style="margin-top: 40px;">
                        <div class="pdf-meta-card">
                            <span>Enfoque de Auditoría</span>
                            ${escapeHtml(state.auditFocus || 'Auditoría integral ISO 42001')}
                        </div>
                        <div class="pdf-meta-card">
                            <span>Fecha del Informe</span>
                            ${escapeHtml(reportDate)}
                        </div>
                    </div>

                    <div class="pdf-meta" style="margin-top: 16px;">
                        <div class="pdf-meta-card">
                            <span>Documentos Analizados</span>
                            ${escapeHtml(state.auditDocuments.length.toString())} documentos
                        </div>
                        <div class="pdf-meta-card">
                            <span>Imágenes/Evidencias</span>
                            ${escapeHtml(state.auditImages.length.toString())} imágenes
                        </div>
                    </div>

                    <div class="pdf-divider" style="margin-top: 40px;"></div>

                    <div class="pdf-section-title">Métricas Clave</div>
                    <div class="pdf-grid-3">
                        <div class="pdf-stat">
                            <div class="pdf-stat-label">Hallazgos Totales</div>
                            <div class="pdf-stat-value">${escapeHtml(totalFindings.toString())}</div>
                        </div>
                        <div class="pdf-stat">
                            <div class="pdf-stat-label">Cumplimiento Promedio</div>
                            <div class="pdf-stat-value">${escapeHtml(complianceAverage.toString())}%</div>
                        </div>
                        <div class="pdf-stat">
                            <div class="pdf-stat-label">Áreas Evaluadas</div>
                            <div class="pdf-stat-value">${escapeHtml(complianceData.labels.length.toString())}</div>
                        </div>
                    </div>

                    <div class="pdf-divider"></div>

                    <div class="pdf-section-title">Distribución por Severidad</div>
                    <div class="pdf-grid-3">
                        ${severityLabels.map((label, index) => `
                            <div class="pdf-stat">
                                <div class="pdf-stat-label">${escapeHtml(label)}</div>
                                <div class="pdf-stat-value" style="color: ${index === 0 ? '#dc2626' : index === 1 ? '#ea580c' : index === 2 ? '#ca8a04' : index === 3 ? '#2563eb' : '#64748b'}">${escapeHtml(findingsData[index].toString())}</div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="pdf-footer">
                        <span>ISO/IEC 42001 - Auditoría Interna</span>
                        <span>Portada | ${escapeHtml(reportDate)}</span>
                    </div>
                </section>

                <!-- GRÁFICOS -->
                <section class="pdf-page">
                    <div class="pdf-section-subtitle">Indicadores Visuales</div>
                    <div class="pdf-title">Métricas de Auditoría</div>

                    <div class="pdf-columns" style="margin-top: 24px;">
                        <div class="pdf-card">
                            <div class="pdf-section-subtitle">Distribución de Hallazgos</div>
                            ${findingsImg ? `<img src="${findingsImg}" class="pdf-chart" alt="Distribución de hallazgos">` : '<p class="pdf-paragraph">Gráfico no disponible.</p>'}
                        </div>
                        <div class="pdf-card">
                            <div class="pdf-section-subtitle">Nivel de Cumplimiento</div>
                            ${complianceImg ? `<img src="${complianceImg}" class="pdf-chart" alt="Cumplimiento por área">` : '<p class="pdf-paragraph">Gráfico no disponible.</p>'}
                        </div>
                    </div>

                    <div class="pdf-divider"></div>

                    <div class="pdf-section-title">Cumplimiento por Área</div>
                    ${complianceData.labels.map((label, idx) => {
                const value = complianceData.values[idx];
                const color = value >= 80 ? '#10b981' : value >= 50 ? '#eab308' : '#ef4444';
                return `
                            <div class="pdf-compliance-item">
                                <span class="pdf-compliance-label">${escapeHtml(label)}</span>
                                <div class="pdf-compliance-bar">
                                    <div class="pdf-compliance-fill" style="width: ${value}%; background: ${color};"></div>
                                </div>
                                <span class="pdf-compliance-value" style="color: ${color};">${value}%</span>
                            </div>
                        `;
            }).join('')}

                    <div class="pdf-footer">
                        <span>Métricas de Auditoría</span>
                        <span>Gráficos | ${escapeHtml(reportDate)}</span>
                    </div>
                </section>

                <!-- INFORME COMPLETO - Contenido renderizado del módulo -->
                <section class="pdf-page pdf-report-full">
                    <div class="pdf-section-subtitle">Informe Completo</div>
                    <div class="pdf-title">Informe de Auditoría ISO/IEC 42001</div>
                    <div class="pdf-divider"></div>
                    <div class="pdf-report-content">
                        ${renderedReportHtml || '<p class="pdf-paragraph">No hay contenido de informe disponible.</p>'}
                    </div>
                    <div class="pdf-footer">
                        <span>Informe Completo de Auditoría</span>
                        <span>${escapeHtml(reportDate)}</span>
                    </div>
                </section>

                ${state.auditExtendedAnalysis ? `
                <!-- ANÁLISIS EXTENDIDO -->
                <section class="pdf-page">
                    <div class="pdf-section-subtitle">Análisis Adicional</div>
                    <div class="pdf-title">Análisis Extendido con NotebookLM</div>
                    <div class="pdf-divider"></div>
                    <div class="pdf-report-content">
                        ${typeof marked !== 'undefined' ? marked.parse(state.auditExtendedAnalysis) : state.auditExtendedAnalysis}
                    </div>
                    <div class="pdf-footer">
                        <span>Análisis Extendido</span>
                        <span>${escapeHtml(reportDate)}</span>
                    </div>
                </section>
                ` : ''}
            `;

            return container;
        }

        async function generateExecutivePdf() {
            if (typeof html2canvas === 'undefined' || !window.jspdf?.jsPDF) {
                showToast('error', 'No se pudieron cargar las librerias para PDF');
                return;
            }

            try {
                showToast('info', 'Generando PDF completo... Por favor espera.');

                const executiveElement = buildExecutiveReportElement();
                document.body.appendChild(executiveElement);

                // Hacer visible temporalmente para renderizado
                executiveElement.style.position = 'absolute';
                executiveElement.style.left = '0';
                executiveElement.style.top = '0';
                executiveElement.style.zIndex = '-1';
                executiveElement.style.opacity = '0';

                // Esperar a que el DOM se actualice
                await new Promise(resolve => setTimeout(resolve, 300));

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'pt', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                // Obtener todas las secciones/páginas
                const pages = executiveElement.querySelectorAll('.pdf-page');

                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i];

                    // Capturar cada página individualmente
                    const canvas = await html2canvas(page, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        width: 794,
                        windowWidth: 794
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = pageWidth - 40; // Margen de 20pt a cada lado
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    if (i > 0) {
                        pdf.addPage();
                    }

                    // Si la imagen es más alta que la página, paginar
                    if (imgHeight <= pageHeight - 40) {
                        // Cabe en una página
                        pdf.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight, undefined, 'FAST');
                    } else {
                        // Necesita múltiples páginas
                        let heightLeft = imgHeight;
                        let position = 0;
                        let isFirst = true;

                        while (heightLeft > 0) {
                            if (!isFirst) {
                                pdf.addPage();
                            }

                            const yOffset = isFirst ? 20 : -(imgHeight - heightLeft) - 20;
                            pdf.addImage(imgData, 'PNG', 20, yOffset, imgWidth, imgHeight, undefined, 'FAST');

                            heightLeft -= (pageHeight - 40);
                            isFirst = false;
                        }
                    }

                    // Mostrar progreso
                    showToast('info', `Procesando página ${i + 1} de ${pages.length}...`);
                }

                pdf.save(`Informe_Ejecutivo_Auditoria_ISO42001_${new Date().toISOString().split('T')[0]}.pdf`);
                showToast('success', 'Informe PDF descargado exitosamente');
            } catch (error) {
                console.error('Error generando PDF:', error);
                showToast('error', 'Error al generar el PDF: ' + error.message);
            } finally {
                const executiveElement = document.getElementById('executive-report-export');
                if (executiveElement) executiveElement.remove();
            }
        }

        function openAiAssistant(title, content) {
            let contextText = "";
            if (Array.isArray(content)) {
                content.forEach(item => {
                    if (item.type === 'p' || item.type === 'note') contextText += item.text + "\n";
                    if (item.items || item.list) contextText += (item.items || item.list).join(", ") + "\n";
                });
            } else if (typeof content === 'string') {
                contextText = content;
            } else if (typeof content === 'object') {
                if (content.control) contextText += `Control: ${content.control}\n`;
                if (content.guidance) contextText += `Guía: ${content.guidance}\n`;
                if (content.other) contextText += `Info: ${content.other}\n`;

                if (content.name && content.desc) contextText += `${content.name}: ${content.desc}\n`;

                if (content.std) contextText += `Estándar: ${content.std}\n`;
                if (content.sector) contextText += `Sector: ${content.sector}\n`;
                if (content.desc && !content.name) contextText += `${content.desc}\n`;

                if (!contextText) contextText = JSON.stringify(content, null, 2);
            }

            // Fallback
            if (!contextText) contextText = "Sin contenido específico.";

            state.aiContext = { title, content: contextText };
            document.getElementById('ai-modal').classList.remove('hidden');
            document.getElementById('ai-modal-context').innerText = `Contexto: ${title}`;
            document.getElementById('ai-response-container').innerHTML = ''; // Clear prev
            document.getElementById('ai-custom-query').value = '';
        }

        function closeAiModal() {
            document.getElementById('ai-modal').classList.add('hidden');
        }

        function handleAiKeyPress(e) {
            if (e.key === 'Enter') callContextualGemini('custom');
        }

        async function callContextualGemini(type) {
            console.log('callContextualGemini called with type:', type);

            if (!state.apiKey) {
                showToast('error', 'Falta API Key. Configúrala en el menú lateral.');
                return;
            }

            const input = document.getElementById('ai-custom-query');
            const customText = input ? input.value.trim() : '';

            // Validar texto vacío para consultas personalizadas
            if (type === 'custom' && !customText) {
                showToast('error', 'Escribe una pregunta antes de enviar');
                return;
            }

            // Validar que exista contexto
            if (!state.aiContext || !state.aiContext.title) {
                showToast('error', 'No hay contexto seleccionado. Abre una sección primero.');
                return;
            }

            // Guardar la pregunta del usuario antes de procesarla
            const userQuestion = customText;
            const questionLabel = type === 'summarize' ? 'Resumir requisitos' :
                type === 'checklist' ? 'Generar checklist' :
                    type === 'implementation' ? 'Guía de implementación' :
                        type === 'usecases' ? 'Casos prácticos' :
                            type === 'audit' ? 'Preguntas de auditoría' :
                                type === 'risks' ? 'Análisis de riesgos' :
                                    type === 'iso27001' ? 'Comparar con ISO 27001' :
                                        type === 'documents' ? 'Documentación requerida' : userQuestion;

            // Mostrar estado de carga en el botón
            const sendBtn = document.getElementById('ai-send-btn');
            const originalBtnHtml = sendBtn ? sendBtn.innerHTML : '';
            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>';
                sendBtn.classList.add('opacity-70', 'cursor-wait');
            }

            // Show loading en el área de respuesta
            const loadingEl = document.getElementById('ai-loading');
            if (loadingEl) loadingEl.classList.remove('hidden');

            // Mostrar indicador de "pensando" en el contenedor de respuesta
            const container = document.getElementById('ai-response-container');
            if (container) {
                container.innerHTML = `
                    <div class="flex items-center gap-3 p-4 bg-purple-50 rounded-xl border border-purple-100 animate-pulse">
                        <div class="w-8 h-8 bg-purple-200 rounded-full flex items-center justify-center">
                            <div class="w-4 h-4 border-2 border-purple-600 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                        <div>
                            <p class="text-purple-700 font-medium text-sm">Procesando tu consulta...</p>
                            <p class="text-purple-500 text-xs">Esto puede tomar unos segundos</p>
                        </div>
                    </div>
                `;
            }

            let prompt = `Eres un Asistente Experto en ISO/IEC 42001:2023 (Sistemas de Gestión de IA), Ciberseguridad e Inteligencia Artificial.

REGLAS OBLIGATORIAS:
1. SOLO puedes responder preguntas sobre: ISO 42001, ISO 27001, ciberseguridad, inteligencia artificial, gestión de riesgos de IA, auditoría de sistemas de IA, y temas relacionados.
2. Si la pregunta NO es sobre estos temas, responde EXACTAMENTE: "⚠️ Solo puedo responder preguntas sobre ISO 42001, ciberseguridad e inteligencia artificial. Tu pregunta está fuera de mi alcance."
3. RESPONDE DIRECTAMENTE la pregunta del usuario. No des explicaciones generales si el usuario hace una pregunta específica.
4. Sé conciso pero completo. Ve al punto.

CONTEXTO ACTUAL:
- Sección: ${state.aiContext.title}
- Información de referencia: ${state.aiContext.content}

`;
            if (type === 'summarize') {
                prompt += `TAREA: Resume los requisitos clave de la sección "${state.aiContext.title}". Sé conciso y lista los puntos principales.`;
            } else if (type === 'checklist') {
                prompt += `TAREA: Genera una checklist de auditoría para la sección "${state.aiContext.title}". Formato de lista con checkboxes.`;
            } else if (type === 'implementation') {
                prompt += `TAREA: Proporciona una guía práctica de implementación para "${state.aiContext.title}" con ejemplos concretos.`;
            } else if (type === 'usecases') {
                prompt += `TAREA: Proporciona 2-3 casos prácticos o ejemplos reales de aplicación de "${state.aiContext.title}" en organizaciones. Incluye el contexto, desafíos y soluciones.`;
            } else if (type === 'audit') {
                prompt += `TAREA: Genera 5-7 preguntas específicas que un auditor haría para evaluar el cumplimiento de "${state.aiContext.title}". Clasifica por criticidad (Alta/Media/Baja).`;
            } else if (type === 'risks') {
                prompt += `TAREA: Identifica los principales riesgos relacionados con "${state.aiContext.title}" y propone controles mitigadores según el Anexo A de ISO 42001.`;
            } else if (type === 'iso27001') {
                prompt += `TAREA: Compara "${state.aiContext.title}" con controles equivalentes de ISO/IEC 27001:2022. Identifica similitudes, diferencias y cómo integrar ambos estándares.`;
            } else if (type === 'documents') {
                prompt += `TAREA: Lista la documentación requerida y recomendada para cumplir con "${state.aiContext.title}". Incluye políticas, procedimientos, registros y evidencias.`;
            } else if (type === 'custom') {
                prompt += `PREGUNTA DEL USUARIO: "${customText}"

INSTRUCCIONES:
- Responde DIRECTAMENTE a esta pregunta específica
- Si la pregunta es sobre la relación entre conceptos de ISO 42001, explica la relación claramente
- Si el usuario pregunta si algo "se hace en" algún lugar, responde SÍ o NO primero, luego explica
- No repitas información del contexto si no es relevante para la pregunta`;
            }

            try {
                const response = await callGemini(prompt);
                const responseContainer = document.getElementById('ai-response-container');
                responseContainer.innerHTML = `
                    <!-- Pregunta del usuario -->
                    <div class="bg-slate-100 p-4 rounded-xl mb-4 animate-fadeIn">
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 bg-slate-300 rounded-full flex items-center justify-center flex-shrink-0">
                                <i data-lucide="user" class="w-4 h-4 text-slate-600"></i>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 mb-1">Tu consulta:</p>
                                <p class="text-slate-700 text-sm font-medium">${escapeHtml(questionLabel)}</p>
                            </div>
                        </div>
                    </div>
                    <!-- Respuesta de la IA -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-purple-100 animate-fadeIn">
                        <div class="flex items-center gap-2 mb-3 text-purple-600 font-bold text-sm uppercase tracking-wide border-b border-purple-50 pb-2">
                            <i data-lucide="sparkles" class="w-3.5 h-3.5"></i> Respuesta
                        </div>
                        <div class="prose prose-sm prose-slate max-w-none text-slate-700 leading-relaxed">${typeof marked !== 'undefined' ? marked.parse(response) : response}</div>
                    </div>
                `;
                lucide.createIcons();
            } catch (err) {
                console.error('Error en callContextualGemini:', err);
                const responseContainer = document.getElementById('ai-response-container');
                if (responseContainer) {
                    responseContainer.innerHTML = `
                        <div class="bg-red-50 p-4 rounded-xl border border-red-200">
                            <div class="flex items-center gap-2 text-red-600 mb-2">
                                <i data-lucide="alert-circle" class="w-5 h-5"></i>
                                <span class="font-semibold">Error</span>
                            </div>
                            <p class="text-red-700 text-sm">${escapeHtml(err.message)}</p>
                        </div>
                    `;
                    lucide.createIcons();
                }
                showToast('error', err.message);
            }

            // Restaurar botón
            if (sendBtn) {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i data-lucide="send" class="w-5 h-5"></i>';
                sendBtn.classList.remove('opacity-70', 'cursor-wait');
                lucide.createIcons();
            }

            const loadingElEnd = document.getElementById('ai-loading');
            if (loadingElEnd) loadingElEnd.classList.add('hidden');
            if (input) input.value = '';
        }

        async function callGemini(input) {
            // Using gemini-2.5-flash as explicitly requested by user
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${state.apiKey}`;

            // Format input as parts array if it isn't already
            const parts = Array.isArray(input) ? input : [{ text: input }];

            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: parts }] })
            });
            const data = await res.json();
            if (!res.ok) {
                let msg = data.error?.message || 'Error API';
                if (msg.includes('quota') || msg.includes('limit')) msg = '⚠️ Límite de uso excedido (Quota). Por favor, espera unos segundos e intenta de nuevo.';
                if (msg.includes('overloaded')) msg = '⚠️ El modelo está sobrecargado. Intenta de nuevo.';
                throw new Error(msg);
            }
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "Sin respuesta";
        }

        // --- CONFIG & UTILS ---

        function openConfigModal() {
            document.getElementById('config-modal').classList.remove('hidden');
        }

        function closeConfigModal() {
            document.getElementById('config-modal').classList.add('hidden');
        }

        function saveApiKey() {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) {
                localStorage.setItem('iso_gemini_api_key', key);
                state.apiKey = key;
                closeConfigModal();
                showToast('success', 'API Key guardada');
            }
        }

        function showToast(type, msg) {
            const toast = document.getElementById('toast');
            const content = document.getElementById('toast-content');
            toast.classList.remove('hidden');

            content.className = `px-6 py-3 rounded-full shadow-lg text-white text-sm font-medium flex items-center gap-2 ${type === 'success' ? 'bg-green-600' : 'bg-red-500'}`;
            content.innerHTML = `<i data-lucide="${type === 'success' ? 'check-square' : 'alert-triangle'}" class="w-4 h-4"></i> ${msg}`;

            lucide.createIcons();

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // --- NOTEBOOK FUNCTIONS ---

        function toggleAllSources() {
            // If all currently visible are checked, uncheck all. Otherwise check all.
            // Simplified: Just Check All if not all checked, else Uncheck All.
            const allCount = isoData.clauses.length + 4; // 4 annexes
            if (state.notebookSources.length === allCount) {
                state.notebookSources = [];
            } else {
                state.notebookSources = [];
                isoData.clauses.forEach(c => state.notebookSources.push('clause-' + c.id));
                ['A', 'B', 'C', 'D'].forEach(a => state.notebookSources.push('annex-' + a));
            }
            renderMainContent();
        }

        function toggleSource(type, id) {
            const key = type + '-' + id;
            if (state.notebookSources.includes(key)) {
                state.notebookSources = state.notebookSources.filter(k => k !== key);
            } else {
                state.notebookSources.push(key);
            }
            renderMainContent(); // Re-render to update checkboxes and count
        }

        function compareSources() {
            const source1 = document.getElementById('compare-source-1').value;
            const source2 = document.getElementById('compare-source-2').value;

            if (!source1 || !source2) {
                showToast('Selecciona ambas fuentes para comparar', 'error');
                return;
            }

            if (source1 === source2) {
                showToast('Selecciona dos fuentes diferentes', 'error');
                return;
            }

            // Auto-select sources if not already selected
            if (!state.notebookSources.includes(source1)) {
                state.notebookSources.push(source1);
            }
            if (!state.notebookSources.includes(source2)) {
                state.notebookSources.push(source2);
            }

            const [type1, id1] = source1.split('-');
            const [type2, id2] = source2.split('-');

            const name1 = type1 === 'clause' ?
                isoData.clauses.find(c => c.id === id1)?.title :
                `Anexo ${id1}`;
            const name2 = type2 === 'clause' ?
                isoData.clauses.find(c => c.id === id2)?.title :
                `Anexo ${id2}`;

            const question = `Compara "${name1}" con "${name2}". Identifica:\n1. Similitudes en requisitos\n2. Diferencias clave\n3. Cómo se complementan\n4. Recomendaciones para auditoría`;

            notebookAsk(question);
        }

        function saveNotebookNotes(notes) {
            state.notebookResearcherNotes = notes;
            localStorage.setItem('iso_notebook_notes', notes);
            showToast('Notas guardadas', 'success');
        }

        function exportNotebookConversation() {
            if (state.notebookConversation.length === 0) {
                showToast('No hay conversación para exportar', 'error');
                return;
            }

            const content = state.notebookConversation.map(msg => {
                const role = msg.role === 'user' ? 'PREGUNTA' : 'RESPUESTA';
                return `[${role}]\n${msg.text}\n\n${'='.repeat(50)}\n`;
            }).join('\n');

            const header = `CONVERSACIÓN CEREBRO AI - ISO 42001
Fecha: ${new Date().toLocaleString()}
Fuentes utilizadas: ${state.notebookSources.join(', ')}
${'='.repeat(50)}\n\n`;

            const blob = new Blob([header + content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cerebro_conversacion_${new Date().toISOString().split('T')[0]}.md`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('Conversación exportada', 'success');
        }

        function openNotebookConfig() {
            document.getElementById('notebook-config-modal').classList.remove('hidden');
        }

        function closeNotebookConfig() {
            document.getElementById('notebook-config-modal').classList.add('hidden');
        }

        function saveNotebookUrl() {
            const url = document.getElementById('notebook-url-input').value.trim();
            state.notebookUrl = url;
            localStorage.setItem('iso_notebook_url', url);
            state.notebookMode = url ? 'external' : 'internal';
            closeNotebookConfig();
            renderMainContent();
            showToast('success', 'Notebook conectado');
        }

        function toggleNotebookMode() {
            state.notebookMode = state.notebookMode === 'external' ? 'internal' : 'external';
            renderMainContent();
        }

        function notebookAsk(question) {
            const input = document.getElementById('notebook-input');
            input.value = question;
            input.style.height = input.scrollHeight + 'px';
            sendNotebookMessage();
        }

        async function sendNotebookMessage() {
            const input = document.getElementById('notebook-input');
            const text = input.value.trim();
            if (!text) return;

            if (!state.apiKey) {
                showToast('error', 'Falta API Key');
                return;
            }

            if (state.notebookSources.length === 0) {
                showToast('error', 'Selecciona al menos una fuente');
                return;
            }

            // UI Updates
            const container = document.getElementById('notebook-chat-area');
            const msgContainer = document.getElementById('notebook-messages');
            const emptyState = document.getElementById('notebook-empty-state');

            emptyState.classList.add('hidden');
            msgContainer.classList.remove('hidden');

            // User Message
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'flex justify-end animate-slideUp';
            userMsgDiv.innerHTML = `
                <div class="px-5 py-3 bg-blue-600 text-white rounded-2xl rounded-tr-sm max-w-[85%] shadow-md text-sm leading-relaxed">
                    ${text}
                </div>
            `;
            msgContainer.appendChild(userMsgDiv);

            input.value = '';
            input.style.height = '';
            container.scrollTop = container.scrollHeight;

            // Loading
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'notebook-loading';
            loadingDiv.className = 'flex justify-start animate-fadeIn';
            loadingDiv.innerHTML = `
                <div class="flex items-center gap-3 bg-white border border-slate-200 px-4 py-3 rounded-2xl rounded-tl-sm shadow-sm">
                    <div class="loader ease-linear rounded-full border-2 border-t-2 border-purple-500 h-4 w-4"></div>
                    <span class="text-xs font-medium text-slate-500">Analizando fuentes...</span>
                </div>
            `;
            msgContainer.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;

            // Prepare Context
            let contextData = "";

            // Loop through sources and gather text
            // Optimization: In a real app we might not want to dump ALL text. But for a demo with this file size, it's okay.
            state.notebookSources.forEach(source => {
                const [type, id] = source.split('-');
                if (type === 'clause') {
                    const clause = isoData.clauses.find(c => c.id === id);
                    if (clause) {
                        contextData += `Fuente: ${clause.title}\n`;
                        clause.subsections.forEach(sub => {
                            contextData += `${sub.title}:\n`;
                            sub.content.forEach(item => {
                                if (item.type === 'p') contextData += item.text + "\n";
                                if (item.type === 'list') contextData += item.items.join(", ") + "\n";
                            });
                        });
                        contextData += "\n---\n";
                    }
                } else if (type === 'annex') {
                    if (id === 'A') {
                        contextData += "Fuente: Anexo A (Controles)\n";
                        isoData.annexA.forEach(cat => {
                            cat.controls.forEach(ctrl => {
                                contextData += `${ctrl.code} ${ctrl.name}: ${ctrl.desc} (Guía: ${ctrl.guid})\n`;
                            });
                        });
                    }
                    if (id === 'B') {
                        contextData += "Fuente: Anexo B (Guía de Implementación)\n";
                        isoData.annexB.forEach(section => {
                            contextData += `\n${section.section}\n`;
                            contextData += `Objetivo: ${section.objetivo}\n`;
                            section.subsections.forEach(sub => {
                                contextData += `\n${sub.id} - ${sub.title}\n`;
                                contextData += `Control: ${sub.control}\n`;
                                contextData += `Guía: ${sub.guidance}\n`;
                                if (sub.other) contextData += `Nota: ${sub.other}\n`;
                            });
                        });
                        contextData += "\n---\n";
                    }
                    // Add simple placeholder/logic for B, C, D if needed, or expand logic
                    if (id === 'C') {
                        contextData += `Fuente: ${isoData.annexC.title}\n${isoData.annexC.intro}\n`;
                        isoData.annexC.objectives.forEach(o => contextData += `${o.name}: ${o.desc}\n`);
                        isoData.annexC.risks.forEach(r => contextData += `${r.name}: ${r.desc}\n`);
                    }
                    if (id === 'D') {
                        contextData += `Fuente: ${isoData.annexD.title}\n`;
                        isoData.annexD.integration.forEach(i => contextData += `${i.std} (${i.sector}): ${i.desc}\n`);
                    }
                }
            });

            try {
                const prompt = `Actúa como Auditor Líder de Certificación ISO/IEC 42001:2023 (Cerebro AI).

REGLAS CRÍTICAS:
- El Anexo A oficial SOLO tiene controles del A.2 al A.10. NO existen A.11, A.12, A.13 ni A.14. Si se mencionan, indica que no pertenecen a la norma oficial.
- NO prescribas formatos específicos de evidencia. Usa términos genéricos como "evidencia de análisis de sesgos".
- Términos técnicos específicos úsalos SOLO como ejemplos opcionales entre paréntesis, nunca como requisitos.
- La norma es agnóstica de tecnología. Diferencia entre "requisito" (Anexo A) y "guía informativa" (Anexo B).
- CRITERIOS NO MÉTRICAS: Usa "criterios definidos" NO "métricas" o "umbrales técnicos".
- PROPORCIONALIDAD: Añade "según el enfoque de riesgo" para exigencias técnicas.
- NO ASUMAS CRITICIDAD: No todos los sistemas son de alto riesgo.

Usa SOLAMENTE la siguiente información de contexto para responder. Si la respuesta no está en el contexto, indícalo basándote en la estructura real de la norma (Cláusulas 4-10 y Anexo A.2-A.10).

CONTEXTO SELECCIONADO:
${contextData}

PREGUNTA USUARIO: "${text}"`;

                const response = await callGemini(prompt);

                // Guardar en conversación
                state.notebookConversation.push(
                    { role: 'user', text: text, timestamp: new Date().toISOString() },
                    { role: 'assistant', text: response, timestamp: new Date().toISOString() }
                );

                // Mostrar botón de exportar
                const exportBtn = document.getElementById('notebook-export-btn');
                if (exportBtn) exportBtn.classList.remove('hidden');

                loadingDiv.remove();

                // Generar citas de fuentes utilizadas
                const sourceCitations = state.notebookSources.map(source => {
                    const [type, id] = source.split('-');
                    if (type === 'clause') {
                        const clause = isoData.clauses.find(c => c.id === id);
                        return clause ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-700 mr-1">${clause.title}</span>` : '';
                    } else {
                        return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-emerald-100 text-emerald-700 mr-1">Anexo ${id}</span>`;
                    }
                }).join('');

                // Bot Response con citas
                const botMsgDiv = document.createElement('div');
                botMsgDiv.className = 'flex justify-start animate-fadeIn';

                const parsedResponse = typeof marked !== 'undefined' ? marked.parse(response) : response.replace(/\\n/g, '<br>');

                botMsgDiv.innerHTML = `
                    <div class="flex gap-3 max-w-[90%]">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-600 to-indigo-600 flex items-center justify-center shrink-0 text-white shadow-sm">
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                        </div>
                        <div class="flex-1">
                            <div class="prose prose-sm prose-slate bg-white border border-slate-200 p-4 rounded-2xl rounded-tl-sm shadow-sm">
                                ${parsedResponse}
                            </div>
                            <div class="mt-2 flex items-center gap-2">
                                <span class="text-[10px] text-slate-400">Fuentes consultadas:</span>
                                <div class="flex flex-wrap gap-1">${sourceCitations}</div>
                            </div>
                        </div>
                    </div>
                `;

                if (typeof marked === 'undefined') {
                    const formattedResponse = response
                        .replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>')
                        .replace(/\\n/g, '<br>');

                    botMsgDiv.innerHTML = `
                        <div class="flex gap-3 max-w-[90%]">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-600 to-indigo-600 flex items-center justify-center shrink-0 text-white shadow-sm">
                                <i data-lucide="sparkles" class="w-4 h-4"></i>
                            </div>
                            <div class="flex-1">
                                <div class="p-4 bg-white border border-slate-200 rounded-2xl rounded-tl-sm shadow-sm text-sm text-slate-700 leading-relaxed whitespace-pre-line">
                                    ${formattedResponse}
                                </div>
                                <div class="mt-2 flex items-center gap-2">
                                    <span class="text-[10px] text-slate-400">Fuentes consultadas:</span>
                                    <div class="flex flex-wrap gap-1">${sourceCitations}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                msgContainer.appendChild(botMsgDiv);
                container.scrollTop = container.scrollHeight;
                lucide.createIcons();

            } catch (err) {
                loadingDiv.remove();
                showToast(err.message, 'error');
            }
        }

        // ==================== DASHBOARD PRINCIPAL (COMPOSICIÓN DE LA NORMA) ====================
        function renderDashboard(container) {
            const totalClauses = isoData.clauses.length;
            const totalSubsections = isoData.clauses.reduce((acc, c) => acc + c.subsections.length, 0);
            const totalControls = isoData.annexA.reduce((acc, cat) => acc + cat.controls.length, 0);
            const totalCategories = isoData.annexA.length;

            container.innerHTML = `
                <div class="animate-fadeIn space-y-8 pb-24">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl p-8 text-white shadow-xl">
                        <h2 class="text-3xl font-bold mb-2">Composición de la Norma ISO 42001</h2>
                        <p class="text-slate-300">Estructura interactiva del Sistema de Gestión de Inteligencia Artificial</p>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200 text-center">
                            <div class="text-4xl font-bold text-blue-600 mb-2">${totalClauses}</div>
                            <div class="text-sm text-slate-500">Cláusulas</div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200 text-center">
                            <div class="text-4xl font-bold text-emerald-600 mb-2">${totalSubsections}</div>
                            <div class="text-sm text-slate-500">Subsecciones</div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200 text-center">
                            <div class="text-4xl font-bold text-purple-600 mb-2">${totalCategories}</div>
                            <div class="text-sm text-slate-500">Categorías Anexo A</div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200 text-center">
                            <div class="text-4xl font-bold text-amber-600 mb-2">${totalControls}</div>
                            <div class="text-sm text-slate-500">Controles</div>
                        </div>
                    </div>
                    
                    <!-- Visual Structure Diagram -->
                    <div class="bg-white rounded-xl p-8 shadow-sm border border-slate-200">
                        <h3 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                            <i data-lucide="git-branch" class="w-6 h-6 text-blue-600"></i>
                            Estructura de la Norma (HLS)
                        </h3>
                        
                        <div class="flex flex-col items-center gap-4">
                            <!-- Top: Context -->
                            <div onclick="navigateTo('clauses', '4')" class="clause-card cursor-pointer bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl p-6 w-full max-w-md text-center shadow-lg">
                                <i data-lucide="book-open" class="w-8 h-8 mx-auto mb-2"></i>
                                <h4 class="font-bold text-lg">Cláusulas 4-10</h4>
                                <p class="text-sm text-blue-100">Cuerpo Normativo - Requisitos obligatorios</p>
                            </div>
                            
                            <div class="w-px h-8 bg-slate-300"></div>
                            
                            <!-- Middle Row: Supporting elements -->
                            <div class="grid grid-cols-3 gap-4 w-full max-w-3xl">
                                <div onclick="navigateTo('annexes')" class="clause-card cursor-pointer bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl p-4 text-center shadow-lg">
                                    <i data-lucide="shield-check" class="w-6 h-6 mx-auto mb-2"></i>
                                    <h4 class="font-bold">Anexo A</h4>
                                    <p class="text-xs text-purple-100">Controles de referencia</p>
                                </div>
                                <div onclick="navigateTo('annexes')" class="clause-card cursor-pointer bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-xl p-4 text-center shadow-lg">
                                    <i data-lucide="help-circle" class="w-6 h-6 mx-auto mb-2"></i>
                                    <h4 class="font-bold">Anexo B</h4>
                                    <p class="text-xs text-emerald-100">Guía de implementación</p>
                                </div>
                                <div onclick="navigateTo('annexes')" class="clause-card cursor-pointer bg-gradient-to-r from-amber-500 to-amber-600 text-white rounded-xl p-4 text-center shadow-lg">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 mx-auto mb-2"></i>
                                    <h4 class="font-bold">Anexo C</h4>
                                    <p class="text-xs text-amber-100">Objetivos y riesgos</p>
                                </div>
                            </div>
                            
                            <div class="w-px h-8 bg-slate-300"></div>
                            
                            <!-- Bottom: Integration -->
                            <div onclick="navigateTo('annexes')" class="clause-card cursor-pointer bg-gradient-to-r from-teal-500 to-teal-600 text-white rounded-xl p-4 w-full max-w-sm text-center shadow-lg">
                                <i data-lucide="link" class="w-6 h-6 mx-auto mb-2"></i>
                                <h4 class="font-bold">Anexo D</h4>
                                <p class="text-xs text-teal-100">Integración con otros estándares</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== DASHBOARD DE CLÁUSULAS ====================
        function renderClausesDashboard(container) {
            container.innerHTML = `
                <div class="animate-fadeIn space-y-8 pb-24">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-8 text-white shadow-xl">
                        <h2 class="text-3xl font-bold mb-2">Dashboard de Cláusulas</h2>
                        <p class="text-blue-100">Estructura del Cuerpo Normativo ISO 42001 (Cláusulas 4-10)</p>
                    </div>
                    
                    <!-- Clause Cards Grid -->
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${isoData.clauses.map(clause => `
                            <div onclick="navigateTo('clauses', '${clause.id}')" class="clause-card cursor-pointer bg-white rounded-xl p-6 shadow-sm border border-slate-200 hover:border-blue-400">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="p-3 bg-blue-100 rounded-xl">
                                        <i data-lucide="${clause.icon}" class="w-6 h-6 text-blue-600"></i>
                                    </div>
                                    <span class="text-2xl font-bold text-blue-600">${clause.id}</span>
                                </div>
                                <h3 class="font-bold text-slate-800 mb-2">${clause.title.replace(/\d+\.\s*/, '')}</h3>
                                <p class="text-sm text-slate-500 mb-4">${clause.description}</p>
                                <div class="flex items-center justify-between pt-4 border-t border-slate-100">
                                    <span class="text-xs text-slate-500">${clause.subsections.length} subsecciones</span>
                                    <span class="text-blue-600 text-sm font-medium">Explorar →</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ==================== DASHBOARD DEL ANEXO A ====================
        function renderAnnexADashboard(container) {
            const totalControls = isoData.annexA.reduce((acc, cat) => acc + cat.controls.length, 0);

            container.innerHTML = `
                <div class="animate-fadeIn space-y-8 pb-24">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-700 rounded-2xl p-8 text-white shadow-xl">
                        <h2 class="text-3xl font-bold mb-2">Dashboard del Anexo A</h2>
                        <p class="text-purple-100">Controles de Referencia - ${totalControls} controles en ${isoData.annexA.length} categorías</p>
                    </div>
                    
                    <!-- Categories Overview -->
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${isoData.annexA.map((cat, idx) => `
                            <div class="bg-white rounded-xl p-6 shadow-sm border-2 border-slate-200" onclick="navigateTo('annexes')">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="p-3 bg-purple-100 rounded-xl">
                                        <i data-lucide="${cat.icon}" class="w-6 h-6 text-purple-600"></i>
                                    </div>
                                    <span class="text-2xl font-bold text-purple-600">${cat.controls.length}</span>
                                </div>
                                <h3 class="font-bold text-slate-800 mb-2 text-sm">${cat.category}</h3>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ==================== THEME & UTILITIES ====================

        function toggleTheme() {
            state.darkMode = !state.darkMode;
            localStorage.setItem('darkMode', state.darkMode);
            applyTheme();
        }

        function applyTheme() {
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            const topThemeIcon = document.getElementById('top-theme-icon');

            if (state.darkMode) {
                document.documentElement.classList.add('dark');
                if (themeIcon) themeIcon.setAttribute('data-lucide', 'sun');
                if (themeText) themeText.textContent = 'Modo Claro';
                if (topThemeIcon) topThemeIcon.setAttribute('data-lucide', 'sun');
            } else {
                document.documentElement.classList.remove('dark');
                if (themeIcon) themeIcon.setAttribute('data-lucide', 'moon');
                if (themeText) themeText.textContent = 'Modo Oscuro';
                if (topThemeIcon) topThemeIcon.setAttribute('data-lucide', 'moon');
            }
            lucide.createIcons();
        }

        function updateApiKeyStatus() {
            // Sidebar elements (mobile)
            const icon = document.getElementById('api-key-icon');
            const text = document.getElementById('api-key-text');
            const btnText = document.getElementById('api-key-btn-text');

            // Top bar elements (desktop)
            const topIcon = document.getElementById('top-api-icon');
            const topText = document.getElementById('top-api-text');
            const topStatus = document.getElementById('top-api-status');

            if (state.apiKey) {
                // Sidebar
                if (icon) icon.className = 'w-4 h-4 text-green-400';
                if (text) {
                    text.className = 'text-xs text-green-400';
                    text.textContent = 'API Key configurada';
                }
                if (btnText) btnText.textContent = 'Cambiar API Key';

                // Top bar
                if (topIcon) topIcon.className = 'w-4 h-4 text-green-500';
                if (topText) {
                    topText.textContent = 'API Key OK';
                    topText.className = 'text-xs text-green-600 font-medium';
                }
                if (topStatus) {
                    topStatus.className = 'flex items-center gap-2 px-3 py-1.5 rounded-lg bg-green-50 border border-green-200';
                }
            } else {
                // Sidebar
                if (icon) icon.className = 'w-4 h-4 text-amber-400';
                if (text) {
                    text.className = 'text-xs text-amber-400';
                    text.textContent = 'API Key no configurada';
                }
                if (btnText) btnText.textContent = 'Configurar API Key';

                // Top bar
                if (topIcon) topIcon.className = 'w-4 h-4 text-amber-500';
                if (topText) {
                    topText.textContent = 'Sin API Key';
                    topText.className = 'text-xs text-slate-600';
                }
                if (topStatus) {
                    topStatus.className = 'flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-50 border border-slate-200';
                }
            }
        }

        function exportData() {
            const data = {
                notes: state.notes,
                apiKey: state.apiKey,
                notebookUrl: state.notebookUrl,
                messages: state.messages,
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `iso42001_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Datos exportados correctamente', 'success');
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.notes) state.notes = data.notes;
                    if (data.apiKey) {
                        state.apiKey = data.apiKey;
                        localStorage.setItem('iso_gemini_api_key', data.apiKey);
                    }
                    if (data.notebookUrl) {
                        state.notebookUrl = data.notebookUrl;
                        localStorage.setItem('iso_notebook_url', data.notebookUrl);
                    }
                    if (data.messages) state.messages = data.messages;

                    updateApiKeyStatus();
                    renderSidebar();
                    showToast('Datos importados correctamente', 'success');
                } catch (err) {
                    showToast('Error al importar: archivo inválido', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';

            // Also clear the other file input
            const otherInput = document.getElementById('top-import-file');
            if (otherInput) otherInput.value = '';
        }

        // Wrapper for top bar import
        function importData() {
            const topInput = document.getElementById('top-import-file');
            if (topInput) {
                topInput.click();
            }
        }

        // ==================== MAPA DE CALOR DE RIESGOS ====================

        function createRiskHeatmap() {
            if (!state.auditReport) return;

            // Extraer datos de la matriz de riesgos del informe
            const riskData = extractRiskMatrixData();

            // Crear visualizacion del mapa de calor
            const container = document.getElementById('risk-heatmap-container');
            if (!container) return;

            // Contar riesgos por nivel
            const counts = { critico: 0, alto: 0, medio: 0, bajo: 0 };
            riskData.forEach(r => {
                const level = (r.nivel || '').toLowerCase();
                if (level.includes('critico')) counts.critico++;
                else if (level.includes('alto')) counts.alto++;
                else if (level.includes('medio')) counts.medio++;
                else if (level.includes('bajo')) counts.bajo++;
            });

            // HTML del mapa de calor
            container.innerHTML = `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                    <h4 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="grid-3x3" class="w-5 h-5 text-red-600"></i>
                        Mapa de Calor de Riesgos
                    </h4>
                    
                    <!-- Resumen de riesgos -->
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-red-50 border-2 border-red-300 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-red-700">${counts.critico}</div>
                            <div class="text-sm text-red-600 font-medium">Críticos</div>
                        </div>
                        <div class="bg-orange-50 border-2 border-orange-300 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-orange-700">${counts.alto}</div>
                            <div class="text-sm text-orange-600 font-medium">Altos</div>
                        </div>
                        <div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-yellow-700">${counts.medio}</div>
                            <div class="text-sm text-yellow-600 font-medium">Medios</div>
                        </div>
                        <div class="bg-blue-50 border-2 border-blue-300 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-blue-700">${counts.bajo}</div>
                            <div class="text-sm text-blue-600 font-medium">Bajos</div>
                        </div>
                    </div>
                    
                    <!-- Tabla de riesgos -->
                    ${riskData.length > 0 ? `
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-3 py-2 text-left font-semibold text-slate-600">Control</th>
                                    <th class="px-3 py-2 text-left font-semibold text-slate-600">Riesgo Identificado</th>
                                    <th class="px-3 py-2 text-center font-semibold text-slate-600">Nivel</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${riskData.slice(0, 10).map(r => {
                let badgeClass = 'bg-gray-100 text-gray-700';
                if (r.nivel.toLowerCase().includes('critico')) badgeClass = 'bg-red-100 text-red-700 border border-red-300';
                else if (r.nivel.toLowerCase().includes('alto')) badgeClass = 'bg-orange-100 text-orange-700 border border-orange-300';
                else if (r.nivel.toLowerCase().includes('medio')) badgeClass = 'bg-yellow-100 text-yellow-700 border border-yellow-300';
                else if (r.nivel.toLowerCase().includes('bajo')) badgeClass = 'bg-blue-100 text-blue-700 border border-blue-300';

                return `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-3 py-2 font-mono text-xs text-slate-700">${r.control}</td>
                                            <td class="px-3 py-2 text-slate-700">${r.riesgo}</td>
                                            <td class="px-3 py-2 text-center">
                                                <span class="px-2 py-1 rounded-full text-xs font-bold ${badgeClass}">${r.nivel}</span>
                                            </td>
                                        </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                        ${riskData.length > 10 ? `<p class="text-xs text-slate-500 mt-2 text-center">... y ${riskData.length - 10} riesgos más</p>` : ''}
                    </div>
                    ` : '<p class="text-slate-500 text-center py-4">No se detectaron riesgos en el análisis</p>'}
                </div>
            `;

            lucide.createIcons();
        }

        function extractRiskMatrixData() {
            const report = state.auditReport || '';
            const risks = [];

            // Buscar la seccion de matriz de riesgos
            const matrixMatch = report.match(/## 2\.\s*MATRIZ DE RIESGOS[\s\S]*?(?=## 3\.|$)/i);
            if (matrixMatch) {
                const matrixSection = matrixMatch[0];

                // Extraer filas de la tabla (formato: | control | riesgo | prob | impacto | nivel | ... |)
                const rows = matrixSection.match(/\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|/g);

                if (rows) {
                    rows.forEach(row => {
                        const cells = row.split('|').map(c => c.trim()).filter(c => c);
                        if (cells.length >= 5 && !cells[0].includes('Control') && !cells[0].includes('---')) {
                            risks.push({
                                control: cells[0],
                                riesgo: cells[1],
                                probabilidad: cells[2],
                                impacto: cells[3],
                                nivel: cells[4].replace(/\*\*/g, '')
                            });
                        }
                    });
                }
            }

            return risks;
        }

        // --- INITIALIZATION ---
        init();

    </script>
</body>

</html>